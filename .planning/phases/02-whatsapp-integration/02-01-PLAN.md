---
phase: 02-whatsapp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/whatsapp.ts
  - src/db/schema/index.ts
  - src/services/whatsapp/client.ts
  - src/services/whatsapp/messages.ts
  - src/services/whatsapp/index.ts
autonomous: true
user_setup:
  - service: meta
    why: "WhatsApp Business API access"
    env_vars:
      - name: META_APP_ID
        source: "Meta Developer Console -> App Dashboard -> Settings -> Basic"
      - name: META_APP_SECRET
        source: "Meta Developer Console -> App Dashboard -> Settings -> Basic"
      - name: WHATSAPP_WEBHOOK_VERIFY_TOKEN
        source: "Generate a random string (e.g., node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\")"
      - name: META_CONFIG_ID
        source: "Meta Developer Console -> Facebook Login for Business -> Configuration ID"
    dashboard_config:
      - task: "Create Meta App with WhatsApp Business API"
        location: "developers.facebook.com -> My Apps -> Create App"
      - task: "Enable Facebook Login for Business"
        location: "App Dashboard -> Add Products -> Facebook Login for Business"
      - task: "Configure Embedded Signup"
        location: "App Dashboard -> Facebook Login for Business -> Settings -> Embedded Signup"

must_haves:
  truths:
    - "WhatsApp connection data can be stored per tenant"
    - "WhatsApp messages can be tracked with delivery status"
    - "Conversation 24-hour windows can be tracked"
    - "System can construct Graph API requests with proper authentication"
    - "System can send template messages via Graph API"
    - "System can send freeform text messages within 24-hour window"
  artifacts:
    - path: "src/db/schema/whatsapp.ts"
      provides: "WhatsApp database tables"
      contains: "whatsappConnections"
    - path: "src/services/whatsapp/client.ts"
      provides: "Graph API client wrapper"
      exports: ["WhatsAppClient", "createWhatsAppClient"]
    - path: "src/services/whatsapp/messages.ts"
      provides: "Message sending functions"
      exports: ["sendTemplateMessage", "sendTextMessage"]
  key_links:
    - from: "src/services/whatsapp/messages.ts"
      to: "Graph API"
      via: "fetch to graph.facebook.com"
      pattern: "graph\\.facebook\\.com.*messages"
    - from: "src/services/whatsapp/client.ts"
      to: "Token Vault"
      via: "tokenVaultService.getToken"
      pattern: "tokenVaultService"
---

<objective>
Create WhatsApp database schema for connection tracking, message history, and conversation windows, plus the WhatsApp Graph API client service for sending messages.

Purpose: Establish the data layer and API client needed by all subsequent WhatsApp plans. This is the foundation for storing credentials and tracking message lifecycle.

Output: Database schema with migrations, WhatsApp client service with message sending capabilities.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\דודאלמועלם\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-whatsapp-integration/02-CONTEXT.md
@.planning/phases/02-whatsapp-integration/02-RESEARCH.md

# Existing infrastructure
@src/db/schema/tenants.ts
@src/db/schema/token-vault.ts
@src/services/token-vault.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WhatsApp database schema</name>
  <files>
    src/db/schema/whatsapp.ts
    src/db/schema/index.ts
  </files>
  <action>
Create WhatsApp database schema with three tables:

1. **whatsapp_connections** - Links tenant to WhatsApp Business Account:
   - id: UUID primary key
   - tenantId: UUID foreign key to tenants (unique - one connection per tenant)
   - wabaId: VARCHAR(50) - WhatsApp Business Account ID from Embedded Signup
   - phoneNumberId: VARCHAR(50) - Phone Number ID for API calls
   - displayPhoneNumber: VARCHAR(20) - Human-readable phone number
   - businessName: VARCHAR(255) - Business name from Meta
   - status: ENUM('pending', 'active', 'disconnected', 'invalid') - Connection health
   - verifiedAt: TIMESTAMP - When connection was verified working
   - createdAt, updatedAt: TIMESTAMP

2. **whatsapp_messages** - Tracks all messages sent/received:
   - id: UUID primary key
   - tenantId: UUID foreign key
   - conversationId: UUID foreign key to whatsapp_conversations
   - waMessageId: VARCHAR(100) - WhatsApp's message ID (for status updates)
   - direction: ENUM('inbound', 'outbound')
   - type: ENUM('text', 'image', 'template', 'unknown')
   - content: TEXT - Message text content (NULL for media)
   - mediaId: VARCHAR(255) - WhatsApp media ID (for images)
   - templateName: VARCHAR(100) - Template name if template message
   - recipientPhone: VARCHAR(20) - Recipient phone number
   - senderPhone: VARCHAR(20) - Sender phone number
   - status: ENUM('pending', 'sent', 'delivered', 'read', 'failed')
   - errorCode: VARCHAR(20) - Error code if failed
   - sentAt, deliveredAt, readAt: TIMESTAMP
   - createdAt: TIMESTAMP
   - Index on waMessageId for status update lookups
   - Index on (tenantId, recipientPhone) for conversation queries

3. **whatsapp_conversations** - Tracks 24-hour customer service windows:
   - id: UUID primary key
   - tenantId: UUID foreign key
   - customerPhone: VARCHAR(20) - Customer's phone number
   - customerName: VARCHAR(255) - Name from WhatsApp profile (nullable)
   - windowOpenedAt: TIMESTAMP - When customer last sent message (window starts)
   - windowExpiresAt: TIMESTAMP - 24 hours after windowOpenedAt
   - lastMessageAt: TIMESTAMP - Last message in conversation
   - messageCount: INTEGER - Total messages in conversation
   - createdAt, updatedAt: TIMESTAMP
   - Unique constraint on (tenantId, customerPhone)
   - Index on windowExpiresAt for expiry queries

Export all tables from src/db/schema/index.ts.

Run `pnpm db:generate` to create migration after schema creation.
  </action>
  <verify>
    - File exists: src/db/schema/whatsapp.ts
    - Exports visible in src/db/schema/index.ts
    - `pnpm db:generate` succeeds
    - Migration file created in drizzle/ folder
  </verify>
  <done>
    Three WhatsApp tables defined with proper foreign keys, enums, and indexes. Migration generated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsApp Graph API client</name>
  <files>
    src/services/whatsapp/client.ts
    src/services/whatsapp/index.ts
  </files>
  <action>
Create WhatsApp Graph API client wrapper:

**src/services/whatsapp/client.ts:**

```typescript
interface WhatsAppClientConfig {
  phoneNumberId: string;
  accessToken: string;
  apiVersion?: string; // Default: 'v21.0'
}

export class WhatsAppClient {
  private baseUrl: string;
  private accessToken: string;
  private phoneNumberId: string;

  constructor(config: WhatsAppClientConfig) {
    const version = config.apiVersion || 'v21.0';
    this.baseUrl = `https://graph.facebook.com/${version}`;
    this.accessToken = config.accessToken;
    this.phoneNumberId = config.phoneNumberId;
  }

  // Generic request method with error handling
  async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const url = `${this.baseUrl}${endpoint}`;
    const response = await fetch(url, {
      ...options,
      headers: {
        'Authorization': `Bearer ${this.accessToken}`,
        'Content-Type': 'application/json',
        ...options.headers,
      },
    });

    if (!response.ok) {
      const error = await response.json();
      throw new WhatsAppAPIError(
        error.error?.message || 'Unknown API error',
        error.error?.code,
        response.status
      );
    }

    return response.json();
  }

  // Get messages endpoint for this phone number
  get messagesEndpoint(): string {
    return `/${this.phoneNumberId}/messages`;
  }
}

export class WhatsAppAPIError extends Error {
  constructor(
    message: string,
    public code?: number,
    public httpStatus?: number
  ) {
    super(message);
    this.name = 'WhatsAppAPIError';
  }
}
```

Add factory function to create client from Token Vault:

```typescript
export async function createWhatsAppClient(
  tenantId: string
): Promise<WhatsAppClient | null> {
  // Get access token from Token Vault
  const tokenResult = await tokenVaultService.getAccessToken(
    tenantId,
    'whatsapp'
  );

  if (!tokenResult) {
    return null;
  }

  // Get phone number ID (stored as api_key type)
  const phoneNumberToken = await tokenVaultService.getToken(
    tenantId,
    'whatsapp',
    'api_key'
  );

  if (!phoneNumberToken) {
    return null;
  }

  return new WhatsAppClient({
    phoneNumberId: phoneNumberToken.value,
    accessToken: tokenResult.token.value,
  });
}
```

Create barrel export in src/services/whatsapp/index.ts.
  </action>
  <verify>
    - File exists: src/services/whatsapp/client.ts
    - WhatsAppClient class exports correctly
    - createWhatsAppClient function imports tokenVaultService
    - TypeScript compiles without errors: `pnpm tsc --noEmit`
  </verify>
  <done>
    WhatsAppClient class with Graph API request method and factory function for creating clients from Token Vault credentials.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create message sending functions</name>
  <files>
    src/services/whatsapp/messages.ts
    src/services/whatsapp/index.ts
  </files>
  <action>
Create message sending functions following RESEARCH.md patterns:

**src/services/whatsapp/messages.ts:**

```typescript
import { WhatsAppClient } from './client';

// Response type from WhatsApp messages API
interface SendMessageResponse {
  messaging_product: 'whatsapp';
  contacts: Array<{ input: string; wa_id: string }>;
  messages: Array<{ id: string }>;
}

// Template component for dynamic content
interface TemplateComponent {
  type: 'header' | 'body' | 'button';
  parameters: Array<{
    type: 'text' | 'image' | 'document';
    text?: string;
    image?: { link: string };
  }>;
}

/**
 * Send a template message (required to initiate conversations).
 * Templates must be pre-approved in Meta Business Suite.
 */
export async function sendTemplateMessage(
  client: WhatsAppClient,
  to: string, // Phone number in international format (972XXXXXXXXX)
  templateName: string,
  languageCode: string = 'he', // Hebrew default
  components?: TemplateComponent[]
): Promise<{ messageId: string; waId: string }> {
  const payload = {
    messaging_product: 'whatsapp',
    recipient_type: 'individual',
    to,
    type: 'template',
    template: {
      name: templateName,
      language: { code: languageCode },
      ...(components && { components }),
    },
  };

  const response = await client.request<SendMessageResponse>(
    client.messagesEndpoint,
    {
      method: 'POST',
      body: JSON.stringify(payload),
    }
  );

  return {
    messageId: response.messages[0].id,
    waId: response.contacts[0].wa_id,
  };
}

/**
 * Send a freeform text message (only within 24-hour customer service window).
 * Use this after customer has sent a message within the last 24 hours.
 */
export async function sendTextMessage(
  client: WhatsAppClient,
  to: string,
  text: string,
  previewUrl: boolean = false
): Promise<{ messageId: string; waId: string }> {
  const payload = {
    messaging_product: 'whatsapp',
    recipient_type: 'individual',
    to,
    type: 'text',
    text: {
      body: text,
      preview_url: previewUrl,
    },
  };

  const response = await client.request<SendMessageResponse>(
    client.messagesEndpoint,
    {
      method: 'POST',
      body: JSON.stringify(payload),
    }
  );

  return {
    messageId: response.messages[0].id,
    waId: response.contacts[0].wa_id,
  };
}

/**
 * Send an image message (only within 24-hour window).
 * Image can be URL or media ID from previous upload.
 */
export async function sendImageMessage(
  client: WhatsAppClient,
  to: string,
  imageUrl: string,
  caption?: string
): Promise<{ messageId: string; waId: string }> {
  const payload = {
    messaging_product: 'whatsapp',
    recipient_type: 'individual',
    to,
    type: 'image',
    image: {
      link: imageUrl,
      ...(caption && { caption }),
    },
  };

  const response = await client.request<SendMessageResponse>(
    client.messagesEndpoint,
    {
      method: 'POST',
      body: JSON.stringify(payload),
    }
  );

  return {
    messageId: response.messages[0].id,
    waId: response.contacts[0].wa_id,
  };
}

/**
 * Check if a conversation window is open (within 24 hours of customer message).
 */
export function isWindowOpen(windowExpiresAt: Date | null): boolean {
  if (!windowExpiresAt) return false;
  return new Date() < windowExpiresAt;
}
```

Update barrel export to include message functions.
  </action>
  <verify>
    - File exists: src/services/whatsapp/messages.ts
    - sendTemplateMessage, sendTextMessage, sendImageMessage exported
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Import test: Create a test file that imports and verify no errors
  </verify>
  <done>
    Message sending functions for templates, text, and images. All follow Graph API v21.0 format with proper typing.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema verification:**
   - Run `pnpm db:generate` - should create migration
   - Run `pnpm db:migrate` - should apply migration successfully
   - Check database has whatsapp_connections, whatsapp_messages, whatsapp_conversations tables

2. **TypeScript verification:**
   - `pnpm tsc --noEmit` passes with no errors
   - All exports visible from src/services/whatsapp/index.ts

3. **Import verification:**
   ```typescript
   import { whatsappConnections, whatsappMessages, whatsappConversations } from '@/db/schema';
   import { WhatsAppClient, createWhatsAppClient, sendTemplateMessage, sendTextMessage } from '@/services/whatsapp';
   ```
</verification>

<success_criteria>
- Three WhatsApp database tables exist with proper relations and indexes
- Migration file generated and applied successfully
- WhatsAppClient class provides authenticated Graph API access
- createWhatsAppClient retrieves credentials from Token Vault
- sendTemplateMessage can construct valid template message payloads
- sendTextMessage can construct valid freeform message payloads
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-whatsapp-integration/02-01-SUMMARY.md`
</output>
