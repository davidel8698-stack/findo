---
phase: 02-whatsapp-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/routes/whatsapp/callback.ts
  - src/routes/whatsapp/index.ts
  - src/services/whatsapp/embedded-signup.ts
  - src/services/whatsapp/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Backend can exchange auth code for access token"
    - "WABA ID and Phone Number ID are stored in database"
    - "Access token is stored encrypted in Token Vault"
    - "Phone Number ID is stored in Token Vault for API calls"
    - "Connection status is tracked as active after successful signup"
  artifacts:
    - path: "src/routes/whatsapp/callback.ts"
      provides: "Embedded Signup callback endpoint"
      exports: ["whatsappCallbackRoutes"]
    - path: "src/services/whatsapp/embedded-signup.ts"
      provides: "Token exchange and storage logic"
      exports: ["processEmbeddedSignup"]
  key_links:
    - from: "src/routes/whatsapp/callback.ts"
      to: "src/services/whatsapp/embedded-signup.ts"
      via: "processEmbeddedSignup function call"
      pattern: "processEmbeddedSignup"
    - from: "src/services/whatsapp/embedded-signup.ts"
      to: "Token Vault"
      via: "tokenVaultService.storeToken"
      pattern: "tokenVaultService\\.storeToken"
    - from: "src/services/whatsapp/embedded-signup.ts"
      to: "Graph API"
      via: "fetch for token exchange"
      pattern: "graph\\.facebook\\.com.*oauth/access_token"
---

<objective>
Implement the Embedded Signup callback endpoint that receives the authorization code from Meta's popup, exchanges it for an access token, and stores all credentials securely.

Purpose: Enable the "Connect WhatsApp" one-click flow. When user completes Meta Embedded Signup popup, this endpoint receives the code and finalizes the connection by storing credentials in Token Vault and connection details in database.

Output: POST /api/whatsapp/callback endpoint and token exchange service.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\דודאלמועלם\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-whatsapp-integration/02-CONTEXT.md
@.planning/phases/02-whatsapp-integration/02-RESEARCH.md

# From 02-01
@src/db/schema/whatsapp.ts
@src/services/whatsapp/client.ts
@src/services/token-vault.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Embedded Signup service</name>
  <files>
    src/services/whatsapp/embedded-signup.ts
    src/services/whatsapp/index.ts
  </files>
  <action>
Create the Embedded Signup processing service:

**src/services/whatsapp/embedded-signup.ts:**

```typescript
import { db } from '../../db/index';
import { whatsappConnections } from '../../db/schema/index';
import { tokenVaultService } from '../token-vault';
import { eq } from 'drizzle-orm';

interface EmbeddedSignupData {
  code: string;           // OAuth authorization code from FB.login
  wabaId: string;         // WhatsApp Business Account ID from sessionInfo
  phoneNumberId: string;  // Phone Number ID from sessionInfo
  displayPhoneNumber?: string; // Human-readable phone (optional)
  businessName?: string;  // Business name from Meta (optional)
}

interface EmbeddedSignupResult {
  success: boolean;
  connectionId?: string;
  error?: string;
  errorDetails?: unknown;
}

/**
 * Exchange auth code for access token with Meta Graph API.
 */
async function exchangeCodeForToken(code: string): Promise<string> {
  const appId = process.env.META_APP_ID;
  const appSecret = process.env.META_APP_SECRET;

  if (!appId || !appSecret) {
    throw new Error('META_APP_ID and META_APP_SECRET must be configured');
  }

  const url = new URL('https://graph.facebook.com/v21.0/oauth/access_token');
  url.searchParams.set('client_id', appId);
  url.searchParams.set('client_secret', appSecret);
  url.searchParams.set('code', code);

  const response = await fetch(url.toString());

  if (!response.ok) {
    const error = await response.json();
    throw new Error(`Token exchange failed: ${error.error?.message || 'Unknown error'}`);
  }

  const data = await response.json();
  return data.access_token;
}

/**
 * Process Embedded Signup completion.
 *
 * 1. Exchange auth code for access token
 * 2. Store access token in Token Vault (encrypted)
 * 3. Store Phone Number ID in Token Vault (for API calls)
 * 4. Create or update whatsapp_connections record
 */
export async function processEmbeddedSignup(
  tenantId: string,
  data: EmbeddedSignupData
): Promise<EmbeddedSignupResult> {
  try {
    // Step 1: Exchange code for access token
    const accessToken = await exchangeCodeForToken(data.code);

    // Step 2: Store access token in Token Vault
    // Using wabaId as identifier to support future multi-WABA scenarios
    await tokenVaultService.storeToken(
      tenantId,
      'whatsapp',
      'access_token',
      {
        value: accessToken,
        identifier: data.wabaId,
        // Embedded Signup tokens are short-lived initially
        // Consider: Exchange for long-lived token or guide to System User token
        // For now, store without expiry (will handle refresh separately)
      }
    );

    // Step 3: Store Phone Number ID (needed for API calls)
    await tokenVaultService.storeToken(
      tenantId,
      'whatsapp',
      'api_key', // Using api_key type for Phone Number ID
      {
        value: data.phoneNumberId,
        identifier: data.wabaId,
      }
    );

    // Step 4: Create or update connection record
    const existing = await db.query.whatsappConnections.findFirst({
      where: eq(whatsappConnections.tenantId, tenantId),
    });

    let connectionId: string;

    if (existing) {
      // Update existing connection (reconnection scenario)
      await db
        .update(whatsappConnections)
        .set({
          wabaId: data.wabaId,
          phoneNumberId: data.phoneNumberId,
          displayPhoneNumber: data.displayPhoneNumber,
          businessName: data.businessName,
          status: 'active',
          verifiedAt: new Date(),
          updatedAt: new Date(),
        })
        .where(eq(whatsappConnections.id, existing.id));
      connectionId = existing.id;
    } else {
      // Create new connection
      const [inserted] = await db
        .insert(whatsappConnections)
        .values({
          tenantId,
          wabaId: data.wabaId,
          phoneNumberId: data.phoneNumberId,
          displayPhoneNumber: data.displayPhoneNumber,
          businessName: data.businessName,
          status: 'active',
          verifiedAt: new Date(),
        })
        .returning({ id: whatsappConnections.id });
      connectionId = inserted.id;
    }

    console.log(`[whatsapp] Embedded Signup completed for tenant ${tenantId}, connection ${connectionId}`);

    return {
      success: true,
      connectionId,
    };
  } catch (error) {
    console.error('[whatsapp] Embedded Signup failed:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
      errorDetails: error,
    };
  }
}

/**
 * Get connection status for a tenant.
 */
export async function getConnectionStatus(tenantId: string) {
  const connection = await db.query.whatsappConnections.findFirst({
    where: eq(whatsappConnections.tenantId, tenantId),
  });

  if (!connection) {
    return { connected: false };
  }

  return {
    connected: connection.status === 'active',
    status: connection.status,
    phoneNumber: connection.displayPhoneNumber,
    businessName: connection.businessName,
    connectedAt: connection.verifiedAt,
  };
}

/**
 * Disconnect WhatsApp (marks as disconnected, doesn't delete data).
 */
export async function disconnectWhatsApp(tenantId: string): Promise<boolean> {
  const result = await db
    .update(whatsappConnections)
    .set({
      status: 'disconnected',
      updatedAt: new Date(),
    })
    .where(eq(whatsappConnections.tenantId, tenantId));

  // Delete tokens
  await tokenVaultService.deleteProviderTokens(tenantId, 'whatsapp');

  return true;
}
```

Update barrel export in src/services/whatsapp/index.ts.
  </action>
  <verify>
    - File exists: src/services/whatsapp/embedded-signup.ts
    - processEmbeddedSignup, getConnectionStatus, disconnectWhatsApp exported
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    Embedded Signup service handles token exchange with Graph API and stores credentials in Token Vault and connection in database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create callback route</name>
  <files>
    src/routes/whatsapp/callback.ts
    src/routes/whatsapp/index.ts
    src/index.ts
  </files>
  <action>
Create the callback endpoint for Embedded Signup:

**src/routes/whatsapp/callback.ts:**

```typescript
import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';
import { z } from 'zod';
import { processEmbeddedSignup, getConnectionStatus, disconnectWhatsApp } from '../../services/whatsapp/embedded-signup';
import { tenantContextMiddleware } from '../../middleware/tenant-context';

export const whatsappCallbackRoutes = new Hono();

// Apply tenant context middleware
whatsappCallbackRoutes.use('*', tenantContextMiddleware);

// Embedded Signup callback payload schema
const embeddedSignupSchema = z.object({
  code: z.string().min(1, 'Authorization code is required'),
  wabaId: z.string().min(1, 'WABA ID is required'),
  phoneNumberId: z.string().min(1, 'Phone Number ID is required'),
  displayPhoneNumber: z.string().optional(),
  businessName: z.string().optional(),
});

/**
 * POST /api/whatsapp/callback
 *
 * Receives Embedded Signup completion data from frontend.
 * Exchanges code for token and stores credentials.
 */
whatsappCallbackRoutes.post(
  '/',
  zValidator('json', embeddedSignupSchema),
  async (c) => {
    const tenantId = c.get('tenantId');
    if (!tenantId) {
      return c.json({ error: 'Tenant context required' }, 401);
    }

    const data = c.req.valid('json');

    const result = await processEmbeddedSignup(tenantId, data);

    if (!result.success) {
      return c.json(
        {
          error: result.error,
          details: process.env.NODE_ENV === 'development' ? result.errorDetails : undefined,
        },
        400
      );
    }

    return c.json({
      success: true,
      connectionId: result.connectionId,
      message: 'WhatsApp connected successfully',
    });
  }
);

/**
 * GET /api/whatsapp/status
 *
 * Returns current WhatsApp connection status for tenant.
 */
whatsappCallbackRoutes.get('/status', async (c) => {
  const tenantId = c.get('tenantId');
  if (!tenantId) {
    return c.json({ error: 'Tenant context required' }, 401);
  }

  const status = await getConnectionStatus(tenantId);
  return c.json(status);
});

/**
 * POST /api/whatsapp/disconnect
 *
 * Disconnects WhatsApp for tenant.
 */
whatsappCallbackRoutes.post('/disconnect', async (c) => {
  const tenantId = c.get('tenantId');
  if (!tenantId) {
    return c.json({ error: 'Tenant context required' }, 401);
  }

  await disconnectWhatsApp(tenantId);
  return c.json({ success: true, message: 'WhatsApp disconnected' });
});
```

**src/routes/whatsapp/index.ts:**

```typescript
export { whatsappCallbackRoutes } from './callback';
```

**Update src/index.ts** to mount the routes:

Add import:
```typescript
import { whatsappCallbackRoutes } from './routes/whatsapp/index';
```

Add route mount (under authenticated routes):
```typescript
app.route('/api/whatsapp', whatsappCallbackRoutes);
```
  </action>
  <verify>
    - File exists: src/routes/whatsapp/callback.ts
    - Route mounted in src/index.ts
    - `pnpm dev` starts without errors
    - `curl -X POST http://localhost:3000/api/whatsapp/status` returns 401 (no tenant)
  </verify>
  <done>
    POST /api/whatsapp (callback), GET /api/whatsapp/status, POST /api/whatsapp/disconnect endpoints are live and require tenant authentication.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Service verification:**
   - processEmbeddedSignup function exists and handles token exchange
   - getConnectionStatus returns connection info
   - disconnectWhatsApp marks connection as disconnected

2. **Route verification:**
   - Server starts: `pnpm dev`
   - Status endpoint exists: `curl http://localhost:3000/api/whatsapp/status` returns 401 (no tenant)
   - With tenant header, returns connection status

3. **Integration test:**
   - Mock the token exchange to test the flow:
     ```typescript
     // In test: Mock fetch to return a fake access_token
     // Call processEmbeddedSignup
     // Verify token stored in vault
     // Verify connection created in database
     ```
</verification>

<success_criteria>
- POST /api/whatsapp endpoint accepts Embedded Signup data
- Authorization code is exchanged for access token via Graph API
- Access token stored encrypted in Token Vault with whatsapp provider
- Phone Number ID stored in Token Vault as api_key type
- whatsapp_connections record created/updated with active status
- GET /api/whatsapp/status returns connection info
- POST /api/whatsapp/disconnect marks connection as disconnected and deletes tokens
</success_criteria>

<output>
After completion, create `.planning/phases/02-whatsapp-integration/02-02-SUMMARY.md`
</output>
