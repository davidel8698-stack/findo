---
phase: 02-whatsapp-integration
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/scheduler/jobs.ts
  - src/services/whatsapp/validation.ts
  - src/services/whatsapp/index.ts
  - src/queue/workers/test.worker.ts
autonomous: true

must_haves:
  truths:
    - "Token validity is checked every 24 hours"
    - "Invalid tokens are marked in Token Vault"
    - "Owner is notified when token becomes invalid"
    - "Connection status is updated to 'invalid' when token fails"
  artifacts:
    - path: "src/services/whatsapp/validation.ts"
      provides: "Token validation logic"
      exports: ["validateWhatsAppTokens", "validateTenantToken"]
    - path: "src/scheduler/jobs.ts"
      provides: "Daily validation job registration"
      contains: "whatsapp-token-validation"
    - path: "src/queue/workers/test.worker.ts"
      provides: "Scheduled job processor with WhatsApp token validation handler"
      contains: "validateWhatsAppTokens"
  key_links:
    - from: "src/scheduler/jobs.ts"
      to: "src/services/whatsapp/validation.ts"
      via: "validateWhatsAppTokens call"
      pattern: "validateWhatsAppTokens"
    - from: "src/queue/workers/test.worker.ts"
      to: "src/services/whatsapp/validation.ts"
      via: "import and call in token-refresh case"
      pattern: "validateWhatsAppTokens"
    - from: "src/services/whatsapp/validation.ts"
      to: "Token Vault"
      via: "tokenVaultService.markTokenInvalid"
      pattern: "markTokenInvalid"
---

<objective>
Create the daily token validation job that checks WhatsApp token health and notifies owners when tokens become invalid.

Purpose: Per CONTEXT.md, tokens should be validated every 24 hours proactively. When a token becomes invalid (revoked, expired, etc.), the owner needs multi-channel notification to reconnect. This prevents silent failures where messages stop working.

Output: Daily scheduled job for token validation with notification on failure.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\דודאלמועלם\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-whatsapp-integration/02-CONTEXT.md
@.planning/phases/02-whatsapp-integration/02-RESEARCH.md

# From 02-01 and 02-02
@src/services/whatsapp/client.ts
@src/services/token-vault.ts
@src/db/schema/whatsapp.ts

# Existing scheduler
@src/scheduler/jobs.ts
@src/scheduler/index.ts
@src/queue/workers/test.worker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create token validation service</name>
  <files>
    src/services/whatsapp/validation.ts
    src/services/whatsapp/index.ts
  </files>
  <action>
Create token validation service that checks WhatsApp token health:

**src/services/whatsapp/validation.ts:**

```typescript
import { db } from '../../db/index';
import { whatsappConnections } from '../../db/schema/index';
import { tokenVaultService } from '../token-vault';
import { activityService } from '../activity';
import { eq, ne } from 'drizzle-orm';

interface ValidationResult {
  tenantId: string;
  valid: boolean;
  error?: string;
}

/**
 * Validate a WhatsApp token by making a lightweight API call.
 *
 * Uses the "me" endpoint which returns account info if token is valid.
 * This is a low-cost way to verify token without consuming quota.
 */
async function validateToken(accessToken: string): Promise<{ valid: boolean; error?: string }> {
  try {
    const response = await fetch(
      'https://graph.facebook.com/v21.0/me',
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        },
      }
    );

    if (response.ok) {
      return { valid: true };
    }

    const error = await response.json();
    return {
      valid: false,
      error: error.error?.message || `HTTP ${response.status}`,
    };
  } catch (error) {
    return {
      valid: false,
      error: error instanceof Error ? error.message : 'Network error',
    };
  }
}

/**
 * Validate a single tenant's WhatsApp token.
 */
export async function validateTenantToken(tenantId: string): Promise<ValidationResult> {
  // Get the access token from vault
  const tokenResult = await tokenVaultService.getAccessToken(tenantId, 'whatsapp');

  if (!tokenResult) {
    return {
      tenantId,
      valid: false,
      error: 'No token found',
    };
  }

  // Validate the token
  const validation = await validateToken(tokenResult.token.value);

  if (!validation.valid) {
    // Mark token as invalid
    await tokenVaultService.markTokenInvalid(
      tokenResult.token.id,
      validation.error || 'Validation failed'
    );

    // Update connection status
    await db
      .update(whatsappConnections)
      .set({
        status: 'invalid',
        updatedAt: new Date(),
      })
      .where(eq(whatsappConnections.tenantId, tenantId));

    // Create activity event for dashboard
    await activityService.createAndPublish(tenantId, {
      eventType: 'whatsapp.token.invalid',
      title: 'WhatsApp connection lost',
      description: `WhatsApp token is no longer valid: ${validation.error}. Please reconnect.`,
      source: 'system',
      metadata: {
        error: validation.error,
        action: 'reconnect_required',
      },
    });

    console.warn(
      `[whatsapp-validation] Token invalid for tenant ${tenantId}: ${validation.error}`
    );
  }

  return {
    tenantId,
    valid: validation.valid,
    error: validation.error,
  };
}

/**
 * Validate all active WhatsApp connections.
 *
 * Called by daily scheduled job.
 * Returns summary of validation results.
 */
export async function validateWhatsAppTokens(): Promise<{
  total: number;
  valid: number;
  invalid: number;
  errors: Array<{ tenantId: string; error: string }>;
}> {
  console.log('[whatsapp-validation] Starting daily token validation');

  // Get all active connections
  const connections = await db.query.whatsappConnections.findMany({
    where: ne(whatsappConnections.status, 'disconnected'),
    columns: {
      tenantId: true,
    },
  });

  const results = {
    total: connections.length,
    valid: 0,
    invalid: 0,
    errors: [] as Array<{ tenantId: string; error: string }>,
  };

  // Validate each tenant's token
  // Process sequentially to avoid rate limiting
  for (const connection of connections) {
    const result = await validateTenantToken(connection.tenantId);

    if (result.valid) {
      results.valid++;
    } else {
      results.invalid++;
      results.errors.push({
        tenantId: connection.tenantId,
        error: result.error || 'Unknown error',
      });
    }

    // Small delay to avoid rate limiting (100ms between checks)
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  console.log(
    `[whatsapp-validation] Complete: ${results.valid}/${results.total} valid, ${results.invalid} invalid`
  );

  return results;
}

/**
 * Schedule notification to owner when token is invalid.
 *
 * Per CONTEXT.md: Multi-channel notification (WhatsApp, dashboard, email).
 * Since WhatsApp is broken, this uses dashboard activity + email (Phase 9).
 *
 * For now, just creates activity event. Email notification added in Phase 9.
 */
export async function notifyTokenInvalid(tenantId: string, error: string): Promise<void> {
  // Activity event already created in validateTenantToken
  // This function is a placeholder for future email notification

  // TODO (Phase 9): Send email notification
  // TODO (Phase 9): If another WhatsApp number available, send alert there

  console.log(`[whatsapp-validation] Owner notification queued for tenant ${tenantId}`);
}
```

Update barrel export to include validation functions.
  </action>
  <verify>
    - File exists: src/services/whatsapp/validation.ts
    - validateWhatsAppTokens, validateTenantToken exported
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    Token validation service checks tokens against Graph API and updates status on failure with activity notification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register daily validation job and add handler</name>
  <files>
    src/scheduler/jobs.ts
    src/queue/workers/test.worker.ts
  </files>
  <action>
Add the WhatsApp token validation job to the scheduler and implement the handler in the scheduled worker.

**Step 1: Update src/scheduler/jobs.ts**

The existing `scheduleRecurringJobs` function already has a `token-refresh` job that runs every 30 minutes. We need to:
1. Keep that for general token refresh
2. Add a new daily WhatsApp-specific validation job

Add to the `scheduleRecurringJobs` function in `src/scheduler/jobs.ts`:

```typescript
/**
 * WhatsApp Token Validation Job
 *
 * Runs daily at 3:00 AM Israel time.
 * Checks all active WhatsApp connections for token validity.
 * Marks invalid tokens and notifies owners.
 */
await scheduledQueue.add(
  'whatsapp-token-validation',
  {
    jobType: 'token-refresh',
    params: { provider: 'whatsapp', mode: 'daily-validation' },
  } satisfies ScheduledJobData,
  {
    repeat: {
      pattern: '0 3 * * *', // 3:00 AM daily
      tz: 'Asia/Jerusalem',
    },
    jobId: 'whatsapp-token-validation',
  }
);
console.log('[scheduler] Registered: whatsapp-token-validation (daily at 3:00 AM)');
```

**Step 2: Update src/queue/workers/test.worker.ts**

This is the scheduled jobs worker that processes jobs from the `scheduled` queue. Update the `token-refresh` case to handle WhatsApp validation:

Add import at top of file:
```typescript
import { validateWhatsAppTokens } from '../../services/whatsapp/validation';
```

Replace the `token-refresh` case in the switch statement:

```typescript
case 'token-refresh':
  // Check if this is the daily WhatsApp validation job
  if (params?.provider === 'whatsapp' && params?.mode === 'daily-validation') {
    console.log(`[scheduled] Running daily WhatsApp token validation`);
    const results = await validateWhatsAppTokens();
    console.log(`[scheduled] WhatsApp token validation complete: ${results.valid}/${results.total} valid, ${results.invalid} invalid`);
    if (results.invalid > 0) {
      console.warn(`[scheduled] Invalid tokens found for tenants:`, results.errors.map(e => e.tenantId).join(', '));
    }
  } else {
    // General token refresh placeholder (for future Google tokens, etc.)
    console.log(`[scheduled] Token refresh job placeholder (provider: ${params?.provider || 'all'})`);
  }
  break;
```

The worker file is located at: `src/queue/workers/test.worker.ts`
Despite the name "test.worker.ts", this is the scheduled jobs worker that processes all scheduled queue jobs including production jobs.
  </action>
  <verify>
    - Job registered: `pnpm dev` shows "Registered: whatsapp-token-validation"
    - Job has correct cron pattern (daily at 3:00 AM Israel time)
    - Handler exists in src/queue/workers/test.worker.ts with import of validateWhatsAppTokens
    - TypeScript compiles: `pnpm tsc --noEmit`
  </verify>
  <done>
    Daily token validation job registered to run at 3:00 AM Israel time. Handler in src/queue/workers/test.worker.ts calls validateWhatsAppTokens and logs results.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Job registration verification:**
   - Server starts and shows "Registered: whatsapp-token-validation"
   - Check scheduledQueue for the job: look in Redis

2. **Validation logic verification:**
   - validateTenantToken makes Graph API call
   - Invalid token marks vault entry and connection status
   - Activity event created for invalid token

3. **Handler verification:**
   - src/queue/workers/test.worker.ts imports validateWhatsAppTokens
   - token-refresh case checks for provider === 'whatsapp' && mode === 'daily-validation'
   - Handler calls validateWhatsAppTokens() and logs results

4. **Manual test:**
   ```typescript
   // Test with known invalid token
   await validateTenantToken('test-tenant-id');
   // Should mark as invalid and create activity
   ```

5. **TypeScript verification:**
   - `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Daily job registered with cron pattern '0 3 * * *' (3:00 AM Israel time)
- Job validates all active WhatsApp connections
- Invalid tokens marked in Token Vault with isValid: 'false'
- Connection status updated to 'invalid' when token fails
- Activity event created for dashboard notification
- Validation uses Graph API /me endpoint (low cost)
- Sequential processing with rate limit protection
- Handler in src/queue/workers/test.worker.ts correctly routes to validateWhatsAppTokens
</success_criteria>

<output>
After completion, create `.planning/phases/02-whatsapp-integration/02-05-SUMMARY.md`
</output>
