---
phase: 03-lead-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/leads.ts
  - src/db/schema/index.ts
  - src/services/voicenter/types.ts
  - src/lib/phone.ts
autonomous: true

must_haves:
  truths:
    - "Lead records can be created and queried by tenant"
    - "Missed call records track Voicenter call IDs for idempotency"
    - "Lead conversation state can be tracked and updated"
    - "Phone numbers are normalized to international format"
  artifacts:
    - path: "src/db/schema/leads.ts"
      provides: "Lead, missed call, and lead conversation tables"
      contains: "leads"
    - path: "src/services/voicenter/types.ts"
      provides: "Voicenter CDR webhook payload types"
      exports: ["VoicenterCDR", "MISSED_CALL_STATUSES"]
    - path: "src/lib/phone.ts"
      provides: "Israeli phone number normalization"
      exports: ["normalizeIsraeliPhone"]
  key_links:
    - from: "src/db/schema/leads.ts"
      to: "src/db/schema/tenants.ts"
      via: "Foreign key reference"
      pattern: "references.*tenants"
---

<objective>
Create database schema for lead capture system and Voicenter types.

Purpose: Foundation for all lead capture functionality - missed calls, leads, and conversation tracking.
Output: Database tables for leads/missed_calls/lead_conversations, Voicenter CDR types, phone normalization utility.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-lead-capture/03-CONTEXT.md
@.planning/phases/03-lead-capture/03-RESEARCH.md
@src/db/schema/tenants.ts
@src/db/schema/whatsapp.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lead database schema</name>
  <files>src/db/schema/leads.ts, src/db/schema/index.ts</files>
  <action>
Create src/db/schema/leads.ts with three tables per RESEARCH.md patterns:

1. **leads table:**
   - id: UUID primary key
   - tenantId: UUID FK to tenants (cascade delete)
   - source: enum (missed_call, manual, website)
   - sourceId: varchar(100) for Voicenter CallID
   - customerPhone: varchar(20) NOT NULL
   - customerName: varchar(255) nullable
   - need: text nullable
   - contactPreference: text nullable
   - status: enum (new, qualifying, qualified, unresponsive, contacted, converted, lost)
   - capturedAt, qualifiedAt, contactedAt timestamps with timezone
   - createdAt, updatedAt timestamps with timezone
   - Indexes: tenantId, status, customerPhone

2. **leadConversations table:**
   - id: UUID primary key
   - leadId: UUID FK to leads (cascade delete, unique)
   - state: enum (awaiting_response, awaiting_name, awaiting_need, awaiting_preference, completed, unresponsive)
   - reminder1SentAt, reminder2SentAt timestamps nullable
   - whatsappConversationId: UUID nullable (link to whatsapp_conversations)
   - createdAt, updatedAt timestamps
   - Index: leadId

3. **missedCalls table:**
   - id: UUID primary key
   - tenantId: UUID FK to tenants (cascade delete)
   - callId: varchar(100) NOT NULL UNIQUE (Voicenter CallID - idempotency key)
   - callerPhone: varchar(20) NOT NULL
   - businessPhone: varchar(20) NOT NULL
   - status: varchar(20) NOT NULL (NOANSWER, BUSY, etc.)
   - calledAt: timestamp with timezone NOT NULL
   - processedAt: timestamp nullable
   - leadId: UUID FK to leads nullable
   - createdAt: timestamp default now

Export all types with $inferSelect and $inferInsert patterns.

Update src/db/schema/index.ts to export all new tables and types from leads.ts.
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Run `pnpm drizzle-kit generate` - generates migration SQL.
Check migration file contains CREATE TABLE statements for all three tables.
  </verify>
  <done>
Three tables (leads, lead_conversations, missed_calls) exist in schema with proper foreign keys, enums, and indexes. TypeScript types exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Voicenter CDR types</name>
  <files>src/services/voicenter/types.ts</files>
  <action>
Create src/services/voicenter/types.ts with Voicenter CDR webhook payload types per RESEARCH.md:

```typescript
// Voicenter CDR (Call Detail Record) webhook payload
export interface VoicenterCDR {
  caller: string;           // Caller phone number (e.g., "0512345678")
  target: string;           // Target phone/extension
  time: number;             // Epoch timestamp (seconds)
  Duration: number;         // Call duration in seconds (0 = not answered)
  DialStatus: VoicenterCallStatus;
  DID: string;              // Called number (the business number)
  CallID: string;           // Unique call identifier (idempotency key)
  QueueName?: string;       // Queue name if applicable
  RepresentativeName?: string;
  RecordURL?: string;       // Recording URL if recorded
}

export type VoicenterCallStatus =
  | 'ANSWER'      // Call was answered
  | 'NOANSWER'    // No answer (missed call)
  | 'BUSY'        // Line busy
  | 'CANCEL'      // Caller hung up before answer
  | 'CONGESTION'  // Network congestion
  | 'ABANDONE'    // Abandoned in queue (note: Voicenter typo)
  | 'VOEND';      // Voicemail ended

// Statuses that indicate a missed call requiring lead capture
export const MISSED_CALL_STATUSES: VoicenterCallStatus[] = [
  'NOANSWER', 'CANCEL', 'BUSY', 'ABANDONE'
];

// Type guard for missed call status
export function isMissedCall(status: string): status is VoicenterCallStatus {
  return MISSED_CALL_STATUSES.includes(status as VoicenterCallStatus);
}
```

Export from a new src/services/voicenter/index.ts barrel file.
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Verify types are importable: `import { VoicenterCDR } from '../services/voicenter'`
  </verify>
  <done>
VoicenterCDR interface, VoicenterCallStatus type, MISSED_CALL_STATUSES constant, and isMissedCall type guard exported from src/services/voicenter/.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create phone number normalizer</name>
  <files>src/lib/phone.ts</files>
  <action>
Create src/lib/phone.ts with Israeli phone number normalization:

```typescript
/**
 * Normalize Israeli phone number to international format (+972XXXXXXXXX).
 *
 * Handles various input formats:
 * - Local: 0501234567
 * - International: +972501234567
 * - With dashes: 050-123-4567
 * - With spaces: 050 123 4567
 * - Without leading zero: 501234567
 *
 * @param phone - Phone number in any Israeli format
 * @returns Phone number in +972XXXXXXXXX format, or original if cannot parse
 */
export function normalizeIsraeliPhone(phone: string): string {
  // Remove all non-digit characters except leading +
  let cleaned = phone.replace(/[^\d+]/g, '');

  // If starts with +972, already international
  if (cleaned.startsWith('+972')) {
    return cleaned;
  }

  // If starts with 972 (no +), add +
  if (cleaned.startsWith('972')) {
    return '+' + cleaned;
  }

  // If starts with 0, replace with +972
  if (cleaned.startsWith('0')) {
    return '+972' + cleaned.slice(1);
  }

  // If 9 digits (no leading 0), assume Israeli mobile
  if (cleaned.length === 9 && /^[5]/.test(cleaned)) {
    return '+972' + cleaned;
  }

  // Cannot normalize - return original cleaned version
  return cleaned;
}

/**
 * Format phone number for display (Israeli format with dashes).
 *
 * @param phone - Phone number in international format
 * @returns Phone number formatted as 050-123-4567
 */
export function formatPhoneDisplay(phone: string): string {
  // Remove +972 prefix if present
  let local = phone.replace(/^\+972/, '0');

  // Format as 0XX-XXX-XXXX
  if (local.length === 10 && local.startsWith('0')) {
    return `${local.slice(0, 3)}-${local.slice(3, 6)}-${local.slice(6)}`;
  }

  return local;
}
```

Include unit test cases as comments showing expected inputs/outputs.
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Manual verification: Mentally trace these inputs:
- "0501234567" -> "+972501234567"
- "+972501234567" -> "+972501234567"
- "050-123-4567" -> "+972501234567"
- "501234567" -> "+972501234567"
  </verify>
  <done>
normalizeIsraeliPhone and formatPhoneDisplay functions exported from src/lib/phone.ts. Functions handle all common Israeli phone formats.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm tsc --noEmit` passes with no errors
2. `pnpm drizzle-kit generate` creates migration with 3 new tables
3. Files exist: src/db/schema/leads.ts, src/services/voicenter/types.ts, src/lib/phone.ts
4. All exports are importable from their respective barrel files
</verification>

<success_criteria>
- Three database tables defined with proper types and constraints
- Voicenter CDR types match webhook payload structure
- Phone normalizer handles all common Israeli formats
- All code compiles without errors
- Database migration generated successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-capture/03-01-SUMMARY.md`
</output>
