---
phase: 03-lead-capture
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/routes/webhooks.ts
  - src/queue/queues.ts
  - src/queue/workers/voicenter-cdr.worker.ts
  - src/queue/index.ts
autonomous: true

user_setup:
  - service: voicenter
    why: "Receive webhook notifications for missed calls"
    env_vars: []
    dashboard_config:
      - task: "Configure CDR webhook URL"
        location: "Voicenter Dashboard -> Settings -> CDR Notifications -> Add webhook URL: https://your-domain.com/webhooks/voicenter/cdr"

must_haves:
  truths:
    - "Voicenter CDR webhook endpoint receives POST requests and returns 200 OK"
    - "Missed calls are queued for processing via BullMQ"
    - "Answered calls are ignored (no lead capture)"
    - "Duplicate call IDs are rejected via idempotency check"
  artifacts:
    - path: "src/routes/webhooks.ts"
      provides: "POST /webhooks/voicenter/cdr endpoint"
      contains: "voicenter/cdr"
    - path: "src/queue/workers/voicenter-cdr.worker.ts"
      provides: "Worker processing Voicenter CDR events"
      exports: ["startVoicenterCDRWorker"]
    - path: "src/queue/queues.ts"
      provides: "Lead outreach queue"
      contains: "leadOutreachQueue"
  key_links:
    - from: "src/routes/webhooks.ts"
      to: "src/queue/queues.ts"
      via: "webhookQueue.add for Voicenter CDR"
      pattern: "webhookQueue\\.add.*voicenter"
    - from: "src/queue/workers/voicenter-cdr.worker.ts"
      to: "src/queue/queues.ts"
      via: "leadOutreachQueue.add with 2-min delay"
      pattern: "leadOutreachQueue\\.add.*delay"
---

<objective>
Create Voicenter webhook endpoint and CDR processing worker.

Purpose: Receive missed call notifications from Voicenter and queue them for lead capture.
Output: Webhook endpoint, CDR worker, lead-outreach queue.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/03-lead-capture/03-CONTEXT.md
@.planning/phases/03-lead-capture/03-RESEARCH.md
@src/routes/webhooks.ts
@src/queue/queues.ts
@src/queue/workers/webhook.worker.ts
@src/services/voicenter/types.ts
@src/db/schema/leads.ts
@src/db/schema/whatsapp.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Voicenter CDR webhook endpoint</name>
  <files>src/routes/webhooks.ts</files>
  <action>
Extend src/routes/webhooks.ts to add Voicenter CDR webhook endpoint:

```typescript
// Add POST /webhooks/voicenter/cdr endpoint
webhookRouter.post('/voicenter/cdr', async (c) => {
  // Parse CDR payload - Voicenter sends JSON body
  const cdr = await c.req.json() as VoicenterCDR;

  // Validate required fields
  if (!cdr.CallID || !cdr.caller || !cdr.DID || !cdr.DialStatus) {
    console.warn('[voicenter] Invalid CDR payload - missing required fields');
    return c.text('Bad Request', 400);
  }

  // Respond immediately - Voicenter expects fast 200 OK
  // Processing happens asynchronously via queue

  // Queue for processing (using existing webhookQueue)
  await webhookQueue.add('voicenter-cdr', {
    source: 'voicenter',
    eventId: cdr.CallID,
    eventType: 'cdr.received',
    payload: cdr,
    receivedAt: new Date().toISOString(),
  });

  console.log(`[voicenter] Queued CDR ${cdr.CallID} (${cdr.DialStatus})`);
  return c.text('OK', 200);
});
```

Import VoicenterCDR type from src/services/voicenter.
Keep response time under 500ms (respond before processing).
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Manually verify route is registered by searching for '/voicenter/cdr' in webhooks.ts.
  </verify>
  <done>
POST /webhooks/voicenter/cdr endpoint exists, parses CDR payload, queues to webhookQueue, returns 200 OK immediately.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add lead outreach queue</name>
  <files>src/queue/queues.ts</files>
  <action>
Add lead-outreach queue to src/queue/queues.ts:

```typescript
/**
 * Lead outreach queue.
 * Handles delayed WhatsApp messages to missed call callers.
 * Uses delay feature for 2-minute wait before sending.
 */
export const leadOutreachQueue = new Queue('lead-outreach', {
  ...defaultQueueOptions,
  connection: createRedisConnection(),
});

/**
 * Lead reminders queue.
 * Handles follow-up reminders for unresponsive leads.
 */
export const leadReminderQueue = new Queue('lead-reminders', {
  ...defaultQueueOptions,
  connection: createRedisConnection(),
});

// Add to job data interfaces
export interface LeadOutreachJobData {
  tenantId: string;
  missedCallId: string;
  callerPhone: string;
}

export interface LeadReminderJobData {
  leadId: string;
  leadConversationId: string;
  reminderNumber: 1 | 2;  // 1 = 2-hour, 2 = 24-hour
}
```

Export both queues and their job data types.
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Verify leadOutreachQueue and leadReminderQueue are exported from queues.ts.
  </verify>
  <done>
leadOutreachQueue and leadReminderQueue created with proper connection and options. LeadOutreachJobData and LeadReminderJobData interfaces exported.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Voicenter CDR worker</name>
  <files>src/queue/workers/voicenter-cdr.worker.ts, src/queue/index.ts</files>
  <action>
Create src/queue/workers/voicenter-cdr.worker.ts:

```typescript
import { Worker, Job } from 'bullmq';
import { createRedisConnection } from '../../lib/redis';
import { db } from '../../db/index';
import { missedCalls, whatsappConnections } from '../../db/schema/index';
import { eq } from 'drizzle-orm';
import { VoicenterCDR, MISSED_CALL_STATUSES, isMissedCall } from '../../services/voicenter';
import { normalizeIsraeliPhone } from '../../lib/phone';
import { leadOutreachQueue, WebhookJobData } from '../queues';

interface VoicenterCDRJobData extends WebhookJobData {
  payload: VoicenterCDR;
}

async function processVoicenterCDR(job: Job<VoicenterCDRJobData>): Promise<void> {
  const cdr = job.data.payload;
  const callId = cdr.CallID;

  console.log(`[voicenter-cdr] Processing call ${callId} (${cdr.DialStatus})`);

  // Skip if not a missed call
  if (!isMissedCall(cdr.DialStatus)) {
    console.log(`[voicenter-cdr] Call ${callId} answered (${cdr.DialStatus}), skipping`);
    return;
  }

  // Find tenant by business phone (DID)
  // Business phone in WhatsApp connections matches Voicenter DID
  const normalizedDID = normalizeIsraeliPhone(cdr.DID);
  const connection = await db.query.whatsappConnections.findFirst({
    where: eq(whatsappConnections.displayPhoneNumber, normalizedDID),
  });

  if (!connection) {
    console.warn(`[voicenter-cdr] No WhatsApp connection for DID ${cdr.DID} (normalized: ${normalizedDID})`);
    return;
  }

  const tenantId = connection.tenantId;
  const callerPhone = normalizeIsraeliPhone(cdr.caller);

  // Idempotency check - skip if already processed
  const existing = await db.query.missedCalls.findFirst({
    where: eq(missedCalls.callId, callId),
  });

  if (existing) {
    console.log(`[voicenter-cdr] Call ${callId} already processed, skipping`);
    return;
  }

  // Store missed call record
  const [missedCall] = await db.insert(missedCalls).values({
    tenantId,
    callId,
    callerPhone,
    businessPhone: cdr.DID,
    status: cdr.DialStatus,
    calledAt: new Date(cdr.time * 1000),
  }).returning();

  console.log(`[voicenter-cdr] Recorded missed call ${callId} from ${callerPhone}`);

  // Schedule delayed outreach (2 minutes per CONTEXT.md)
  await leadOutreachQueue.add(
    'send-initial-message',
    {
      tenantId,
      missedCallId: missedCall.id,
      callerPhone,
    },
    {
      delay: 2 * 60 * 1000, // 2 minutes = 120,000 ms
      jobId: `lead-outreach-${missedCall.id}`, // For potential cancellation
    }
  );

  console.log(`[voicenter-cdr] Scheduled outreach for ${callerPhone} in 2 minutes`);
}

export function startVoicenterCDRWorker(): Worker<VoicenterCDRJobData> {
  const worker = new Worker<VoicenterCDRJobData>(
    'webhooks',
    async (job) => {
      // Only process voicenter-cdr jobs
      if (job.name === 'voicenter-cdr') {
        await processVoicenterCDR(job);
      }
    },
    {
      connection: createRedisConnection(),
      concurrency: 5,
    }
  );

  worker.on('completed', (job) => {
    if (job.name === 'voicenter-cdr') {
      console.log(`[voicenter-cdr] Job ${job.id} completed`);
    }
  });

  worker.on('failed', (job, err) => {
    if (job?.name === 'voicenter-cdr') {
      console.error(`[voicenter-cdr] Job ${job.id} failed:`, err.message);
    }
  });

  console.log('[voicenter-cdr] Worker started');
  return worker;
}
```

Update src/queue/index.ts to export startVoicenterCDRWorker.
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Verify startVoicenterCDRWorker is exported from src/queue/index.ts.
  </verify>
  <done>
Voicenter CDR worker processes missed calls, stores to missed_calls table, schedules 2-minute delayed outreach job. Idempotency via callId check.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm tsc --noEmit` passes with no errors
2. POST /webhooks/voicenter/cdr endpoint exists
3. leadOutreachQueue and leadReminderQueue exist in queues.ts
4. startVoicenterCDRWorker is exported from queue/index.ts
5. Worker filters for voicenter-cdr jobs and processes them
</verification>

<success_criteria>
- Voicenter webhook endpoint accepts CDR payloads and returns 200 OK
- Missed calls are stored in database with idempotency
- 2-minute delayed job is scheduled for lead outreach
- Answered calls are ignored (not processed for lead capture)
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-capture/03-02-SUMMARY.md`
</output>
