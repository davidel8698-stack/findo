---
phase: 04-google-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/services/google/profile.ts
  - src/services/google/reviews.ts
  - src/services/google/index.ts
autonomous: true

must_haves:
  truths:
    - "System can read business profile details from GBP API"
    - "System can list existing reviews from GBP API"
    - "System can post a reply to a review via GBP API"
    - "Review replies are limited to 4096 bytes"
  artifacts:
    - path: "src/services/google/profile.ts"
      provides: "Business profile reading"
      exports: ["getBusinessProfile", "getLocations"]
    - path: "src/services/google/reviews.ts"
      provides: "Review operations"
      exports: ["listReviews", "postReviewReply"]
  key_links:
    - from: "src/services/google/reviews.ts"
      to: "src/services/google/oauth.ts"
      via: "createAuthenticatedClient call"
      pattern: "createAuthenticatedClient\\("
    - from: "src/services/google/profile.ts"
      to: "src/services/google/oauth.ts"
      via: "createAuthenticatedClient call"
      pattern: "createAuthenticatedClient\\("
---

<objective>
Create Google Business Profile API services for reading business profiles and managing reviews.

Purpose: Enable Findo to read business information and interact with reviews - the foundation for Phase 5 (Review Management) which will auto-reply to positive reviews and draft responses for negative ones.

Output:
- Business profile service for reading profile details and locations
- Reviews service for listing reviews and posting replies
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-google-integration/04-RESEARCH.md
@.planning/phases/04-google-integration/04-01-SUMMARY.md

# OAuth service from Plan 01
@src/services/google/oauth.ts
@src/db/schema/google.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Business Profile service</name>
  <files>src/services/google/profile.ts</files>
  <action>
Create service for reading Google Business Profile data:

```typescript
import { google } from 'googleapis';
import { createAuthenticatedClient } from './oauth';

export interface BusinessProfile {
  accountId: string;
  accountName: string;
  locations: LocationInfo[];
}

export interface LocationInfo {
  locationId: string;
  name: string;          // Full resource name: accounts/{accountId}/locations/{locationId}
  title: string;         // Business display name
  address?: string;      // Formatted address
  primaryPhone?: string;
  websiteUri?: string;
}

// Get list of locations for a tenant's GBP account
export async function getLocations(
  tenantId: string,
  accountId: string
): Promise<LocationInfo[]> {
  const { client } = await createAuthenticatedClient(tenantId, accountId);

  const businessInfo = google.mybusinessbusinessinformation({
    version: 'v1',
    auth: client,
  });

  const response = await businessInfo.accounts.locations.list({
    parent: `accounts/${accountId}`,
    readMask: 'name,title,storefrontAddress,phoneNumbers,websiteUri',
  });

  const locations = response.data.locations || [];

  return locations.map((loc) => ({
    locationId: loc.name?.split('/').pop() || '',
    name: loc.name || '',
    title: loc.title || '',
    address: loc.storefrontAddress?.addressLines?.join(', '),
    primaryPhone: loc.phoneNumbers?.primaryPhone,
    websiteUri: loc.websiteUri,
  }));
}

// Get detailed profile for a specific location
export async function getBusinessProfile(
  tenantId: string,
  accountId: string,
  locationId: string
): Promise<LocationInfo | null> {
  const { client } = await createAuthenticatedClient(tenantId, accountId);

  const businessInfo = google.mybusinessbusinessinformation({
    version: 'v1',
    auth: client,
  });

  try {
    const response = await businessInfo.accounts.locations.get({
      name: `accounts/${accountId}/locations/${locationId}`,
      readMask: 'name,title,storefrontAddress,phoneNumbers,websiteUri',
    });

    const loc = response.data;
    return {
      locationId: loc.name?.split('/').pop() || '',
      name: loc.name || '',
      title: loc.title || '',
      address: loc.storefrontAddress?.addressLines?.join(', '),
      primaryPhone: loc.phoneNumbers?.primaryPhone,
      websiteUri: loc.websiteUri,
    };
  } catch (error: any) {
    console.error('Failed to get business profile:', error.message);
    return null;
  }
}

// Get account info (for debugging/verification)
export async function getAccountInfo(
  tenantId: string,
  accountId: string
): Promise<{ accountId: string; accountName: string } | null> {
  const { client } = await createAuthenticatedClient(tenantId, accountId);

  const accountManagement = google.mybusinessaccountmanagement({
    version: 'v1',
    auth: client,
  });

  try {
    const response = await accountManagement.accounts.get({
      name: `accounts/${accountId}`,
    });

    return {
      accountId: response.data.name?.replace('accounts/', '') || '',
      accountName: response.data.accountName || '',
    };
  } catch (error: any) {
    console.error('Failed to get account info:', error.message);
    return null;
  }
}
```

Key points:
- Uses mybusinessbusinessinformation API for location details
- Uses mybusinessaccountmanagement API for account info
- readMask specifies which fields to return (reduces payload)
- Returns typed interfaces for clean consumption
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Exports: getLocations, getBusinessProfile, getAccountInfo
- Types: BusinessProfile, LocationInfo exported
  </verify>
  <done>
- Profile service can read location details
- Location list supports multi-location businesses
- Account info available for verification
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Reviews service</name>
  <files>src/services/google/reviews.ts, src/services/google/index.ts</files>
  <action>
Create service for listing reviews and posting replies:

```typescript
import { google } from 'googleapis';
import { createAuthenticatedClient } from './oauth';

export interface Review {
  reviewId: string;
  name: string;          // Full resource name
  reviewerName: string;  // Reviewer display name
  starRating: number;    // 1-5
  comment?: string;      // Review text (nullable for rating-only reviews)
  createTime: string;    // ISO timestamp
  updateTime: string;    // ISO timestamp
  reply?: ReviewReply;
}

export interface ReviewReply {
  comment: string;
  updateTime: string;
}

export interface ListReviewsOptions {
  pageSize?: number;     // Default 50, max 50
  pageToken?: string;    // For pagination
  orderBy?: 'updateTime desc' | 'rating desc' | 'rating asc';
}

// List reviews for a location
export async function listReviews(
  tenantId: string,
  accountId: string,
  locationId: string,
  options: ListReviewsOptions = {}
): Promise<{ reviews: Review[]; nextPageToken?: string }> {
  const { client } = await createAuthenticatedClient(tenantId, accountId);

  // Note: Reviews are accessed via My Business API v4 endpoint
  // Not via mybusinessbusinessinformation
  const mybusiness = google.mybusiness({
    version: 'v4',
    auth: client,
  });

  const response = await mybusiness.accounts.locations.reviews.list({
    parent: `accounts/${accountId}/locations/${locationId}`,
    pageSize: options.pageSize || 50,
    pageToken: options.pageToken,
    orderBy: options.orderBy || 'updateTime desc',
  });

  const reviews = (response.data.reviews || []).map((r) => ({
    reviewId: r.name?.split('/').pop() || '',
    name: r.name || '',
    reviewerName: r.reviewer?.displayName || 'Anonymous',
    starRating: parseStarRating(r.starRating),
    comment: r.comment,
    createTime: r.createTime || '',
    updateTime: r.updateTime || '',
    reply: r.reviewReply ? {
      comment: r.reviewReply.comment || '',
      updateTime: r.reviewReply.updateTime || '',
    } : undefined,
  }));

  return {
    reviews,
    nextPageToken: response.data.nextPageToken,
  };
}

// Post a reply to a review
export async function postReviewReply(
  tenantId: string,
  accountId: string,
  locationId: string,
  reviewId: string,
  replyText: string
): Promise<ReviewReply> {
  // Validate reply length (max 4096 bytes)
  const replyBytes = Buffer.byteLength(replyText, 'utf8');
  if (replyBytes > 4096) {
    throw new Error(`Reply exceeds 4096 bytes (${replyBytes} bytes). Hebrew characters count as 2-3 bytes each.`);
  }

  const { client } = await createAuthenticatedClient(tenantId, accountId);

  const mybusiness = google.mybusiness({
    version: 'v4',
    auth: client,
  });

  const response = await mybusiness.accounts.locations.reviews.updateReply({
    name: `accounts/${accountId}/locations/${locationId}/reviews/${reviewId}`,
    requestBody: {
      comment: replyText,
    },
  });

  return {
    comment: response.data.comment || replyText,
    updateTime: response.data.updateTime || new Date().toISOString(),
  };
}

// Delete a review reply
export async function deleteReviewReply(
  tenantId: string,
  accountId: string,
  locationId: string,
  reviewId: string
): Promise<void> {
  const { client } = await createAuthenticatedClient(tenantId, accountId);

  const mybusiness = google.mybusiness({
    version: 'v4',
    auth: client,
  });

  await mybusiness.accounts.locations.reviews.deleteReply({
    name: `accounts/${accountId}/locations/${locationId}/reviews/${reviewId}`,
  });
}

// Get a single review by ID
export async function getReview(
  tenantId: string,
  accountId: string,
  locationId: string,
  reviewId: string
): Promise<Review | null> {
  const { client } = await createAuthenticatedClient(tenantId, accountId);

  const mybusiness = google.mybusiness({
    version: 'v4',
    auth: client,
  });

  try {
    const response = await mybusiness.accounts.locations.reviews.get({
      name: `accounts/${accountId}/locations/${locationId}/reviews/${reviewId}`,
    });

    const r = response.data;
    return {
      reviewId: r.name?.split('/').pop() || '',
      name: r.name || '',
      reviewerName: r.reviewer?.displayName || 'Anonymous',
      starRating: parseStarRating(r.starRating),
      comment: r.comment,
      createTime: r.createTime || '',
      updateTime: r.updateTime || '',
      reply: r.reviewReply ? {
        comment: r.reviewReply.comment || '',
        updateTime: r.reviewReply.updateTime || '',
      } : undefined,
    };
  } catch (error: any) {
    console.error('Failed to get review:', error.message);
    return null;
  }
}

// Helper to parse star rating enum
function parseStarRating(rating?: string): number {
  if (!rating) return 0;

  const ratingMap: Record<string, number> = {
    'ONE': 1,
    'TWO': 2,
    'THREE': 3,
    'FOUR': 4,
    'FIVE': 5,
  };

  return ratingMap[rating] || 0;
}
```

Update `src/services/google/index.ts` to export all services:

```typescript
export * from './oauth';
export * from './profile';
export * from './reviews';
```

Key decisions:
- Reviews use mybusiness v4 API (not mybusinessbusinessinformation)
- Reply text limited to 4096 bytes (with Hebrew byte counting)
- Star rating converted from enum to number (1-5)
- Pagination support for large review lists
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Exports from reviews.ts: listReviews, postReviewReply, deleteReviewReply, getReview
- Types: Review, ReviewReply, ListReviewsOptions exported
- Barrel export updated in index.ts
  </verify>
  <done>
- listReviews returns paginated reviews with star rating, comment, and existing reply
- postReviewReply posts reply with byte limit validation
- deleteReviewReply removes an existing reply
- getReview fetches single review details
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. All exports available from src/services/google/index.ts:
   - OAuth: getAuthUrl, handleCallback, getGoogleConnection, disconnectGoogle, createAuthenticatedClient
   - Profile: getLocations, getBusinessProfile, getAccountInfo
   - Reviews: listReviews, postReviewReply, deleteReviewReply, getReview
3. Type definitions complete for all interfaces
</verification>

<success_criteria>
- Profile service can read business details and locations
- Reviews service can list reviews with pagination
- Reviews service can post replies with byte limit enforcement
- All services integrate with OAuth authentication via createAuthenticatedClient
</success_criteria>

<output>
After completion, create `.planning/phases/04-google-integration/04-02-SUMMARY.md`
</output>
