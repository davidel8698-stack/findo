---
phase: 04-google-integration
plan: 04
type: execute
wave: 3
depends_on: ["04-01"]
files_modified:
  - src/views/google-connect.ts
  - src/views/index.ts
  - public/js/google-connect.js
  - src/routes/pages.ts
autonomous: false

must_haves:
  truths:
    - "User can click Connect Google button and be redirected to Google OAuth"
    - "After OAuth completion, user sees success screen with business name"
    - "If OAuth fails, user sees error message with guidance"
    - "Page displays in Hebrew with RTL layout"
  artifacts:
    - path: "src/views/google-connect.ts"
      provides: "HTML template for Google connection page"
      exports: ["renderGoogleConnectPage"]
    - path: "public/js/google-connect.js"
      provides: "Client-side OAuth redirect handling"
      min_lines: 20
  key_links:
    - from: "public/js/google-connect.js"
      to: "/api/google/auth"
      via: "fetch call to get auth URL"
      pattern: "fetch.*api/google/auth"
    - from: "src/routes/pages.ts"
      to: "src/views/google-connect.ts"
      via: "renderGoogleConnectPage import"
      pattern: "renderGoogleConnectPage"
---

<objective>
Create the Google connection frontend UI following the WhatsApp connection pattern.

Purpose: Enable business owners to connect their Google Business Profile through a simple, Hebrew-language UI that guides them through the OAuth flow.

Output:
- Google connection page with Connect button
- Success state showing connected business name
- Error state with troubleshooting guidance
- Hebrew UI with RTL layout matching WhatsApp pattern
</objective>

<execution_context>
@C:\Users\×“×•×“××œ××•×¢×œ×\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\×“×•×“××œ××•×¢×œ×\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-google-integration/04-01-SUMMARY.md

# WhatsApp connection UI pattern to follow
@src/views/whatsapp-connect.ts
@public/js/whatsapp-signup.js
@src/routes/pages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google connection page view</name>
  <files>src/views/google-connect.ts, src/views/index.ts</files>
  <action>
Create Google connection page following WhatsApp pattern:

```typescript
// src/views/google-connect.ts

interface GoogleConnectState {
  success?: boolean;
  error?: string;
  accountName?: string;
  locationName?: string;
}

export function renderGoogleConnectPage(state: GoogleConnectState = {}): string {
  const { success, error, accountName, locationName } = state;

  return `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×—×™×‘×•×¨ Google Business Profile | Findo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    .logo {
      font-size: 48px;
      margin-bottom: 16px;
    }
    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 12px;
    }
    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 32px;
      line-height: 1.5;
    }
    .connect-btn {
      background: #4285F4;
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: background 0.2s;
    }
    .connect-btn:hover {
      background: #3367D6;
    }
    .connect-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .google-icon {
      width: 24px;
      height: 24px;
    }
    .success-container, .error-container {
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .success-container {
      background: #E8F5E9;
      border: 1px solid #4CAF50;
    }
    .success-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .success-title {
      color: #2E7D32;
      font-size: 20px;
      margin-bottom: 8px;
    }
    .success-detail {
      color: #333;
      font-size: 14px;
    }
    .business-name {
      font-weight: bold;
      color: #1B5E20;
    }
    .error-container {
      background: #FFEBEE;
      border: 1px solid #F44336;
    }
    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .error-title {
      color: #C62828;
      font-size: 20px;
      margin-bottom: 8px;
    }
    .error-detail {
      color: #333;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .retry-btn {
      background: #F44336;
      color: white;
      border: none;
      padding: 10px 24px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    .retry-btn:hover {
      background: #D32F2F;
    }
    .info-box {
      background: #F5F5F5;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      font-size: 13px;
      color: #666;
      text-align: right;
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    .loading-overlay.active {
      display: flex;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #E0E0E0;
      border-top-color: #4285F4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 16px;
      color: #666;
      font-size: 14px;
    }
    .dashboard-link {
      display: inline-block;
      margin-top: 16px;
      color: #4285F4;
      text-decoration: none;
      font-size: 14px;
    }
    .dashboard-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ğŸ¢</div>
    <h1>×—×™×‘×•×¨ Google Business Profile</h1>
    <p class="subtitle">
      ×—×‘×¨ ××ª ×¤×¨×•×¤×™×œ ×”×¢×¡×§ ×©×œ×š ×‘-Google ×›×“×™ ×œ× ×”×œ ×‘×™×§×•×¨×•×ª ×•×œ×¢×“×›×Ÿ ××ª ×”×¤×¨×•×¤×™×œ ×‘××•×¤×Ÿ ××•×˜×•××˜×™
    </p>

    ${success ? `
      <div class="success-container">
        <div class="success-icon">âœ…</div>
        <div class="success-title">×”×—×™×‘×•×¨ ×”×¦×œ×™×—!</div>
        <div class="success-detail">
          ×”×¢×¡×§ <span class="business-name">${locationName || accountName || '×©×œ×š'}</span> ××—×•×‘×¨ ×›×¢×ª
        </div>
      </div>
      <a href="/dashboard" class="dashboard-link">×—×–×¨×” ×œ×œ×•×— ×”×‘×§×¨×”</a>
    ` : error ? `
      <div class="error-container">
        <div class="error-icon">âŒ</div>
        <div class="error-title">×”×—×™×‘×•×¨ × ×›×©×œ</div>
        <div class="error-detail">${getErrorMessage(error)}</div>
        <button class="retry-btn" onclick="window.location.href='/connect/google'">× ×¡×” ×©×•×‘</button>
      </div>
      <div class="info-box">
        <strong>×˜×™×¤×™× ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª:</strong><br>
        â€¢ ×•×“× ×©×™×© ×œ×š ×—×©×‘×•×Ÿ Google Business Profile ×¤×¢×™×œ<br>
        â€¢ ×‘×“×•×§ ×©××ª×” ××—×•×‘×¨ ×œ×—×©×‘×•×Ÿ Google ×”× ×›×•×Ÿ<br>
        â€¢ × ×¡×” ×œ× ×§×•×ª ××ª ×”×§×•×§×™×– ×•×œ×”×ª×—×‘×¨ ××—×“×©
      </div>
    ` : `
      <button class="connect-btn" id="connectBtn" onclick="startGoogleOAuth()">
        <svg class="google-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        ×—×‘×¨ ××ª Google Business Profile
      </button>

      <div class="info-box">
        <strong>××” ×™×§×¨×”?</strong><br>
        ×ª×•×¢×‘×¨ ×œ×“×£ ×”×”×ª×—×‘×¨×•×ª ×©×œ Google ×œ××™×©×•×¨ ×”×’×™×©×” ×œ×¤×¨×•×¤×™×œ ×”×¢×¡×§×™ ×©×œ×š.
        Findo ×™×•×›×œ ×œ×§×¨×•× ×•×œ×”×’×™×‘ ×œ×‘×™×§×•×¨×•×ª ×‘×©××š.
      </div>
    `}
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">××ª×—×‘×¨ ×œ-Google...</div>
  </div>

  <script src="/js/google-connect.js"></script>
</body>
</html>`;
}

function getErrorMessage(error: string): string {
  const errorMessages: Record<string, string> = {
    'access_denied': '×”×’×™×©×” × ×“×—×ª×”. ×× × ××©×¨ ××ª ×”×”×¨×©××•×ª ×”× ×“×¨×©×•×ª.',
    'missing_params': '×—×¡×¨×™× ×¤×¨××˜×¨×™× ×‘×ª×’×•×‘×” ×-Google.',
    'No Google Business Profile accounts found': '×œ× × ××¦××• ×¤×¨×•×¤×™×œ×™× ×¢×¡×§×™×™× ×‘×—×©×‘×•×Ÿ ×–×”.',
    'No locations found for this Google Business account': '×œ× × ××¦××• ××™×§×•××™× ×‘×¤×¨×•×¤×™×œ ×”×¢×¡×§×™.',
    'Google OAuth not configured': '×—×™×‘×•×¨ Google ××™× ×• ××•×’×“×¨ ×‘××¢×¨×›×ª.',
  };

  return errorMessages[error] || `×©×’×™××”: ${error}`;
}
```

Update `src/views/index.ts` to export the new view:
```typescript
export { renderWhatsAppConnectPage } from './whatsapp-connect';
export { renderGoogleConnectPage } from './google-connect';
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- renderGoogleConnectPage exported from src/views/index.ts
- HTML renders correctly with Hebrew RTL layout
  </verify>
  <done>
- Google connect page with Connect button
- Success state showing business name
- Error state with Hebrew error messages
- RTL Hebrew layout matching WhatsApp pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side JavaScript for OAuth redirect</name>
  <files>public/js/google-connect.js, src/routes/pages.ts</files>
  <action>
Create client-side OAuth handling:

1. Create `public/js/google-connect.js`:

```javascript
// Google OAuth redirect handling

async function startGoogleOAuth() {
  const connectBtn = document.getElementById('connectBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');

  // Disable button and show loading
  connectBtn.disabled = true;
  loadingOverlay.classList.add('active');

  try {
    // Get auth URL from backend
    const response = await fetch('/api/google/auth', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', // Include cookies for tenant context
    });

    const data = await response.json();

    if (data.error) {
      throw new Error(data.error);
    }

    if (!data.authUrl) {
      throw new Error('No auth URL received');
    }

    // Redirect to Google OAuth
    window.location.href = data.authUrl;

  } catch (error) {
    console.error('Failed to start Google OAuth:', error);
    loadingOverlay.classList.remove('active');
    connectBtn.disabled = false;

    // Show error to user
    alert('×©×’×™××” ×‘×”×ª×—×œ×ª ×ª×”×œ×™×š ×”×—×™×‘×•×¨: ' + error.message);
  }
}

// Check if page loaded with success/error from callback
document.addEventListener('DOMContentLoaded', function() {
  // URL params are handled server-side in the view render
  // This script just handles the OAuth initiation
});
```

2. Update `src/routes/pages.ts` to add Google connect route:

Add import at top:
```typescript
import { renderGoogleConnectPage } from '../views/index';
```

Add route (after WhatsApp route):
```typescript
// GET /connect/google - Google connection page
pagesRoutes.get('/connect/google', async (c) => {
  // Parse query params for success/error states
  const success = c.req.query('success') === 'true';
  const error = c.req.query('error');
  const accountName = c.req.query('account');
  const locationName = c.req.query('location');

  // Decode location name if present (may be URL encoded)
  const decodedLocation = locationName ? decodeURIComponent(locationName) : undefined;

  const html = renderGoogleConnectPage({
    success,
    error: error ? decodeURIComponent(error) : undefined,
    accountName: accountName ? decodeURIComponent(accountName) : undefined,
    locationName: decodedLocation,
  });

  return c.html(html);
});
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Server starts: `npm run dev`
- GET /connect/google returns HTML page
- public/js/google-connect.js is served correctly
  </verify>
  <done>
- Client-side script initiates OAuth by fetching auth URL from backend
- Loading overlay shown during redirect
- Error handling with Hebrew user messages
- Route registered at /connect/google
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Google OAuth connection flow with:
    - /connect/google page with Connect button
    - OAuth redirect to Google
    - Callback handling with success/error states
    - Token storage in vault
    - Connection record creation
  </what-built>
  <how-to-verify>
    1. Start the server: `npm run dev`
    2. Navigate to http://localhost:3000/connect/google
    3. Verify Hebrew UI displays correctly (RTL layout)
    4. Click "Connect Google Business Profile" button
    5. Should redirect to Google OAuth consent screen
    6. Complete OAuth flow (select a Google account with GBP)
    7. Should redirect back to /connect/google?success=true with business name shown

    **If Google credentials not configured:**
    - Should show error message when clicking Connect
    - Error should be in Hebrew

    **Test error state:**
    - Visit /connect/google?error=test_error
    - Should display error container with troubleshooting tips
  </how-to-verify>
  <resume-signal>Type "approved" if OAuth flow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. /connect/google page renders with Hebrew UI
2. Connect button initiates OAuth flow
3. OAuth callback redirects with success/error
4. Success state shows connected business name
5. Error state shows Hebrew error message with retry button
</verification>

<success_criteria>
- User can complete full OAuth flow from UI
- Success page displays connected business name
- Error handling provides clear guidance in Hebrew
- UI matches WhatsApp connection page style
</success_criteria>

<output>
After completion, create `.planning/phases/04-google-integration/04-04-SUMMARY.md`
</output>
