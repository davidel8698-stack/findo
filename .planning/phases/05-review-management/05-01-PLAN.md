---
phase: 05-review-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/reviews.ts
  - src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Review tracking table exists with all required fields"
    - "Poll state table tracks last poll timestamp per tenant"
    - "Database migration runs without errors"
  artifacts:
    - path: "src/db/schema/reviews.ts"
      provides: "processedReviews and reviewPollState tables"
      exports: ["processedReviews", "reviewPollState", "reviewStatusEnum"]
    - path: "src/db/schema/index.ts"
      provides: "Re-exports reviews schema"
      contains: "export * from './reviews'"
  key_links:
    - from: "src/db/schema/reviews.ts"
      to: "src/db/schema/tenants.ts"
      via: "foreign key reference"
      pattern: "references.*tenants"
    - from: "src/db/schema/reviews.ts"
      to: "src/db/schema/google.ts"
      via: "foreign key reference"
      pattern: "references.*googleConnections"
---

<objective>
Create database schema for review tracking and poll state management.

Purpose: Track processed reviews, their status through the lifecycle, and maintain per-tenant poll timestamps for new review detection.
Output: Two new tables (processed_reviews, review_poll_state) with proper indexes and foreign keys.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-review-management/05-RESEARCH.md

# Existing schema patterns
@src/db/schema/leads.ts
@src/db/schema/google.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reviews schema with review lifecycle tracking</name>
  <files>src/db/schema/reviews.ts</files>
  <action>
Create new schema file with two tables:

1. **reviewStatusEnum** - Review lifecycle states:
   - 'detected' (new review found)
   - 'auto_replied' (positive: AI reply posted)
   - 'pending_approval' (negative: awaiting owner)
   - 'reminded' (48h reminder sent)
   - 'approved' (owner approved draft)
   - 'edited' (owner provided custom reply)
   - 'replied' (final reply posted)
   - 'expired' (48h after reminder, draft auto-posted)

2. **processedReviews** table:
   - id: uuid primary key
   - tenantId: uuid FK to tenants (cascade delete)
   - googleConnectionId: uuid FK to googleConnections
   - reviewId: varchar(255) - Google's review ID
   - reviewName: varchar(512) - Full resource name from Google
   - reviewerName: varchar(255)
   - starRating: integer (1-5)
   - comment: text (nullable for rating-only reviews)
   - reviewCreateTime: timestamp with timezone
   - reviewUpdateTime: timestamp with timezone
   - status: reviewStatusEnum default 'detected'
   - isPositive: integer (1 = positive 4-5 or positive 3, 0 = negative)
   - draftReply: text
   - draftTone: varchar(20) - 'warm', 'apologetic', 'neutral'
   - postedReply: text
   - repliedAt: timestamp with timezone
   - approvalMessageId: varchar(255) - WhatsApp message ID
   - approvalSentAt: timestamp with timezone
   - reminderSentAt: timestamp with timezone
   - ownerResponse: text - If edited, what owner typed
   - detectedAt: timestamp with timezone default now
   - updatedAt: timestamp with timezone default now

   Indexes:
   - UNIQUE composite on (tenantId, reviewId) to prevent duplicates
   - Index on status for finding pending approvals
   - Index on approvalSentAt for reminder queries

3. **reviewPollState** table:
   - tenantId: uuid PRIMARY KEY FK to tenants (cascade delete)
   - lastPollAt: timestamp with timezone default now
   - lastReviewUpdateTime: timestamp with timezone (nullable)

Follow existing schema patterns from leads.ts and google.ts.
Use pgEnum for status enum (same pattern as lead_status).
  </action>
  <verify>
Run `npx drizzle-kit generate` and verify migration file is created without errors.
Check the generated SQL includes both tables with all fields.
  </verify>
  <done>
reviews.ts exists with processedReviews table, reviewPollState table, reviewStatusEnum, and proper indexes.
Generated migration includes both tables with foreign keys and unique constraint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export reviews schema and run migration</name>
  <files>src/db/schema/index.ts</files>
  <action>
1. Add export for reviews schema:
   `export * from './reviews';`

2. Run migration to create tables:
   `npx drizzle-kit push`

3. Verify tables exist in database by checking drizzle-kit output.
  </action>
  <verify>
Run `npx drizzle-kit push` and verify both tables are created.
Check that index.ts exports all review-related types.
  </verify>
  <done>
Schema index exports reviews module.
Database has processed_reviews and review_poll_state tables.
TypeScript types (ProcessedReview, ReviewPollState) are importable from schema.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "processedReviews" src/db/schema/` returns reviews.ts
2. `grep -r "reviewPollState" src/db/schema/` returns reviews.ts
3. `grep "reviews" src/db/schema/index.ts` shows export statement
4. Database tables exist (drizzle-kit push succeeded)
</verification>

<success_criteria>
- processedReviews table has all fields for review lifecycle tracking
- reviewPollState table tracks per-tenant poll timestamps
- Both tables have proper foreign keys to tenants and googleConnections
- Unique constraint on (tenantId, reviewId) prevents duplicate processing
- Migration runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-management/05-01-SUMMARY.md`
</output>
