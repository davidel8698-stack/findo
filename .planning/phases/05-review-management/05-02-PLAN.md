---
phase: 05-review-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/review-management/reply-generator.ts
  - src/services/review-management/index.ts
autonomous: true

must_haves:
  truths:
    - "AI generates personalized Hebrew replies referencing review content"
    - "Positive reviews get warm thank-you replies"
    - "Negative reviews get appropriate draft responses"
    - "3-star reviews are classified by sentiment"
  artifacts:
    - path: "src/services/review-management/reply-generator.ts"
      provides: "AI reply generation using Claude"
      exports: ["generateReviewReply", "classifyReviewSentiment"]
    - path: "src/services/review-management/index.ts"
      provides: "Service barrel export"
      exports: ["generateReviewReply", "classifyReviewSentiment"]
  key_links:
    - from: "src/services/review-management/reply-generator.ts"
      to: "@anthropic-ai/sdk"
      via: "import"
      pattern: "import Anthropic from '@anthropic-ai/sdk'"
---

<objective>
Create AI reply generation service using Claude Haiku 4.5.

Purpose: Generate personalized Hebrew replies to Google reviews that feel like the business owner wrote them - warm, personal, referencing specific content from the review.
Output: Reply generator service with structured outputs for consistent reply format.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-review-management/05-CONTEXT.md
@.planning/phases/05-review-management/05-RESEARCH.md

# Existing AI pattern
@src/services/lead-capture/intent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reply generator with Claude structured outputs</name>
  <files>src/services/review-management/reply-generator.ts</files>
  <action>
Create new service file for AI reply generation.

1. **Interface ReviewReplyResult:**
   ```typescript
   interface ReviewReplyResult {
     replyText: string;      // Hebrew reply text
     tone: 'warm' | 'apologetic' | 'neutral';
     referencedContent: string;  // What from review was referenced
   }
   ```

2. **generateReviewReply function:**
   - Parameters: review (reviewerName, comment, starRating), businessName, isPositive
   - Use Claude Haiku 4.5 (claude-haiku-4-5-20251001) with structured outputs beta
   - System prompt requirements per CONTEXT.md:
     * Write in Hebrew
     * 1-2 sentences maximum (short replies)
     * Warm & personal tone, NOT corporate
     * Reference something specific from the review (what they mentioned)
     * No emojis
     * Sign as the business (not "the team")
   - For positive: thank you + invitation to return
   - For negative: Claude's discretion on apologetic vs neutral based on content
   - Use max_tokens: 512 to limit length
   - Validate output: Buffer.byteLength(replyText, 'utf8') <= 4096

3. **classifyReviewSentiment function:**
   - For 3-star edge case classification
   - Parameters: comment (string | undefined), starRating
   - If starRating >= 4: return true (positive)
   - If starRating <= 2: return false (negative)
   - If 3 stars with no comment: return false (safer to alert owner)
   - If 3 stars with comment: ask Claude to classify sentiment
   - Return boolean (true = positive, false = negative)

Use same Anthropic client initialization pattern as intent.ts.
Handle errors gracefully - return fallback reply on AI failure.

Fallback replies:
- Positive: "תודה רבה על הביקורת החיובית! נשמח לראותך שוב."
- Negative: "תודה על הביקורת. אנו לוקחים את המשוב שלך ברצינות ונשמח לדבר איתך."
  </action>
  <verify>
TypeScript compiles without errors.
Functions are exported and types are correct.
  </verify>
  <done>
reply-generator.ts has generateReviewReply and classifyReviewSentiment functions.
Uses Claude Haiku 4.5 with structured outputs.
Handles 3-star edge case with sentiment classification.
Has fallback replies for AI failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create service barrel export</name>
  <files>src/services/review-management/index.ts</files>
  <action>
Create barrel export file for the review-management service:

```typescript
// Review management service exports
export * from './reply-generator';
```

This follows the pattern from src/services/whatsapp/index.ts.
  </action>
  <verify>
Import from '@/services/review-management' works.
generateReviewReply and classifyReviewSentiment are importable.
  </verify>
  <done>
index.ts exists and re-exports reply-generator module.
Service is importable from 'src/services/review-management'.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Reply generator uses claude-haiku-4-5-20251001 model
3. Structured output format is correct for Claude beta
4. Fallback replies are in Hebrew
5. 3-star classification logic is correct
</verification>

<success_criteria>
- generateReviewReply generates personalized Hebrew replies
- Replies are warm, personal, reference review content
- 3-star reviews are classified by sentiment analysis
- Reply byte length is validated before returning
- Fallback replies work when AI fails
- Service is properly exported
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-management/05-02-SUMMARY.md`
</output>
