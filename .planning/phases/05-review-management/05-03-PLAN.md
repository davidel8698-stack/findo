---
phase: 05-review-management
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/queue/workers/review-poll.worker.ts
  - src/services/review-management/index.ts
  - src/queue/index.ts
autonomous: true

must_haves:
  truths:
    - "Worker processes review-check job from scheduler"
    - "New reviews are detected by comparing with processed_reviews table"
    - "Positive reviews get auto-replied immediately"
    - "Review state is tracked in database"
  artifacts:
    - path: "src/queue/workers/review-poll.worker.ts"
      provides: "Hourly review polling worker"
      exports: ["startReviewPollWorker"]
    - path: "src/services/review-management/index.ts"
      provides: "processNewReview orchestration function"
      exports: ["processNewReview", "detectNewReviews"]
  key_links:
    - from: "src/queue/workers/review-poll.worker.ts"
      to: "src/services/google/reviews.ts"
      via: "listReviews import"
      pattern: "import.*listReviews.*from.*google/reviews"
    - from: "src/queue/workers/review-poll.worker.ts"
      to: "src/services/review-management"
      via: "processNewReview import"
      pattern: "import.*processNewReview.*from.*review-management"
---

<objective>
Implement hourly review polling and auto-reply for positive reviews.

Purpose: Detect new Google reviews within 1 hour of posting and auto-reply to positive reviews (4-5 stars) immediately. Negative reviews trigger next phase (approval flow).
Output: Review poll worker that processes the existing 'review-check' scheduled job.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-review-management/05-RESEARCH.md

# Existing patterns
@src/scheduler/jobs.ts
@src/services/google/reviews.ts
@src/queue/workers/voicenter-cdr.worker.ts
@src/db/schema/google.ts

# From this phase
@.planning/phases/05-review-management/05-01-SUMMARY.md
@.planning/phases/05-review-management/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review management orchestration functions</name>
  <files>src/services/review-management/index.ts</files>
  <action>
Extend the index.ts to add orchestration functions:

1. **detectNewReviews function:**
   - Parameters: tenantId, googleConnection
   - Get lastPollAt from reviewPollState (or use 24h ago if none)
   - Call listReviews with orderBy: 'updateTime desc', pageSize: 50
   - Filter to reviews where:
     * updateTime > lastPollAt
     * No existing entry in processedReviews for this reviewId
     * No reply exists (review.reply is undefined)
   - Update reviewPollState.lastPollAt to now
   - Return array of new reviews

2. **processNewReview function:**
   - Parameters: tenantId, googleConnectionId, review (from Google API)
   - Classify sentiment using classifyReviewSentiment (for 3-star edge case)
   - Generate reply using generateReviewReply
   - Insert into processedReviews table with status 'detected'
   - If isPositive:
     * Post reply via postReviewReply (from google/reviews.ts)
     * Update status to 'auto_replied', set postedReply and repliedAt
     * Create activity event 'review.auto_replied'
   - If negative:
     * Update status to 'pending_approval'
     * Return review ID for approval flow (next plan)
   - Handle errors gracefully - log but don't crash

3. **Helper: getGoogleConnectionDetails:**
   - Get accountId, locationId from googleConnection
   - Needed for postReviewReply call

Import db, eq from drizzle.
Import processedReviews, reviewPollState from schema.
Import postReviewReply, listReviews from google/reviews.
Import activityQueue from queue/queues.
  </action>
  <verify>
TypeScript compiles without errors.
Functions handle positive reviews end-to-end.
  </verify>
  <done>
detectNewReviews filters to unprocessed, unreplied reviews.
processNewReview classifies, generates reply, and auto-posts for positive.
Database is updated with review status and reply.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create review poll worker</name>
  <files>src/queue/workers/review-poll.worker.ts</files>
  <action>
Create worker that processes the existing 'review-check' scheduled job:

1. **Worker setup:**
   - Listen on 'scheduled' queue (same as token refresh workers)
   - Filter to job.name === 'review-check'
   - Single concurrency (respect API rate limits)

2. **Processing logic:**
   - Get all active Google connections: `where: eq(googleConnections.status, 'active')`
   - For each connection with locationId:
     * Call detectNewReviews
     * For each new review, call processNewReview
     * Log count of processed reviews
     * Sleep 100ms between tenants (rate limit protection)
   - Skip connections without locationId (not fully set up)

3. **Error handling:**
   - Wrap tenant processing in try/catch
   - Log errors but continue with other tenants
   - Don't fail entire job for single tenant failure

4. **Logging:**
   - Log start: "[review-poll] Starting hourly review check"
   - Log tenant count: "[review-poll] Checking N tenants"
   - Log per tenant: "[review-poll] Processed N new reviews for tenant X"
   - Log completion: "[review-poll] Completed hourly review check"

Follow pattern from voicenter-cdr.worker.ts for queue filtering.
  </action>
  <verify>
Worker starts without errors.
Filter correctly identifies 'review-check' jobs.
Rate limiting with 100ms delay between tenants.
  </verify>
  <done>
review-poll.worker.ts processes review-check jobs.
Iterates all active Google connections.
Calls detectNewReviews and processNewReview for each.
Handles errors per-tenant without failing entire job.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register worker in queue index</name>
  <files>src/queue/index.ts</files>
  <action>
Add review poll worker to the worker initialization:

1. Import startReviewPollWorker from './workers/review-poll.worker'

2. In the worker initialization section, add:
   ```typescript
   startReviewPollWorker();
   ```

This follows the existing pattern for other workers in the file.
  </action>
  <verify>
Worker is started when application boots.
No duplicate worker registrations.
  </verify>
  <done>
Review poll worker is imported and started in queue/index.ts.
Worker processes review-check jobs on application startup.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Worker listens on 'scheduled' queue and filters to 'review-check'
3. detectNewReviews correctly filters already-processed reviews
4. processNewReview posts reply for positive reviews
5. Database is updated with auto_replied status
6. Activity event is created for auto-replies
</verification>

<success_criteria>
- Review poll worker processes hourly review-check jobs
- New reviews are detected by comparing Google API vs database
- Positive reviews (4-5 stars, positive 3-stars) get auto-replied
- Reply is posted to Google and recorded in database
- Status transitions: detected -> auto_replied (positive)
- Negative reviews stay in pending_approval for next plan
- Error handling prevents single tenant failures from crashing job
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-management/05-03-SUMMARY.md`
</output>
