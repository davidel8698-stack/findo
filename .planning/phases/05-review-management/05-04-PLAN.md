---
phase: 05-review-management
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/services/review-management/approval-flow.ts
  - src/services/whatsapp/messages.ts
  - src/services/review-management/index.ts
autonomous: true

must_haves:
  truths:
    - "Owner receives WhatsApp notification with review details and draft reply"
    - "Notification includes interactive approve/edit buttons"
    - "Notification is sent within 24-hour session window OR uses template"
  artifacts:
    - path: "src/services/review-management/approval-flow.ts"
      provides: "Owner notification and approval tracking"
      exports: ["sendApprovalRequest", "checkAndSendApproval"]
    - path: "src/services/whatsapp/messages.ts"
      provides: "Interactive button message function"
      exports: ["sendInteractiveButtons"]
  key_links:
    - from: "src/services/review-management/approval-flow.ts"
      to: "src/services/whatsapp/messages.ts"
      via: "sendInteractiveButtons import"
      pattern: "import.*sendInteractiveButtons.*from.*whatsapp/messages"
    - from: "src/services/review-management/approval-flow.ts"
      to: "src/db/schema/reviews.ts"
      via: "processedReviews update"
      pattern: "processedReviews"
---

<objective>
Implement owner notification flow for negative reviews with WhatsApp interactive buttons.

Purpose: Alert business owners when negative reviews (1-3 stars) are received, showing them the review content and a suggested draft reply. Owner can approve or request to edit the response.
Output: Approval flow service and interactive button messaging capability.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-review-management/05-CONTEXT.md
@.planning/phases/05-review-management/05-RESEARCH.md

# Existing patterns
@src/services/whatsapp/messages.ts
@src/services/lead-capture/notifications.ts
@src/services/whatsapp/conversations.ts

# From this phase
@.planning/phases/05-review-management/05-01-SUMMARY.md
@.planning/phases/05-review-management/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add interactive button message function</name>
  <files>src/services/whatsapp/messages.ts</files>
  <action>
Add new function for sending WhatsApp interactive button messages:

**sendInteractiveButtons function:**
```typescript
export interface InteractiveButton {
  id: string;      // Button callback ID (max 256 chars)
  title: string;   // Button text (max 20 chars)
}

export async function sendInteractiveButtons(
  client: WhatsAppClient,
  to: string,
  bodyText: string,
  buttons: InteractiveButton[],
  headerText?: string,
  footerText?: string
): Promise<MessageSendResult>
```

Implementation:
- Construct interactive message payload per WhatsApp Cloud API spec
- Type: 'interactive'
- Interactive type: 'button'
- Map buttons to: `{ type: 'reply', reply: { id, title } }`
- Max 3 buttons per message
- Body text max 1024 chars

Payload structure:
```typescript
{
  messaging_product: 'whatsapp',
  recipient_type: 'individual',
  to,
  type: 'interactive',
  interactive: {
    type: 'button',
    header: headerText ? { type: 'text', text: headerText } : undefined,
    body: { text: bodyText },
    footer: footerText ? { text: footerText } : undefined,
    action: {
      buttons: buttons.map(b => ({
        type: 'reply',
        reply: { id: b.id, title: b.title }
      }))
    }
  }
}
```

Follow existing patterns in messages.ts.
Add proper JSDoc documentation.
  </action>
  <verify>
TypeScript compiles without errors.
Function signature matches WhatsApp Cloud API requirements.
  </verify>
  <done>
sendInteractiveButtons is exported from messages.ts.
Constructs correct WhatsApp interactive message payload.
Supports header, body, footer, and up to 3 buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create approval flow service</name>
  <files>src/services/review-management/approval-flow.ts</files>
  <action>
Create service for managing the owner approval flow:

1. **sendApprovalRequest function:**
   - Parameters: tenantId, processedReviewId
   - Load processedReview from database
   - Get tenant.ownerPhone for notification
   - Check if window is open using existing isWindowOpen helper
   - Build notification message in Hebrew:
     ```
     ביקורת חדשה ({starRating} כוכבים)

     {reviewerName}: "{comment or 'ללא טקסט'}"

     תשובה מוצעת:
     "{draftReply}"
     ```
   - Create WhatsApp client
   - If window open: send interactive buttons with:
     * Button 1: id=`approve_${reviewId}`, title="אשר ושלח"
     * Button 2: id=`edit_${reviewId}`, title="רוצה לערוך"
   - If window closed: send text message with instructions:
     "השב 'אשר' לאישור, או כתוב את התשובה שלך"
   - Update processedReview:
     * approvalMessageId = message ID
     * approvalSentAt = now
   - Log success/failure

2. **checkAndSendApproval function:**
   - Called from processNewReview when review is negative
   - Parameters: tenantId, processedReviewId
   - Simply calls sendApprovalRequest
   - Used as integration point

3. **Helper: getOwnerConversationWindow:**
   - Get latest conversation with tenant.ownerPhone
   - Return windowExpiresAt or null if no conversation

Use createWhatsAppClient from services/whatsapp.
Import sendInteractiveButtons and sendTextMessage from whatsapp/messages.
Import isWindowOpen from whatsapp/messages.
Import db, eq from drizzle.
Import processedReviews, tenants from schema.
  </action>
  <verify>
TypeScript compiles without errors.
Function handles both window-open and window-closed scenarios.
Database is updated with approval tracking fields.
  </verify>
  <done>
sendApprovalRequest sends notification to owner.
Uses interactive buttons when session active.
Falls back to text instructions when session expired.
Updates processedReview with approvalMessageId and approvalSentAt.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export approval flow and integrate with processNewReview</name>
  <files>src/services/review-management/index.ts</files>
  <action>
1. Add export for approval-flow:
   `export * from './approval-flow';`

2. Update processNewReview to call approval flow for negative reviews:
   - After inserting processedReview with status 'pending_approval'
   - Call checkAndSendApproval(tenantId, processedReviewId)
   - Create activity event 'review.approval_requested'

This connects the poll worker (Plan 03) to the approval flow.
  </action>
  <verify>
processNewReview triggers approval flow for negative reviews.
Activity event is created.
  </verify>
  <done>
index.ts exports approval-flow module.
processNewReview calls checkAndSendApproval for negative reviews.
Full flow: detect -> generate reply -> notify owner (for negative).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. sendInteractiveButtons constructs valid WhatsApp payload
3. sendApprovalRequest sends notification with Hebrew text
4. Button IDs follow approve_{reviewId} and edit_{reviewId} pattern
5. Fallback text message includes Hebrew instructions
6. processedReview is updated with approval tracking fields
</verification>

<success_criteria>
- Owner receives WhatsApp notification for negative reviews
- Notification shows full review text, rating, and draft reply
- Interactive buttons work within 24-hour session
- Text fallback works outside session window
- Approval tracking fields (messageId, sentAt) are recorded
- Activity event created for audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-management/05-04-SUMMARY.md`
</output>
