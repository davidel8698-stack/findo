---
phase: 05-review-management
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - src/services/review-management/response-handler.ts
  - src/queue/workers/whatsapp-message.worker.ts
  - src/services/review-management/index.ts
autonomous: true

must_haves:
  truths:
    - "Owner button clicks are detected and processed"
    - "Approve posts the draft reply to Google"
    - "Edit prompts owner for custom reply"
    - "Owner text responses are captured as edited replies"
  artifacts:
    - path: "src/services/review-management/response-handler.ts"
      provides: "Owner response processing"
      exports: ["handleOwnerReviewResponse", "approveReviewReply", "submitEditedReply"]
    - path: "src/queue/workers/whatsapp-message.worker.ts"
      provides: "Integration with review response handling"
      contains: "handleOwnerReviewResponse"
  key_links:
    - from: "src/services/review-management/response-handler.ts"
      to: "src/services/google/reviews.ts"
      via: "postReviewReply import"
      pattern: "import.*postReviewReply.*from.*google/reviews"
    - from: "src/queue/workers/whatsapp-message.worker.ts"
      to: "src/services/review-management"
      via: "handleOwnerReviewResponse import"
      pattern: "import.*handleOwnerReviewResponse.*from.*review-management"
---

<objective>
Implement owner response handling for review approval workflow.

Purpose: Process owner's approval or edit of negative review responses. Handle both interactive button clicks and text message responses (for when buttons aren't available).
Output: Response handler integrated into WhatsApp message worker.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-review-management/05-CONTEXT.md

# Existing patterns
@src/queue/workers/whatsapp-message.worker.ts
@src/services/lead-capture/notifications.ts

# From this phase
@.planning/phases/05-review-management/05-03-SUMMARY.md
@.planning/phases/05-review-management/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create owner response handler service</name>
  <files>src/services/review-management/response-handler.ts</files>
  <action>
Create service for processing owner responses to review approvals:

1. **handleOwnerReviewResponse function:**
   - Parameters: tenantId, messageFrom, messageText, buttonId (optional)
   - Returns: boolean (true if handled, false if not a review response)

   Logic:
   - If buttonId starts with 'approve_': call approveReviewReply
   - If buttonId starts with 'edit_': call requestEditedReply
   - If messageText === 'אשר': find latest pending approval and approve
   - If has pending edit request: treat as edited reply submission
   - Otherwise return false (not a review response)

2. **approveReviewReply function:**
   - Parameters: tenantId, reviewId (from processedReviews)
   - Load processedReview, googleConnection
   - Post draftReply via postReviewReply
   - Update processedReview:
     * status = 'approved' -> 'replied'
     * postedReply = draftReply
     * repliedAt = now
   - Send confirmation to owner: "התשובה פורסמה בהצלחה!"
   - Create activity event 'review.replied'

3. **requestEditedReply function:**
   - Parameters: tenantId, reviewId
   - Update processedReview.status = 'edited' (marks as awaiting edit)
   - Send message: "אנא כתוב/י את התשובה שברצונך לפרסם:"
   - Store reviewId in temporary tracking (use ownerResponse field with 'AWAITING_EDIT:{reviewId}')

4. **submitEditedReply function:**
   - Parameters: tenantId, reviewId, editedText
   - Validate byte length <= 4096
   - Post editedText via postReviewReply
   - Update processedReview:
     * status = 'replied'
     * postedReply = editedText
     * ownerResponse = editedText
     * repliedAt = now
   - Send confirmation: "התשובה פורסמה בהצלחה!"
   - Create activity event 'review.replied'

5. **getPendingEditForOwner helper:**
   - Find processedReview where status = 'edited' and ownerResponse starts with 'AWAITING_EDIT:'
   - Match by tenantId and most recent approvalSentAt
   - Return reviewId or null

6. **getLatestPendingApproval helper:**
   - Find processedReview where status = 'pending_approval' or 'reminded'
   - Match by tenantId, order by approvalSentAt desc
   - Return record or null
  </action>
  <verify>
TypeScript compiles without errors.
All three response paths work (button approve, button edit, text approve).
  </verify>
  <done>
response-handler.ts handles all owner response scenarios.
approveReviewReply posts draft to Google.
submitEditedReply posts owner's custom text.
Pending edit tracking uses ownerResponse field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate response handler into WhatsApp message worker</name>
  <files>src/queue/workers/whatsapp-message.worker.ts</files>
  <action>
Modify the whatsapp-message worker to detect and handle owner review responses:

1. **Add import:**
   ```typescript
   import { handleOwnerReviewResponse } from '../../services/review-management';
   ```

2. **After lead conversation handling, before saving message:**
   Add check for owner review response:
   ```typescript
   // Check if this is an owner review response
   const isOwner = message.from === tenant?.ownerPhone;
   if (isOwner) {
     // Extract button ID from interactive response (if any)
     const buttonId = message.buttonId; // Need to parse from webhook
     const handled = await handleOwnerReviewResponse(
       tenantId,
       message.from,
       message.text || '',
       buttonId
     );
     if (handled) {
       console.log('[whatsapp-message] Processed as owner review response');
       // Still save message but skip other processing
     }
   }
   ```

3. **Parse interactive button responses:**
   The webhook parser (webhooks.ts) needs to extract button_reply.id from interactive messages.
   Check if ParsedMessage interface has buttonId field.
   If not, add parsing in processWhatsAppMessages to extract it from webhook payload.

4. **Load tenant for ownerPhone check:**
   Ensure tenant is loaded early in message processing (may already exist from lead conversation).
  </action>
  <verify>
Worker correctly identifies owner messages.
Button clicks are parsed and passed to handler.
Text commands ('אשר') are handled.
  </verify>
  <done>
Worker imports and calls handleOwnerReviewResponse for owner messages.
Button ID is extracted from interactive responses.
Owner review responses are processed before other handlers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export response handler from index</name>
  <files>src/services/review-management/index.ts</files>
  <action>
Add export for response-handler module:

```typescript
export * from './response-handler';
```

This makes handleOwnerReviewResponse importable from 'services/review-management'.
  </action>
  <verify>
handleOwnerReviewResponse is importable from services/review-management.
  </verify>
  <done>
index.ts exports response-handler module.
All response handler functions are accessible.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Button click with approve_{id} triggers approveReviewReply
3. Button click with edit_{id} triggers requestEditedReply
4. Text "אשר" approves latest pending review
5. Reply is posted to Google and confirmed to owner
6. Activity events created for audit trail
</verification>

<success_criteria>
- Owner button clicks (approve/edit) are detected from webhook
- Approve posts draft reply to Google immediately
- Edit prompts owner and waits for custom reply
- Custom reply is validated and posted to Google
- Owner receives Hebrew confirmation after posting
- Status transitions: pending_approval -> approved -> replied
- Status transitions: pending_approval -> edited -> replied
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-management/05-05-SUMMARY.md`
</output>
