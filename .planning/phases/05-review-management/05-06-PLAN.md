---
phase: 05-review-management
plan: 06
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - src/queue/workers/review-reminder.worker.ts
  - src/scheduler/jobs.ts
  - src/queue/index.ts
autonomous: true

must_haves:
  truths:
    - "48h reminder is sent if owner hasn't responded"
    - "48h after reminder, draft is auto-posted if still no response"
    - "Reminder and auto-post jobs run hourly"
  artifacts:
    - path: "src/queue/workers/review-reminder.worker.ts"
      provides: "Reminder and auto-post worker"
      exports: ["startReviewReminderWorker"]
    - path: "src/scheduler/jobs.ts"
      provides: "review-reminder job registration"
      contains: "review-reminder"
  key_links:
    - from: "src/queue/workers/review-reminder.worker.ts"
      to: "src/db/schema/reviews.ts"
      via: "processedReviews query"
      pattern: "processedReviews"
    - from: "src/queue/workers/review-reminder.worker.ts"
      to: "src/services/google/reviews.ts"
      via: "postReviewReply for auto-post"
      pattern: "postReviewReply"
---

<objective>
Implement 48-hour reminder and auto-post system for pending review approvals.

Purpose: Per CONTEXT.md, if owner doesn't respond within 48h, send a reminder. If still no response 48h after reminder, auto-post the draft reply. This ensures negative reviews always get a response.
Output: Review reminder worker processing hourly reminder/auto-post jobs.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-review-management/05-CONTEXT.md

# Existing patterns
@src/scheduler/jobs.ts
@src/queue/workers/lead-reminder.worker.ts

# From this phase
@.planning/phases/05-review-management/05-03-SUMMARY.md
@.planning/phases/05-review-management/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review reminder worker</name>
  <files>src/queue/workers/review-reminder.worker.ts</files>
  <action>
Create worker for handling review reminder and auto-post logic:

1. **Worker setup:**
   - Listen on 'scheduled' queue
   - Filter to job.name === 'review-reminder'
   - Single concurrency

2. **sendReminders function:**
   - Query processedReviews where:
     * status = 'pending_approval'
     * approvalSentAt < now - 48 hours
     * reminderSentAt is NULL
   - For each:
     * Send reminder via WhatsApp (text or interactive)
     * Message: "תזכורת: ממתינה תשובה לביקורת ({starRating} כוכבים)\n\n{short preview of review}"
     * Include same approve/edit buttons if session active
     * Update status = 'reminded', reminderSentAt = now
     * Create activity event 'review.reminder_sent'
   - Rate limit: 100ms between tenants

3. **autoPostExpired function:**
   - Query processedReviews where:
     * status = 'reminded'
     * reminderSentAt < now - 48 hours
   - For each:
     * Post draftReply via postReviewReply
     * Update status = 'expired', postedReply = draftReply, repliedAt = now
     * Notify owner: "התשובה פורסמה אוטומטית לאחר 96 שעות"
     * Create activity event 'review.auto_posted'
   - Rate limit: 100ms between tenants

4. **Main processing:**
   - Call sendReminders()
   - Call autoPostExpired()
   - Log counts for each action

5. **Error handling:**
   - Wrap each review processing in try/catch
   - Log errors but continue with other reviews
   - Don't fail job for individual failures
  </action>
  <verify>
TypeScript compiles without errors.
Worker queries correct reviews based on timestamps.
  </verify>
  <done>
review-reminder.worker.ts processes reminders and auto-posts.
48h threshold correctly calculated for both phases.
Status transitions: pending_approval -> reminded -> expired.
Owner is notified of auto-posted replies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register review-reminder scheduled job</name>
  <files>src/scheduler/jobs.ts</files>
  <action>
Add the review-reminder job to scheduleRecurringJobs:

```typescript
/**
 * Review Reminder Job
 *
 * Runs every hour.
 * Checks for pending approvals older than 48h and sends reminders.
 * Auto-posts drafts for reviews reminded 48h+ ago.
 *
 * Per CONTEXT.md: 48h reminder if owner doesn't respond,
 * auto-post draft if still no response 48h after reminder.
 */
await scheduledQueue.add(
  'review-reminder',
  {
    jobType: 'review-reminder',
  } satisfies ScheduledJobData,
  {
    repeat: {
      pattern: '30 * * * *', // Every hour at minute 30 (offset from review-check at :00)
    },
    jobId: 'review-reminder-hourly',
  }
);
console.log('[scheduler] Registered: review-reminder (hourly)');
```

Place after the existing review-check job registration.
Use minute 30 to offset from review-check at minute 0.
  </action>
  <verify>
Job is added to scheduleRecurringJobs.
Pattern runs hourly at minute 30.
  </verify>
  <done>
review-reminder job registered in jobs.ts.
Runs hourly at minute 30.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register worker in queue index</name>
  <files>src/queue/index.ts</files>
  <action>
Add review reminder worker to the worker initialization:

1. Import startReviewReminderWorker from './workers/review-reminder.worker'

2. In the worker initialization section, add:
   ```typescript
   startReviewReminderWorker();
   ```

This follows the existing pattern for other workers.
  </action>
  <verify>
Worker is started when application boots.
  </verify>
  <done>
Review reminder worker is imported and started in queue/index.ts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Worker listens on 'scheduled' queue and filters to 'review-reminder'
3. sendReminders finds reviews 48h+ old with status pending_approval
4. autoPostExpired finds reviews 48h+ since reminder with status reminded
5. Both functions update status and notify owner
6. Job registered to run hourly at minute 30
</verification>

<success_criteria>
- Reviews waiting 48h get reminder via WhatsApp
- Reviews waiting 48h after reminder get draft auto-posted
- Owner is notified when auto-post happens
- Status transitions correctly through lifecycle
- Activity events created for audit trail
- Job runs hourly without failing for individual review errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-management/05-06-SUMMARY.md`
</output>
