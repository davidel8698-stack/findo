---
phase: 06-review-requests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/review-requests.ts
  - src/db/schema/index.ts
  - drizzle/0007_*.sql
autonomous: true

must_haves:
  truths:
    - "Review request records can be created and queried"
    - "Accounting connection credentials are stored encrypted"
    - "Duplicate invoice detection is prevented by unique constraint"
  artifacts:
    - path: "src/db/schema/review-requests.ts"
      provides: "reviewRequests and accountingConnections tables"
      contains: "reviewRequests"
    - path: "drizzle/0007_*.sql"
      provides: "Database migration for review request tables"
      contains: "CREATE TABLE"
  key_links:
    - from: "src/db/schema/review-requests.ts"
      to: "src/db/schema/index.ts"
      via: "export statement"
      pattern: "export.*review-requests"
---

<objective>
Create database schema for review request tracking and accounting provider connections.

Purpose: Foundation tables for invoice-triggered review requests with lifecycle tracking and encrypted credential storage for Greeninvoice/iCount.

Output: reviewRequests table (tracks review request lifecycle), accountingConnections table (stores provider credentials), and TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-review-requests/06-RESEARCH.md
@src/db/schema/reviews.ts
@src/db/schema/tenants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review requests and accounting connections schema</name>
  <files>src/db/schema/review-requests.ts</files>
  <action>
Create new schema file with two tables based on 06-RESEARCH.md schema design:

**reviewRequestStatusEnum** with 6 states:
- pending (invoice detected, waiting 24h)
- requested (initial WhatsApp sent)
- reminded (3-day reminder sent)
- completed (customer left review)
- stopped (no review after reminder, flow ended)
- skipped (no customer phone, could not send)

**reviewRequestSourceEnum** with 4 sources:
- greeninvoice (from Greeninvoice polling)
- icount (from iCount polling)
- manual (dashboard "Mark as service" button)
- forwarded (forwarded invoice to Findo via WhatsApp)

**reviewRequests table:**
- id: uuid primary key
- tenantId: uuid foreign key to tenants (cascade delete)
- source: reviewRequestSourceEnum
- invoiceId: varchar(255) nullable (provider's invoice ID)
- invoiceNumber: varchar(100) nullable
- customerPhone: varchar(20) nullable
- customerName: varchar(255) nullable
- customerEmail: varchar(255) nullable
- status: reviewRequestStatusEnum default 'pending'
- invoiceDetectedAt: timestamp with timezone, default now
- scheduledForAt: timestamp with timezone nullable (24h after detection)
- requestedAt: timestamp with timezone nullable (when initial request sent)
- reminderSentAt: timestamp with timezone nullable (when reminder sent)
- completedAt: timestamp with timezone nullable (when review detected)
- requestMessageId: varchar(255) nullable (WhatsApp message ID)
- reminderMessageId: varchar(255) nullable (reminder WhatsApp message ID)
- createdAt/updatedAt: timestamps

Indexes:
- Unique constraint on (tenantId, source, invoiceId) to prevent duplicates
- Index on status for filtering
- Index on scheduledForAt for job queries

**accountingProviderEnum** with 2 providers:
- greeninvoice
- icount

**accountingConnections table:**
- id: uuid primary key
- tenantId: uuid foreign key to tenants (cascade delete)
- provider: accountingProviderEnum
- status: varchar(20) default 'active' (active/inactive/error)
- credentialsVaultId: uuid NOT NULL (references token_vault conceptually, not FK)
- lastPollAt: timestamp with timezone nullable
- lastInvoiceDate: timestamp with timezone nullable
- lastError: text nullable
- createdAt/updatedAt: timestamps

Indexes:
- Unique constraint on (tenantId, provider) - one connection per provider per tenant

Export TypeScript types:
- ReviewRequest, NewReviewRequest
- AccountingConnection, NewAccountingConnection
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors in new schema file.
  </verify>
  <done>
Schema file exists with both tables, all enums, and exported TypeScript types matching the research specification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export schema and run migration</name>
  <files>src/db/schema/index.ts, drizzle/0007_*.sql</files>
  <action>
1. Add export to src/db/schema/index.ts:
   `export * from './review-requests';`

2. Generate migration:
   `npx drizzle-kit generate`

   Expected to create drizzle/0007_*.sql with:
   - CREATE TYPE review_request_status
   - CREATE TYPE review_request_source
   - CREATE TYPE accounting_provider
   - CREATE TABLE review_requests
   - CREATE TABLE accounting_connections
   - CREATE UNIQUE INDEX/CONSTRAINT statements
   - CREATE INDEX statements

3. Apply migration:
   `npx drizzle-kit push`

4. Verify tables exist:
   Query database to confirm tables created.
  </action>
  <verify>
- `npx drizzle-kit push` completes without errors
- Tables review_requests and accounting_connections exist in database
- Unique constraints work (try inserting duplicate -> should fail)
  </verify>
  <done>
Migration generated and applied. Tables exist in database with correct schema, indexes, and constraints.
  </done>
</task>

</tasks>

<verification>
- [ ] src/db/schema/review-requests.ts exists with complete schema
- [ ] src/db/schema/index.ts exports review-requests module
- [ ] Migration file generated in drizzle/ folder
- [ ] Migration applied to database
- [ ] TypeScript compiles without errors
- [ ] Unique constraint on (tenantId, source, invoiceId) prevents duplicates
</verification>

<success_criteria>
- reviewRequests table created with 6-state status enum
- accountingConnections table created with encrypted credential reference
- TypeScript types exported for use in services
- Unique constraint prevents duplicate review requests per invoice
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-requests/06-01-SUMMARY.md`
</output>
