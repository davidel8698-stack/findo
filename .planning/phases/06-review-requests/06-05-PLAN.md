---
phase: 06-review-requests
plan: 05
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/queue/workers/review-request.worker.ts
  - src/services/review-request/index.ts
  - src/services/review-request/messages.ts
autonomous: false
user_setup:
  - service: whatsapp-templates
    why: "Review request messages require pre-approved WhatsApp templates"
    dashboard_config:
      - task: "Create 'review_request' template in Meta Business Suite"
        location: "Meta Business Suite -> WhatsApp Manager -> Message Templates"
      - task: "Create 'review_reminder' template in Meta Business Suite"
        location: "Meta Business Suite -> WhatsApp Manager -> Message Templates"

must_haves:
  truths:
    - "System sends WhatsApp review request with Google review link"
    - "System schedules exactly 1 reminder after 3 days (no spam)"
    - "After reminder, request is marked stopped (no more messages)"
  artifacts:
    - path: "src/queue/workers/review-request.worker.ts"
      provides: "Worker processing review request jobs"
      contains: "send-review-request"
    - path: "src/services/review-request/messages.ts"
      provides: "Message generation with Google review link"
      exports: ["generateGoogleReviewLink"]
  key_links:
    - from: "src/queue/workers/review-request.worker.ts"
      to: "src/services/whatsapp/messages.ts"
      via: "sendTemplateMessage import"
      pattern: "sendTemplateMessage"
    - from: "src/services/review-request/messages.ts"
      to: "https://search.google.com/local/writereview"
      via: "URL construction"
      pattern: "search.google.com/local/writereview"
---

<objective>
Create review request worker that sends WhatsApp messages with Google review links.

Purpose: Process delayed review request jobs (24h after invoice), send WhatsApp template messages with direct Google review links, and schedule single follow-up reminder (per REVW-06: exactly 1 reminder after 3 days, then stop).

Output: Review request worker, message generation service, and reminder scheduling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-review-requests/06-RESEARCH.md
@src/services/whatsapp/messages.ts
@src/services/whatsapp/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review request message service</name>
  <files>src/services/review-request/messages.ts, src/services/review-request/index.ts</files>
  <action>
Create message generation service:

**src/services/review-request/messages.ts:**
```typescript
import { WhatsAppClient } from '../whatsapp/client';
import { sendTemplateMessage, TemplateComponent } from '../whatsapp/messages';

/**
 * Generate direct Google review link from Place ID.
 * This link opens Google Maps directly to the review form.
 *
 * @param placeId - Google Place ID for the business
 * @returns Direct review link URL
 */
export function generateGoogleReviewLink(placeId: string): string {
  return `https://search.google.com/local/writereview?placeid=${placeId}`;
}

/**
 * Send initial review request via WhatsApp template.
 * Template must be pre-approved in Meta Business Suite.
 *
 * Template name: 'review_request'
 * Variables:
 * - Body {{1}}: Customer name
 * - Body {{2}}: Business name
 * - Button URL {{1}}: Place ID (appended to base URL)
 *
 * @param client - WhatsApp client for the tenant
 * @param customerPhone - Customer phone in international format
 * @param customerName - Customer name for personalization
 * @param businessName - Business name for message
 * @param placeId - Google Place ID for review link
 * @returns WhatsApp message ID
 */
export async function sendReviewRequestMessage(
  client: WhatsAppClient,
  customerPhone: string,
  customerName: string,
  businessName: string,
  placeId: string
): Promise<string> {
  const components: TemplateComponent[] = [
    {
      type: 'body',
      parameters: [
        { type: 'text', text: customerName || 'לקוח יקר' }, // "Dear customer" fallback
        { type: 'text', text: businessName },
      ],
    },
    {
      type: 'button',
      sub_type: 'url',
      index: 0,
      parameters: [{ type: 'text', text: placeId }],
    },
  ];

  const result = await sendTemplateMessage(
    client,
    customerPhone,
    'review_request',
    'he',
    components
  );

  return result.messageId;
}

/**
 * Send review reminder via WhatsApp template.
 * Only one reminder is sent (REVW-06, REVW-07: no spam).
 *
 * Template name: 'review_reminder'
 * Variables:
 * - Body {{1}}: Business name
 * - Button URL {{1}}: Place ID
 *
 * @param client - WhatsApp client for the tenant
 * @param customerPhone - Customer phone in international format
 * @param businessName - Business name for message
 * @param placeId - Google Place ID for review link
 * @returns WhatsApp message ID
 */
export async function sendReviewReminderMessage(
  client: WhatsAppClient,
  customerPhone: string,
  businessName: string,
  placeId: string
): Promise<string> {
  const components: TemplateComponent[] = [
    {
      type: 'body',
      parameters: [
        { type: 'text', text: businessName },
      ],
    },
    {
      type: 'button',
      sub_type: 'url',
      index: 0,
      parameters: [{ type: 'text', text: placeId }],
    },
  ];

  const result = await sendTemplateMessage(
    client,
    customerPhone,
    'review_reminder',
    'he',
    components
  );

  return result.messageId;
}
```

**src/services/review-request/index.ts:**
```typescript
export * from './messages';
```
  </action>
  <verify>
`npx tsc --noEmit` - message service compiles without errors.
  </verify>
  <done>
Message service exists with Google review link generation and template message functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create review request worker</name>
  <files>src/queue/workers/review-request.worker.ts</files>
  <action>
Create worker that processes review request jobs:

```typescript
import { Worker, Job } from 'bullmq';
import { createRedisConnection } from '../../lib/redis';
import { db } from '../../db/index';
import { reviewRequests, tenants, googleConnections } from '../../db/schema/index';
import { eq } from 'drizzle-orm';
import { reviewRequestQueue, type ReviewRequestJobData } from '../queues';
import { createWhatsAppClient } from '../../services/whatsapp/index';
import {
  sendReviewRequestMessage,
  sendReviewReminderMessage,
} from '../../services/review-request/index';

/**
 * Review request worker - sends WhatsApp review requests and reminders.
 *
 * Job types:
 * - 'send-review-request': Initial request (24h after invoice)
 * - 'send-review-reminder': Follow-up (3 days after initial request)
 */
export function startReviewRequestWorker(): Worker<ReviewRequestJobData> {
  const worker = new Worker<ReviewRequestJobData>(
    'review-requests',
    async (job: Job<ReviewRequestJobData>) => {
      const { reviewRequestId } = job.data;

      // Load review request
      const request = await db.query.reviewRequests.findFirst({
        where: eq(reviewRequests.id, reviewRequestId),
      });

      if (!request) {
        console.error(`[review-request] Request not found: ${reviewRequestId}`);
        return;
      }

      // Check if already completed (customer left review)
      if (request.status === 'completed') {
        console.log(`[review-request] ${reviewRequestId} already completed`);
        return;
      }

      // Check if stopped (already sent reminder)
      if (request.status === 'stopped') {
        console.log(`[review-request] ${reviewRequestId} already stopped`);
        return;
      }

      // Get tenant info
      const tenant = await db.query.tenants.findFirst({
        where: eq(tenants.id, request.tenantId),
      });

      if (!tenant) {
        console.error(`[review-request] Tenant not found: ${request.tenantId}`);
        return;
      }

      // Get Google connection for Place ID
      const googleConnection = await db.query.googleConnections.findFirst({
        where: eq(googleConnections.tenantId, request.tenantId),
      });

      if (!googleConnection?.placeId) {
        console.error(`[review-request] No Google Place ID for tenant: ${request.tenantId}`);
        // Mark as skipped - can't send without review link
        await db.update(reviewRequests)
          .set({ status: 'skipped', updatedAt: new Date() })
          .where(eq(reviewRequests.id, reviewRequestId));
        return;
      }

      // Get WhatsApp client
      const client = await createWhatsAppClient(request.tenantId);
      if (!client) {
        console.error(`[review-request] No WhatsApp client for tenant: ${request.tenantId}`);
        return;
      }

      try {
        if (job.name === 'send-review-request') {
          // Send initial request
          const messageId = await sendReviewRequestMessage(
            client,
            request.customerPhone!,
            request.customerName || '',
            tenant.businessName,
            googleConnection.placeId
          );

          // Update status and schedule reminder
          await db.update(reviewRequests)
            .set({
              status: 'requested',
              requestedAt: new Date(),
              requestMessageId: messageId,
              updatedAt: new Date(),
            })
            .where(eq(reviewRequests.id, reviewRequestId));

          // Schedule 3-day reminder (REVW-06: one reminder after 3 days)
          const reminderDelay = 3 * 24 * 60 * 60 * 1000; // 3 days

          await reviewRequestQueue.add(
            'send-review-reminder',
            { reviewRequestId },
            {
              delay: reminderDelay,
              jobId: `review-reminder-${reviewRequestId}`,
              removeOnComplete: true,
            }
          );

          console.log(
            `[review-request] Sent initial request to ${request.customerPhone}, reminder in 3 days`
          );

        } else if (job.name === 'send-review-reminder') {
          // Check again if completed (customer may have reviewed after initial request)
          const currentRequest = await db.query.reviewRequests.findFirst({
            where: eq(reviewRequests.id, reviewRequestId),
          });

          if (currentRequest?.status === 'completed') {
            console.log(`[review-request] ${reviewRequestId} completed before reminder`);
            return;
          }

          // Send reminder
          const messageId = await sendReviewReminderMessage(
            client,
            request.customerPhone!,
            tenant.businessName,
            googleConnection.placeId
          );

          // Mark as STOPPED (REVW-07: no spam after reminder)
          await db.update(reviewRequests)
            .set({
              status: 'stopped',
              reminderSentAt: new Date(),
              reminderMessageId: messageId,
              updatedAt: new Date(),
            })
            .where(eq(reviewRequests.id, reviewRequestId));

          console.log(
            `[review-request] Sent reminder to ${request.customerPhone}, marked as stopped`
          );
        }
      } catch (error) {
        console.error(`[review-request] Failed to send message:`, error);
        // Don't mark as failed - job will retry per BullMQ config
        throw error;
      }
    },
    {
      connection: createRedisConnection(),
      concurrency: 5, // Process multiple requests concurrently
    }
  );

  console.log('[review-request] Worker started');
  return worker;
}
```

Key features:
- Handles both initial request and reminder
- Checks if completed before sending (avoid reminder after review)
- Marks as 'stopped' after reminder (REVW-07: no spam)
- Gets Place ID from Google connection
- Graceful handling if tenant/connection missing
  </action>
  <verify>
`npx tsc --noEmit` - worker compiles without errors.
  </verify>
  <done>
Review request worker exists with initial request and reminder handling, proper status transitions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export worker from workers module</name>
  <files>src/queue/workers/index.ts</files>
  <action>
Add worker export:

```typescript
export { startReviewRequestWorker } from './review-request.worker';
```

Ensure worker is started in the main worker initialization (wherever workers are started, likely in a worker entry point file).
  </action>
  <verify>
`npx tsc --noEmit` - exports compile without errors.
  </verify>
  <done>
Worker is exported and can be started by the worker initialization code.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Review request worker that sends WhatsApp template messages with Google review links.
  </what-built>
  <how-to-verify>
Note: This requires WhatsApp templates to be created in Meta Business Suite BEFORE testing.

**Required templates (create in Meta Business Suite -> WhatsApp Manager -> Message Templates):**

1. **review_request** template:
   - Category: Utility
   - Language: Hebrew (he)
   - Body: `{{1}} שלום,\nתודה על שבחרת ב{{2}}!\nנשמח אם תקדיש רגע להשאיר לנו ביקורת בגוגל.\nזה עוזר לעסקים קטנים כמונו.`
   - Button: URL type, text "השאר ביקורת", URL `https://search.google.com/local/writereview?placeid={{1}}`

2. **review_reminder** template:
   - Category: Utility
   - Language: Hebrew (he)
   - Body: `רק תזכורת קטנה - נשמח לשמוע מה חשבת על {{1}}.\nביקורת שלך באמת עוזרת לנו.`
   - Button: URL type, text "השאר ביקורת", URL `https://search.google.com/local/writereview?placeid={{1}}`

**To verify code works:**
1. Confirm TypeScript compiles: `npm run build`
2. Confirm worker exports properly
3. Template creation is a separate step done in Meta dashboard

User: Type "templates created" once templates are submitted for approval, or "skip" to continue without templates (worker won't work until templates approved).
  </how-to-verify>
  <resume-signal>Type "templates created" or "skip"</resume-signal>
</task>

</tasks>

<verification>
- [ ] src/services/review-request/messages.ts exists with template functions
- [ ] src/services/review-request/index.ts exports message service
- [ ] src/queue/workers/review-request.worker.ts exists
- [ ] Worker handles both send-review-request and send-review-reminder jobs
- [ ] Status transitions: pending -> requested -> stopped (or completed)
- [ ] Only 1 reminder is scheduled (REVW-06)
- [ ] After reminder, status is 'stopped' (REVW-07: no spam)
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- Initial review request sent 24h after invoice detection
- Single reminder scheduled 3 days after initial request
- After reminder, request marked as 'stopped' (no more messages)
- Google review link embedded in WhatsApp template
- Worker properly handles edge cases (missing tenant, completed review)
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-requests/06-05-SUMMARY.md`
</output>
