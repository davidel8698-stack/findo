---
phase: 07-gbp-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/gbp-content.ts
  - src/db/schema/index.ts
  - src/queue/workers/photo-request.worker.ts
  - src/scheduler/jobs.ts
autonomous: true

must_haves:
  truths:
    - "Owner receives weekly WhatsApp asking for 1-2 photos"
    - "Photo requests track which tenants received requests"
    - "Photo request job runs weekly on Thursday at 10:00 AM Israel time"
  artifacts:
    - path: "src/db/schema/gbp-content.ts"
      provides: "Photo requests tracking table"
      contains: "photoRequests"
    - path: "src/queue/workers/photo-request.worker.ts"
      provides: "Weekly photo request worker"
      exports: ["photoRequestWorker"]
  key_links:
    - from: "photo-request.worker.ts"
      to: "whatsapp/send.ts"
      via: "sendWhatsAppMessage"
      pattern: "sendWhatsAppMessage"
    - from: "photo-request.worker.ts"
      to: "photoRequests table"
      via: "drizzle insert"
      pattern: "db\\.insert\\(photoRequests\\)"
---

<objective>
Create the database schema for photo content tracking and implement the weekly photo request worker that sends WhatsApp messages to business owners asking for 1-2 photos from the week.

Purpose: Establishes the foundation for photo collection. Per CONTEXT.md, weekly requests on Thursday (end of Israeli work week) with friendly tone.
Output: Photo requests table, weekly worker that messages all active tenants
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-gbp-content/07-CONTEXT.md
@.planning/phases/07-gbp-content/07-RESEARCH.md
@src/db/schema/index.ts
@src/services/whatsapp/send.ts
@src/scheduler/jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GBP Content Database Schema</name>
  <files>src/db/schema/gbp-content.ts, src/db/schema/index.ts</files>
  <action>
Create `src/db/schema/gbp-content.ts` with two tables:

1. **photoRequests** - Tracks weekly photo request cycles:
   - id: UUID primary key
   - tenantId: UUID foreign key to tenants
   - status: enum('sent', 'received', 'uploaded', 'skipped', 'expired') - tracks flow
   - requestedAt: timestamp - when WhatsApp sent
   - receivedAt: timestamp nullable - when photo received
   - uploadedAt: timestamp nullable - when uploaded to GBP
   - reminderSentAt: timestamp nullable - if reminder was sent
   - mediaIds: text array - WhatsApp media IDs received
   - gbpMediaIds: text array - GBP media IDs after upload
   - week: integer - ISO week number for deduplication
   - year: integer - year for deduplication
   - createdAt/updatedAt timestamps
   - deletedAt for soft delete

2. **gbpPhotos** - Tracks individual photos uploaded to GBP:
   - id: UUID primary key
   - tenantId: UUID foreign key
   - photoRequestId: UUID nullable foreign key to photoRequests
   - mediaItemId: text - GBP media item ID
   - category: enum('COVER', 'PROFILE', 'EXTERIOR', 'INTERIOR', 'PRODUCT', 'AT_WORK', 'FOOD_AND_DRINK', 'MENU', 'COMMON_AREA', 'ROOMS', 'TEAMS', 'ADDITIONAL')
   - sourceUrl: text - URL used for upload (S3/storage URL)
   - status: enum('processing', 'live', 'rejected', 'removed')
   - uploadedAt: timestamp
   - createdAt/updatedAt timestamps
   - deletedAt for soft delete

Add unique constraint on photoRequests: (tenantId, week, year) to prevent duplicate requests same week.

Export from index.ts.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Schema file exists with photoRequests and gbpPhotos tables, exported from index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Implement Photo Request Worker</name>
  <files>src/queue/workers/photo-request.worker.ts, src/scheduler/jobs.ts</files>
  <action>
Create `src/queue/workers/photo-request.worker.ts`:

1. Worker processes 'photo-request' jobs from scheduledQueue
2. For each active tenant with Google connection AND WhatsApp connection:
   - Check if request already sent this week (use ISO week number)
   - Skip if already sent (idempotency)
   - Send WhatsApp message in Hebrew with casual/friendly tone:
     ```
     היי! איך היה השבוע?
     שלח 1-2 תמונות מהשבוע - זה עוזר ללקוחות חדשים לראות מה קורה אצלך ומשפר את הדירוג בגוגל.
     ```
   - Insert photoRequests record with status='sent', week, year
   - 100ms delay between tenants (rate limit protection)

3. Register worker on scheduledQueue (filter by jobType: 'photo-request')

4. Update jobs.ts:
   - Change existing photo-request schedule from Sunday to Thursday:
     ```typescript
     pattern: '0 10 * * 4',  // Thursday 10:00 AM
     ```
   - Update comment to reflect Thursday (end of Israeli work week per CONTEXT.md)

Use existing patterns from review-poll.worker.ts for tenant iteration with error isolation.

Helper function to get ISO week number:
```typescript
function getISOWeek(date: Date): { week: number; year: number } {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const week = Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
  return { week, year: d.getUTCFullYear() };
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Photo request worker sends weekly WhatsApp to owners, records in photoRequests table, runs on Thursday 10:00 AM</done>
</task>

<task type="auto">
  <name>Task 3: Add Photo Reminder Logic</name>
  <files>src/queue/workers/photo-request.worker.ts</files>
  <action>
Extend photo-request.worker.ts to handle reminders:

1. Add job type handler for 'photo-reminder':
   - Find photoRequests where status='sent' AND reminderSentAt IS NULL AND requestedAt < 2 days ago
   - For each, send reminder WhatsApp:
     ```
     היי, רק תזכורת קטנה - יש לך תמונות מהשבוע? אפילו אחת או שתיים יעזרו.
     אם לא הספקת, אין בעיה - נמשיך בשבוע הבא!
     ```
   - Update reminderSentAt timestamp
   - 100ms delay between tenants

2. After reminder, if still no response by end of week (7 days from request):
   - Update status to 'expired' (handled in next weekly run)

3. Add scheduled job in jobs.ts for 'photo-reminder':
   - Run on Saturday 10:00 AM (2 days after Thursday request)
   - Same pattern as other scheduled jobs

Per CONTEXT.md: "One reminder after 2 days if no response, then skip until next week"
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Photo reminder sends 2 days after initial request if no photos received, expires after week ends</done>
</task>

</tasks>

<verification>
1. Schema compiles and has correct table structure
2. Photo request worker:
   - Iterates active tenants with both WhatsApp and Google connections
   - Sends Hebrew message with friendly tone
   - Creates photoRequests records
   - Handles idempotency via week/year unique constraint
3. Reminder logic:
   - Triggers 2 days after initial request
   - Only sends one reminder per request
   - Expires requests at end of week
4. Jobs scheduled on Thursday (request) and Saturday (reminder)
</verification>

<success_criteria>
- photoRequests and gbpPhotos tables exist with correct schemas
- Photo request worker processes weekly job and sends WhatsApp messages
- Reminder worker handles 2-day follow-up
- Jobs run at correct Israel timezone times (Thursday 10AM, Saturday 10AM)
</success_criteria>

<output>
After completion, create `.planning/phases/07-gbp-content/07-01-SUMMARY.md`
</output>
