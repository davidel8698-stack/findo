---
phase: 07-gbp-content
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Owner receives weekly WhatsApp asking for 1-2 photos from the week"
    - "Photos sent to system are uploaded to GBP within 24 hours"
    - "Monthly promotional post is created from owner-provided content or AI-generated if none provided"
    - "System checks business details (holidays, hours) and offers updates for owner approval"
  artifacts:
    - path: "src/index.ts"
      provides: "Worker registration and lifecycle management"
      contains:
        - "startPhotoRequestWorker"
        - "startPhotoUploadWorker"
        - "startMonthlyPostWorker"
        - "startPostApprovalWorker"
        - "holidayCheckWorker"
  key_links:
    - from: "src/index.ts"
      to: "src/queue/workers/photo-request.worker.ts"
      via: "import and start call"
      pattern: "startPhotoRequestWorker\\(\\)"
    - from: "src/index.ts"
      to: "src/queue/workers/photo-upload.worker.ts"
      via: "import and start call"
      pattern: "startPhotoUploadWorker\\(\\)"
    - from: "src/index.ts"
      to: "src/queue/workers/monthly-post.worker.ts"
      via: "import and start call"
      pattern: "startMonthlyPostWorker\\(\\)"
    - from: "src/index.ts"
      to: "src/queue/workers/post-approval.worker.ts"
      via: "import and start call"
      pattern: "startPostApprovalWorker\\(\\)"
    - from: "src/index.ts"
      to: "src/queue/workers/holiday-check.worker.ts"
      via: "import"
      pattern: "holidayCheckWorker"
---

<objective>
Register all Phase 7 GBP Content workers in src/index.ts

Purpose: Close the verification gap - all workers exist but none are started by the application. Without registration, scheduled jobs fire but no workers listen, making all Phase 7 functionality non-operational.

Output: Workers properly imported, tracked, started in start(), and cleaned up in shutdown()
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-gbp-content/07-VERIFICATION.md
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Phase 7 workers in src/index.ts</name>
  <files>src/index.ts</files>
  <action>
Add all Phase 7 workers to src/index.ts following the existing pattern:

1. Add imports after line 21 (after voicenter-cdr.worker import):
```typescript
import { startPhotoRequestWorker } from './queue/workers/photo-request.worker';
import { startPhotoUploadWorker } from './queue/workers/photo-upload.worker';
import { startMonthlyPostWorker } from './queue/workers/monthly-post.worker';
import { startPostApprovalWorker } from './queue/workers/post-approval.worker';
import { holidayCheckWorker } from './queue/workers/holiday-check.worker';
```

Note: holidayCheckWorker exports the worker directly (not a start function) - import as-is.

2. Add worker tracking variables after line 91 (after voicenterCDRWorker):
```typescript
let photoRequestWorker: ReturnType<typeof startPhotoRequestWorker> | null = null;
let photoUploadWorker: ReturnType<typeof startPhotoUploadWorker> | null = null;
let monthlyPostWorker: ReturnType<typeof startMonthlyPostWorker> | null = null;
let postApprovalWorker: ReturnType<typeof startPostApprovalWorker> | null = null;
// holidayCheckWorker is already instantiated at import time (not lazy-started)
```

3. Add worker cleanup in shutdown() function (after voicenterCDRWorker cleanup, before Redis close):
```typescript
if (photoRequestWorker) {
  await photoRequestWorker.close();
  console.log('[server] Photo request worker stopped');
}
if (photoUploadWorker) {
  await photoUploadWorker.close();
  console.log('[server] Photo upload worker stopped');
}
if (monthlyPostWorker) {
  await monthlyPostWorker.close();
  console.log('[server] Monthly post worker stopped');
}
if (postApprovalWorker) {
  await postApprovalWorker.notificationWorker.close();
  await postApprovalWorker.scheduledWorker.close();
  console.log('[server] Post approval workers stopped');
}
// holidayCheckWorker cleanup
await holidayCheckWorker.close();
console.log('[server] Holiday check worker stopped');
```

4. Add worker start calls in start() function (after voicenterCDRWorker start, before scheduler init):
```typescript
photoRequestWorker = startPhotoRequestWorker();
photoUploadWorker = startPhotoUploadWorker();
monthlyPostWorker = startMonthlyPostWorker();
postApprovalWorker = startPostApprovalWorker();
// holidayCheckWorker already started at import time
```

Important: postApprovalWorker returns { notificationWorker, scheduledWorker } - handle both in cleanup.
Important: holidayCheckWorker is instantiated at import, not via a start function.
  </action>
  <verify>
Run TypeScript compilation to verify no errors:
```bash
npx tsc --noEmit
```
All imports resolve and types match.
  </verify>
  <done>
- 5 imports added for Phase 7 workers
- 4 tracking variables added (holidayCheckWorker instantiated at import)
- 5 cleanup blocks in shutdown()
- 4 start calls in start() (holidayCheckWorker already running)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After completing the task:

1. TypeScript compiles without errors:
```bash
npx tsc --noEmit
```

2. All Phase 7 worker imports present:
```bash
grep -E "(startPhotoRequestWorker|startPhotoUploadWorker|startMonthlyPostWorker|startPostApprovalWorker|holidayCheckWorker)" src/index.ts
```
Should show all 5 worker references.

3. Worker start calls present:
```bash
grep -E "photoRequestWorker = start|photoUploadWorker = start|monthlyPostWorker = start|postApprovalWorker = start" src/index.ts
```
Should show 4 start calls.

4. Cleanup handlers present:
```bash
grep -E "photoRequestWorker\\)" src/index.ts
grep -E "photoUploadWorker\\)" src/index.ts
grep -E "monthlyPostWorker\\)" src/index.ts
grep -E "postApprovalWorker\\." src/index.ts
grep -E "holidayCheckWorker\\.close" src/index.ts
```
Should show cleanup for all workers.
</verification>

<success_criteria>
- All 5 Phase 7 workers are imported in src/index.ts
- All workers are started when server starts (4 explicitly, 1 at import)
- All workers are cleaned up during shutdown
- TypeScript compiles without errors
- Application starts without runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-gbp-content/07-07-SUMMARY.md`
</output>
