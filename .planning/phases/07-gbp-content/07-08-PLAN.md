---
phase: 07-gbp-content
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/queue/workers/photo-upload.worker.ts
  - src/queue/workers/post-approval.worker.ts
  - src/queue/workers/holiday-check.worker.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Owner receives confirmation message after photo upload explaining GBP processing delay"
    - "Owner receives confirmation with link to view post after approval"
    - "All Phase 7 workers log their startup on server boot"
  artifacts:
    - path: "src/queue/workers/photo-upload.worker.ts"
      provides: "Photo upload confirmation with processing explanation"
      contains: "24-48"
    - path: "src/queue/workers/post-approval.worker.ts"
      provides: "Post publish confirmation with viewable link"
      contains: "searchUrl"
    - path: "src/queue/workers/holiday-check.worker.ts"
      provides: "Startup log message"
      contains: "Worker started"
  key_links:
    - from: "src/queue/workers/post-approval.worker.ts"
      to: "src/services/google/posts.ts"
      via: "LocalPost.name to searchUrl conversion"
      pattern: "searchUrl"
---

<objective>
Fix 3 minor UAT issues in Phase 7 GBP Content workers.

Purpose: Improve user experience by providing better confirmation messages and consistent logging.
Output: Updated worker files with improved messaging and logging.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gbp-content/07-UAT.md

# Source files to modify
@src/queue/workers/photo-upload.worker.ts
@src/queue/workers/post-approval.worker.ts
@src/queue/workers/holiday-check.worker.ts
@src/services/google/posts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix photo upload confirmation message</name>
  <files>src/queue/workers/photo-upload.worker.ts</files>
  <action>
Update the success notification message (around line 123-128) to better explain the GBP processing delay.

Current message only says it can take 24-48 hours. Update to:
1. Confirm the photo was successfully uploaded
2. Explain that GBP takes 24-48 hours to process and show the image
3. Mention that a follow-up message will NOT be sent (since we don't have a mechanism to track when GBP finishes processing)

Note: Per UAT findings, GBP images enter "Processing" state immediately and real URLs are only available after 24-48h. Since we don't have a webhook for GBP processing completion, we cannot send a follow-up with the actual link. The message should set proper expectations.

Updated message (Hebrew):
```
`התמונה עלתה בהצלחה!\n\n` +
`חשוב לדעת: גוגל מעבד את התמונות לפני הצגתן בפרופיל.\n` +
`התמונה תופיע בפרופיל העסקי שלך תוך 24-48 שעות.\n` +
`תודה שאתה שומר על הפרופיל מעודכן!`
```
  </action>
  <verify>Read the updated file and confirm the new message includes "24-48 שעות" and "מעבד את התמונות"</verify>
  <done>Photo upload confirmation message explains GBP processing delay clearly</done>
</task>

<task type="auto">
  <name>Task 2: Add post URL to publish confirmation</name>
  <files>src/queue/workers/post-approval.worker.ts</files>
  <action>
Update the handlePublish function to include a link to view the post in the confirmation message.

GBP post URLs follow this pattern:
- The `post.name` from createPost() contains: `accounts/{accountId}/locations/{locationId}/localPosts/{postId}`
- Google Maps search URL: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(businessName)}`

Since there's no direct public URL to view a specific post, the best approach is to link to the business's Google Maps profile where posts appear. The business name is available from the tenant object.

Update the confirmation message (around line 145-149) to include a Google Maps search link:

```typescript
// After publishing, construct the Maps URL
const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tenant.businessName)}`;

await sendTextMessage(
  client,
  tenant.ownerPhone,
  `הפוסט פורסם בגוגל!\n\n` +
  `לצפייה בפרופיל: ${mapsUrl}\n\n` +
  `הפוסט יופיע בפרופיל תוך כמה שעות.`
);
```

Also add the searchUrl to the database update so it's stored for future reference:
- Add `searchUrl` field to the update call alongside gbpPostId and gbpPostState
  </action>
  <verify>Read the updated file and confirm it includes "google.com/maps/search" in the confirmation message</verify>
  <done>Post publish confirmation includes link to view business profile on Google Maps</done>
</task>

<task type="auto">
  <name>Task 3: Add startup log to holiday-check worker</name>
  <files>src/queue/workers/holiday-check.worker.ts</files>
  <action>
The holiday-check worker is instantiated at import time (line 21: `export const holidayCheckWorker = new Worker<...>`), unlike other workers that use a `startXxxWorker()` function pattern.

Add a startup log message after the worker is created. Add this line after the worker event handlers (after line 84):

```typescript
console.log('[holiday-check] Worker started');
```

This matches the pattern used by other workers (e.g., photo-upload.worker.ts line 186).
  </action>
  <verify>Read the updated file and confirm it contains "Worker started" log message</verify>
  <done>Holiday-check worker logs startup message consistent with other Phase 7 workers</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Grep for new message content:
   - `grep -r "מעבד את התמונות" src/queue/workers/`
   - `grep -r "maps/search" src/queue/workers/`
   - `grep -r "holiday-check.*Worker started" src/queue/workers/`

2. Verify TypeScript compilation:
   - `npx tsc --noEmit`

3. Run existing tests (if any):
   - `npm test`
</verification>

<success_criteria>
- [ ] Photo upload confirmation explains GBP processing delay (24-48h)
- [ ] Post publish confirmation includes Google Maps link to business profile
- [ ] Holiday-check worker logs "Worker started" on initialization
- [ ] TypeScript compiles without errors
- [ ] All 3 UAT gaps addressed
</success_criteria>

<output>
After completion, create `.planning/phases/07-gbp-content/07-08-SUMMARY.md`
</output>
