---
phase: 08-gbp-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/optimization.ts
  - src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "System can store weekly metric snapshots for each tenant"
    - "System can track A/B test variants and their outcomes"
    - "System can store optimization configuration per tenant"
  artifacts:
    - path: "src/db/schema/optimization.ts"
      provides: "Metrics, A/B testing, and optimization schema"
      contains: "metricSnapshots"
    - path: "src/db/schema/optimization.ts"
      provides: "A/B test tracking"
      contains: "abTestVariants"
  key_links:
    - from: "src/db/schema/optimization.ts"
      to: "src/db/schema/tenants.ts"
      via: "foreign key references"
      pattern: "references.*tenants\\.id"
---

<objective>
Create database schema for GBP optimization: metric snapshots, A/B testing, and optimization configuration.

Purpose: Foundation data model for all Phase 8 optimization features. Without this schema, metrics cannot be stored, A/B tests cannot be tracked, and autonomous tuning has no state to persist.

Output: New optimization.ts schema file with tables for metric storage, A/B test tracking, optimization config, and baseline calculations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-gbp-optimization/08-CONTEXT.md
@src/db/schema/reviews.ts
@src/db/schema/review-requests.ts
@src/db/schema/gbp-content.ts
@src/db/schema/tenants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create optimization schema with metric snapshots</name>
  <files>src/db/schema/optimization.ts</files>
  <action>
Create `src/db/schema/optimization.ts` with:

1. **metricSnapshots** table - Weekly metric aggregation:
   - id (uuid, primary key)
   - tenantId (uuid, FK to tenants, cascade delete)
   - snapshotDate (date, the week's start date - always Sunday)
   - period (enum: 'week', 'month')

   Review metrics (GBPO-01):
   - totalReviews (integer)
   - averageRating (decimal 2 places)
   - reviewCount (integer, reviews in this period)
   - responsePercentage (decimal 2 places, 0-100)

   Visibility metrics (GBPO-02):
   - impressions (integer, nullable - may not be available)
   - searches (integer, nullable)
   - actions (integer, nullable - calls, directions, website clicks)

   Content metrics (GBPO-03):
   - imageCount (integer)
   - imageViews (integer, nullable)

   Review request metrics:
   - reviewRequestsSent (integer)
   - reviewRequestsCompleted (integer)
   - reviewRequestConversionRate (decimal, 0-100)

   Timestamps:
   - createdAt, updatedAt

   Unique constraint: (tenantId, snapshotDate, period)
   Index on tenantId for queries
   Index on snapshotDate for range queries

2. **tenantBaselines** table - Dynamic baseline storage:
   - id (uuid, primary key)
   - tenantId (uuid, FK to tenants, unique)
   - baselineReviewRate (decimal, reviews per week)
   - baselineResponseRate (decimal, 0-100)
   - baselineConversionRate (decimal, 0-100)
   - samplesCount (integer, how many weeks of data)
   - calculatedAt (timestamp)
   - createdAt, updatedAt

3. **abTestVariants** table - A/B test definitions:
   - id (uuid, primary key)
   - testType (enum: 'review_request_message', 'review_request_timing', 'review_reminder_message', 'photo_request_message', 'post_request_message')
   - variantName (varchar 100)
   - variantContent (text, JSON blob with variant specifics)
   - isControl (boolean, default false)
   - isGlobalWinner (boolean, default false)
   - globalWinnerAt (timestamp, nullable)
   - createdAt, updatedAt

   Unique constraint: (testType, variantName)
   Index on testType for lookups

4. **abTestAssignments** table - Per-tenant variant assignments:
   - id (uuid, primary key)
   - tenantId (uuid, FK to tenants)
   - variantId (uuid, FK to abTestVariants)
   - assignedAt (timestamp)
   - samplesCollected (integer, default 0)
   - successCount (integer, default 0)
   - conversionRate (decimal, nullable)
   - isActive (boolean, default true)
   - deactivatedAt (timestamp, nullable)
   - deactivationReason (varchar 255, nullable)
   - createdAt, updatedAt

   Unique constraint: (tenantId, variantId)
   Index on variantId for aggregate queries

5. **optimizationConfig** table - Per-tenant tuning state:
   - id (uuid, primary key)
   - tenantId (uuid, FK to tenants, unique)

   Review request timing (GBPO-05):
   - reviewRequestDelayHours (integer, default 24)
   - reviewReminderDelayDays (integer, default 3)

   Soft limits with override capability (per CONTEXT.md):
   - maxReviewRequestsPerCustomerPerMonth (integer, default 1)
   - overrideLimits (boolean, default false)

   Auto-tuning state:
   - lastTuningRun (timestamp, nullable)
   - lastTuningAction (text, nullable - JSON summary)

   Timestamps:
   - createdAt, updatedAt

Export all types for TypeScript inference.
  </action>
  <verify>
Run `npx drizzle-kit generate` - should generate migration without errors.
Grep for "metricSnapshots" in schema - should exist.
Grep for "abTestVariants" in schema - should exist.
  </verify>
  <done>
Schema file exists with all 5 tables, enums defined, foreign keys reference tenants, type exports present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register optimization schema in index</name>
  <files>src/db/schema/index.ts</files>
  <action>
Update `src/db/schema/index.ts` to:

1. Import and re-export all from './optimization':
   ```typescript
   export * from './optimization';
   ```

2. Add after the gbp-content exports (maintain alphabetical or logical order).

Follow existing pattern in the file for other schema exports.
  </action>
  <verify>
Import test: `import { metricSnapshots, abTestVariants } from './src/db/schema'` should work.
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
Optimization schema exports available from main schema index. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run migration to create tables</name>
  <files>drizzle/migrations (generated)</files>
  <action>
1. Generate migration:
   ```bash
   npx drizzle-kit generate
   ```

2. Apply migration (if DATABASE_URL is available in dev):
   ```bash
   npx drizzle-kit push
   ```

   Or if using migrate script:
   ```bash
   npm run db:migrate
   ```

Note: If database not available, migration generation is sufficient for this task. Push can happen at deployment.
  </action>
  <verify>
Migration file created in drizzle/ directory.
If pushed: `SELECT * FROM metric_snapshots LIMIT 1` runs without error (empty result is fine).
  </verify>
  <done>
Migration generated. Tables created in database (or ready to be created on deploy).
  </done>
</task>

</tasks>

<verification>
1. Schema file exists: `ls src/db/schema/optimization.ts`
2. All tables defined: grep for each table name
3. TypeScript compiles: `npx tsc --noEmit`
4. Migration generated: `ls drizzle/` shows new migration
</verification>

<success_criteria>
- optimization.ts contains metricSnapshots, tenantBaselines, abTestVariants, abTestAssignments, optimizationConfig tables
- All tables have proper FK references to tenants
- Enums defined for testType
- Schema exports available from src/db/schema/index.ts
- Migration file generated
</success_criteria>

<output>
After completion, create `.planning/phases/08-gbp-optimization/08-01-SUMMARY.md`
</output>
