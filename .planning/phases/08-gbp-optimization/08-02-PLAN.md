---
phase: 08-gbp-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/google/performance.ts
  - src/services/google/index.ts
autonomous: true

must_haves:
  truths:
    - "System can fetch visibility metrics (impressions, searches, actions) from GBP API"
    - "System can fetch content metrics (image count, views) from GBP API"
    - "Metrics are aggregated by time range (week, month)"
  artifacts:
    - path: "src/services/google/performance.ts"
      provides: "GBP Performance API client"
      exports: ["getPerformanceMetrics", "getMediaMetrics"]
  key_links:
    - from: "src/services/google/performance.ts"
      to: "src/services/google/oauth.ts"
      via: "createAuthenticatedClient import"
      pattern: "import.*createAuthenticatedClient.*from.*oauth"
---

<objective>
Create Google Business Profile Performance API client for visibility and content metrics.

Purpose: GBPO-02 requires visibility metrics (impressions, contacts, search queries) and GBPO-03 requires content metrics (image count, image views). This service fetches these from the GBP Business Performance API.

Output: New performance.ts service that fetches and aggregates GBP performance metrics for dashboard display and baseline calculation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-gbp-optimization/08-CONTEXT.md
@src/services/google/oauth.ts
@src/services/google/reviews.ts
@src/services/google/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GBP Performance API service</name>
  <files>src/services/google/performance.ts</files>
  <action>
Create `src/services/google/performance.ts` with:

1. **Types:**
```typescript
export interface PerformanceMetrics {
  // Time period
  startDate: string; // YYYY-MM-DD
  endDate: string;

  // Visibility metrics (GBPO-02)
  impressions: number;      // Business profile views
  searches: number;         // Discovery searches
  actions: number;          // Total actions (calls + directions + website)

  // Action breakdown (optional detail)
  phoneCalls?: number;
  directionRequests?: number;
  websiteClicks?: number;
}

export interface MediaMetrics {
  totalMediaCount: number;
  totalViews: number;
  photoCount: number;
  videoCount: number;
}

export interface DateRange {
  startDate: { year: number; month: number; day: number };
  endDate: { year: number; month: number; day: number };
}
```

2. **getPerformanceMetrics function:**
```typescript
export async function getPerformanceMetrics(
  tenantId: string,
  locationName: string, // e.g., "locations/123456"
  dateRange: DateRange
): Promise<PerformanceMetrics | null>
```

Implementation:
- Use `createAuthenticatedClient` from oauth.ts
- Call GBP Business Performance API v1:
  - Endpoint: `https://businessprofileperformance.googleapis.com/v1/{locationName}:fetchMultiDailyMetricsTimeSeries`
  - Method: GET
  - Query params:
    - dailyRange.start_date.year/month/day
    - dailyRange.end_date.year/month/day
    - dailyMetrics=BUSINESS_IMPRESSIONS_DESKTOP,BUSINESS_IMPRESSIONS_MOBILE,BUSINESS_DIRECTION_REQUESTS,CALL_CLICKS,WEBSITE_CLICKS

- Aggregate daily values into totals
- Return null on error (log but don't throw - metrics are optional)

Note: The Business Profile Performance API is separate from My Business v4. It uses different endpoints.
See: https://developers.google.com/my-business/reference/performance/rest

3. **getMediaMetrics function:**
```typescript
export async function getMediaMetrics(
  tenantId: string,
  accountId: string,
  locationId: string
): Promise<MediaMetrics | null>
```

Implementation:
- Use `createAuthenticatedClient` from oauth.ts
- Call GBP API to list media:
  - Endpoint: `https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/media`
- Count items by type
- Sum view counts if available

Note: Media views may not be available via API. Return 0 for views if not accessible.

4. **Helper: dateRangeForWeek**
```typescript
export function dateRangeForWeek(weekStartDate: Date): DateRange
```
Converts a Date (assumed Sunday) to the API's DateRange format, ending on Saturday.

5. **Helper: dateRangeForMonth**
```typescript
export function dateRangeForMonth(year: number, month: number): DateRange
```
Returns 1st to last day of month.

Add proper error handling:
- Log errors with `[google/performance]` prefix
- Return null on failure (metrics are nice-to-have, not critical)
- Don't throw - let caller handle missing data gracefully
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Function exported: grep for "export async function getPerformanceMetrics"
  </verify>
  <done>
performance.ts exists with getPerformanceMetrics, getMediaMetrics functions. Uses authenticated client. Returns typed metrics or null on error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export performance service from index</name>
  <files>src/services/google/index.ts</files>
  <action>
Update `src/services/google/index.ts` to export from performance.ts:

```typescript
export * from './performance';
```

Follow existing pattern for other exports (oauth, reviews, profile, posts, media, hours).
  </action>
  <verify>
Import test works: Can import { getPerformanceMetrics } from '../services/google'
  </verify>
  <done>
Performance service exports available from google service index.
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls src/services/google/performance.ts`
2. TypeScript compiles: `npx tsc --noEmit`
3. Exports correct: grep for function exports
</verification>

<success_criteria>
- performance.ts has getPerformanceMetrics and getMediaMetrics functions
- Both use createAuthenticatedClient for auth
- Types defined for PerformanceMetrics and MediaMetrics
- Error handling returns null (doesn't throw)
- Exported from services/google/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/08-gbp-optimization/08-02-SUMMARY.md`
</output>
