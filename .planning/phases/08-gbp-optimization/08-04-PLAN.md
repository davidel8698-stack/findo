---
phase: 08-gbp-optimization
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/routes/metrics.ts
  - src/views/metrics-dashboard.ts
  - src/routes/pages.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard shows GBP metrics: average rating, review rate, total reviews, response percentage"
    - "Dashboard shows visibility metrics: impressions, contacts, search queries"
    - "Dashboard shows content metrics: image count, image views"
    - "Owner can toggle between week-over-week and month-over-month"
    - "Cards show trend arrows (up/down compared to previous period)"
  artifacts:
    - path: "src/routes/metrics.ts"
      provides: "API endpoint for metrics data"
      exports: ["metricsRoutes"]
    - path: "src/views/metrics-dashboard.ts"
      provides: "Dashboard HTML view"
      exports: ["renderMetricsDashboard"]
  key_links:
    - from: "src/routes/pages.ts"
      to: "src/routes/metrics.ts"
      via: "route mounting"
      pattern: "metricsRoutes"
    - from: "src/views/metrics-dashboard.ts"
      to: "src/routes/metrics.ts"
      via: "API fetch"
      pattern: "fetch.*api/metrics"
---

<objective>
Create metrics dashboard API and view showing GBP performance to business owners.

Purpose: Success criteria 1-3 require dashboard display of metrics. Per CONTEXT.md: card grid layout, big numbers, trend arrows, week/month toggle, expandable charts.

Output: API endpoint returning metrics data and HTML view rendering the dashboard with cards and trends.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-gbp-optimization/08-CONTEXT.md
@.planning/phases/08-gbp-optimization/08-01-SUMMARY.md
@src/views/whatsapp-connect.ts
@src/views/google-connect.ts
@src/routes/pages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create metrics API endpoint</name>
  <files>src/routes/metrics.ts</files>
  <action>
Create `src/routes/metrics.ts`:

```typescript
import { Hono } from 'hono';
import { db } from '../db';
import { metricSnapshots, tenantBaselines } from '../db/schema';
import { eq, desc, and, gte } from 'drizzle-orm';

const app = new Hono();

// GET /api/metrics?tenantId=xxx&period=week|month
app.get('/', async (c) => {
  const tenantId = c.req.query('tenantId');
  const period = (c.req.query('period') || 'week') as 'week' | 'month';

  if (!tenantId) {
    return c.json({ error: 'tenantId required' }, 400);
  }

  // Get last 8 snapshots for trend calculation
  const snapshots = await db
    .select()
    .from(metricSnapshots)
    .where(and(
      eq(metricSnapshots.tenantId, tenantId),
      eq(metricSnapshots.period, period)
    ))
    .orderBy(desc(metricSnapshots.snapshotDate))
    .limit(8);

  // Get baseline
  const [baseline] = await db
    .select()
    .from(tenantBaselines)
    .where(eq(tenantBaselines.tenantId, tenantId))
    .limit(1);

  // Current = most recent, previous = second most recent (for trend)
  const current = snapshots[0] || null;
  const previous = snapshots[1] || null;

  // Calculate trends (positive = improved)
  const calculateTrend = (curr: number | null, prev: number | null): 'up' | 'down' | 'flat' => {
    if (curr === null || prev === null || prev === 0) return 'flat';
    const change = ((curr - prev) / prev) * 100;
    if (change > 5) return 'up';
    if (change < -5) return 'down';
    return 'flat';
  };

  const response = {
    period,
    current: current ? {
      snapshotDate: current.snapshotDate,
      // Review metrics (GBPO-01)
      totalReviews: current.totalReviews,
      averageRating: current.averageRating,
      reviewCount: current.reviewCount,
      responsePercentage: current.responsePercentage,
      // Visibility (GBPO-02)
      impressions: current.impressions,
      searches: current.searches,
      actions: current.actions,
      // Content (GBPO-03)
      imageCount: current.imageCount,
      imageViews: current.imageViews,
      // Review requests
      reviewRequestsSent: current.reviewRequestsSent,
      reviewRequestsCompleted: current.reviewRequestsCompleted,
      conversionRate: current.reviewRequestConversionRate,
    } : null,
    trends: current && previous ? {
      reviewCount: calculateTrend(current.reviewCount, previous.reviewCount),
      impressions: calculateTrend(current.impressions, previous.impressions),
      actions: calculateTrend(current.actions, previous.actions),
      imageCount: calculateTrend(current.imageCount, previous.imageCount),
      conversionRate: calculateTrend(
        Number(current.reviewRequestConversionRate),
        Number(previous.reviewRequestConversionRate)
      ),
    } : null,
    baseline: baseline ? {
      reviewRate: baseline.baselineReviewRate,
      responseRate: baseline.baselineResponseRate,
      conversionRate: baseline.baselineConversionRate,
    } : null,
    history: snapshots.map(s => ({
      date: s.snapshotDate,
      reviewCount: s.reviewCount,
      impressions: s.impressions,
      actions: s.actions,
    })),
  };

  return c.json(response);
});

export const metricsRoutes = app;
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Export exists: grep for "export const metricsRoutes"
  </verify>
  <done>
metrics.ts API returns current metrics, trends, baseline, and history for dashboard consumption.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create metrics dashboard view</name>
  <files>src/views/metrics-dashboard.ts</files>
  <action>
Create `src/views/metrics-dashboard.ts`:

Follow existing view patterns (whatsapp-connect.ts, google-connect.ts):

```typescript
export function renderMetricsDashboard(tenantId: string): string {
  return `
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Findo - מדדי ביצועים</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .trend-up { color: #22c55e; }
    .trend-down { color: #ef4444; }
    .trend-flat { color: #6b7280; }
    .metric-card {
      transition: all 0.2s;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">מדדי ביצועים</h1>
      <div class="flex gap-2">
        <button id="weekBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white" onclick="setPeriod('week')">שבועי</button>
        <button id="monthBtn" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700" onclick="setPeriod('month')">חודשי</button>
      </div>
    </div>

    <div id="loading" class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">טוען נתונים...</p>
    </div>

    <div id="dashboard" class="hidden">
      <!-- Visibility Section -->
      <h2 class="text-xl font-semibold text-gray-700 mb-4">נראות</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm">צפיות בפרופיל</p>
              <p id="impressions" class="text-3xl font-bold text-gray-800 mt-1">-</p>
            </div>
            <span id="impressionsTrend" class="text-2xl">-</span>
          </div>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm">חיפושים</p>
              <p id="searches" class="text-3xl font-bold text-gray-800 mt-1">-</p>
            </div>
            <span id="searchesTrend" class="text-2xl">-</span>
          </div>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm">פעולות</p>
              <p id="actions" class="text-3xl font-bold text-gray-800 mt-1">-</p>
            </div>
            <span id="actionsTrend" class="text-2xl">-</span>
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <h2 class="text-xl font-semibold text-gray-700 mb-4">ביקורות</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <p class="text-gray-500 text-sm">דירוג ממוצע</p>
          <p id="avgRating" class="text-3xl font-bold text-gray-800 mt-1">-</p>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm">ביקורות חדשות</p>
              <p id="reviewCount" class="text-3xl font-bold text-gray-800 mt-1">-</p>
            </div>
            <span id="reviewCountTrend" class="text-2xl">-</span>
          </div>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <p class="text-gray-500 text-sm">סה"כ ביקורות</p>
          <p id="totalReviews" class="text-3xl font-bold text-gray-800 mt-1">-</p>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <p class="text-gray-500 text-sm">אחוז מענה</p>
          <p id="responseRate" class="text-3xl font-bold text-gray-800 mt-1">-</p>
        </div>
      </div>

      <!-- Content Section -->
      <h2 class="text-xl font-semibold text-gray-700 mb-4">תוכן</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm">תמונות בפרופיל</p>
              <p id="imageCount" class="text-3xl font-bold text-gray-800 mt-1">-</p>
            </div>
            <span id="imageCountTrend" class="text-2xl">-</span>
          </div>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <p class="text-gray-500 text-sm">צפיות בתמונות</p>
          <p id="imageViews" class="text-3xl font-bold text-gray-800 mt-1">-</p>
        </div>
      </div>

      <!-- Review Requests Section -->
      <h2 class="text-xl font-semibold text-gray-700 mb-4">בקשות לביקורת</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <p class="text-gray-500 text-sm">נשלחו</p>
          <p id="requestsSent" class="text-3xl font-bold text-gray-800 mt-1">-</p>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <p class="text-gray-500 text-sm">הושלמו</p>
          <p id="requestsCompleted" class="text-3xl font-bold text-gray-800 mt-1">-</p>
        </div>
        <div class="metric-card bg-white rounded-xl p-6 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm">אחוז המרה</p>
              <p id="conversionRate" class="text-3xl font-bold text-gray-800 mt-1">-</p>
            </div>
            <span id="conversionTrend" class="text-2xl">-</span>
          </div>
        </div>
      </div>

      <!-- Baseline comparison -->
      <div id="baselineSection" class="mt-8 p-4 bg-blue-50 rounded-lg hidden">
        <h3 class="font-semibold text-blue-800 mb-2">השוואה לממוצע שלך</h3>
        <p id="baselineText" class="text-blue-700"></p>
      </div>
    </div>

    <div id="noData" class="hidden text-center py-12">
      <p class="text-gray-600">אין עדיין נתונים. הנתונים יתחילו להיאסף בשבוע הבא.</p>
    </div>
  </div>

  <script>
    const tenantId = '${tenantId}';
    let currentPeriod = 'week';

    function trendIcon(trend) {
      if (trend === 'up') return '<span class="trend-up">&#9650;</span>';
      if (trend === 'down') return '<span class="trend-down">&#9660;</span>';
      return '<span class="trend-flat">&#8212;</span>';
    }

    function formatNumber(n) {
      if (n === null || n === undefined) return '-';
      return n.toLocaleString('he-IL');
    }

    function setPeriod(period) {
      currentPeriod = period;
      document.getElementById('weekBtn').className = period === 'week'
        ? 'px-4 py-2 rounded-lg bg-blue-600 text-white'
        : 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      document.getElementById('monthBtn').className = period === 'month'
        ? 'px-4 py-2 rounded-lg bg-blue-600 text-white'
        : 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      loadMetrics();
    }

    async function loadMetrics() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('noData').classList.add('hidden');

      try {
        const res = await fetch('/api/metrics?tenantId=' + tenantId + '&period=' + currentPeriod);
        const data = await res.json();

        if (!data.current) {
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('noData').classList.remove('hidden');
          return;
        }

        // Visibility
        document.getElementById('impressions').textContent = formatNumber(data.current.impressions);
        document.getElementById('searches').textContent = formatNumber(data.current.searches);
        document.getElementById('actions').textContent = formatNumber(data.current.actions);

        // Reviews
        document.getElementById('avgRating').textContent = data.current.averageRating?.toFixed(1) || '-';
        document.getElementById('reviewCount').textContent = formatNumber(data.current.reviewCount);
        document.getElementById('totalReviews').textContent = formatNumber(data.current.totalReviews);
        document.getElementById('responseRate').textContent = data.current.responsePercentage
          ? data.current.responsePercentage.toFixed(0) + '%'
          : '-';

        // Content
        document.getElementById('imageCount').textContent = formatNumber(data.current.imageCount);
        document.getElementById('imageViews').textContent = formatNumber(data.current.imageViews);

        // Review Requests
        document.getElementById('requestsSent').textContent = formatNumber(data.current.reviewRequestsSent);
        document.getElementById('requestsCompleted').textContent = formatNumber(data.current.reviewRequestsCompleted);
        document.getElementById('conversionRate').textContent = data.current.conversionRate
          ? data.current.conversionRate.toFixed(0) + '%'
          : '-';

        // Trends
        if (data.trends) {
          document.getElementById('impressionsTrend').innerHTML = trendIcon(data.trends.impressions);
          document.getElementById('actionsTrend').innerHTML = trendIcon(data.trends.actions);
          document.getElementById('reviewCountTrend').innerHTML = trendIcon(data.trends.reviewCount);
          document.getElementById('imageCountTrend').innerHTML = trendIcon(data.trends.imageCount);
          document.getElementById('conversionTrend').innerHTML = trendIcon(data.trends.conversionRate);
        }

        // Baseline
        if (data.baseline && data.current.reviewCount !== null) {
          const diff = data.current.reviewCount - data.baseline.reviewRate;
          const pct = ((diff / data.baseline.reviewRate) * 100).toFixed(0);
          const text = diff > 0
            ? 'קצב הביקורות שלך גבוה ב-' + pct + '% מהממוצע שלך!'
            : 'קצב הביקורות שלך נמוך ב-' + Math.abs(pct) + '% מהממוצע שלך';
          document.getElementById('baselineText').textContent = text;
          document.getElementById('baselineSection').classList.remove('hidden');
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
      } catch (err) {
        console.error(err);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('noData').classList.remove('hidden');
      }
    }

    loadMetrics();
  </script>
</body>
</html>
  `;
}
```
  </action>
  <verify>
File exists: `ls src/views/metrics-dashboard.ts`
Export exists: grep for "export function renderMetricsDashboard"
  </verify>
  <done>
metrics-dashboard.ts renders Hebrew RTL dashboard with metric cards, trend arrows, period toggle, and baseline comparison.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount routes in pages</name>
  <files>src/routes/pages.ts</files>
  <action>
Update `src/routes/pages.ts` to:

1. Import metricsRoutes:
```typescript
import { metricsRoutes } from './metrics';
```

2. Import renderMetricsDashboard:
```typescript
import { renderMetricsDashboard } from '../views/metrics-dashboard';
```

3. Mount API route:
```typescript
app.route('/api/metrics', metricsRoutes);
```

4. Add page route for dashboard:
```typescript
app.get('/dashboard/metrics', (c) => {
  // In production, get tenantId from auth session
  const tenantId = c.req.query('tenantId');
  if (!tenantId) {
    return c.text('tenantId required', 400);
  }
  return c.html(renderMetricsDashboard(tenantId));
});
```
  </action>
  <verify>
grep for "metricsRoutes" in pages.ts
grep for "metrics-dashboard" in pages.ts
  </verify>
  <done>
Dashboard accessible at /dashboard/metrics?tenantId=xxx, API at /api/metrics
  </done>
</task>

</tasks>

<verification>
1. API endpoint works: curl /api/metrics?tenantId=test&period=week
2. Dashboard renders: Visit /dashboard/metrics?tenantId=xxx
3. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- API returns metrics data with trends and baseline
- Dashboard shows all 4 metric categories (visibility, reviews, content, requests)
- Period toggle switches between week/month
- Trend arrows display correctly
- Hebrew RTL layout
</success_criteria>

<output>
After completion, create `.planning/phases/08-gbp-optimization/08-04-SUMMARY.md`
</output>
