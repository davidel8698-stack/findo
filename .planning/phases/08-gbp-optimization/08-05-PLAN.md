---
phase: 08-gbp-optimization
plan: 05
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/services/optimization/alert-detector.ts
  - src/services/optimization/index.ts
  - src/queue/workers/metrics-collection.worker.ts
autonomous: true

must_haves:
  truths:
    - "Alert is sent when review rate drops significantly below baseline"
    - "Alert includes actionable suggestions"
    - "Alerts are delivered via WhatsApp"
    - "Only one alert per week (no spam)"
  artifacts:
    - path: "src/services/optimization/alert-detector.ts"
      provides: "Baseline comparison and alert triggering"
      exports: ["checkForAlerts", "sendReviewRateAlert"]
  key_links:
    - from: "src/services/optimization/alert-detector.ts"
      to: "src/services/whatsapp/client.ts"
      via: "WhatsApp message sending"
      pattern: "sendTextMessage"
    - from: "src/queue/workers/metrics-collection.worker.ts"
      to: "src/services/optimization/alert-detector.ts"
      via: "alert check after collection"
      pattern: "checkForAlerts"
---

<objective>
Create alert detection service that notifies owners when review rate drops below baseline.

Purpose: GBPO-04 and NOTF-05 require alerts when review rate drops below target. Per CONTEXT.md: dynamic baseline from business history, weekly check, actionable suggestions, WhatsApp delivery.

Output: Alert detector service integrated with metrics collection worker that sends WhatsApp notifications on performance drops.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-gbp-optimization/08-CONTEXT.md
@.planning/phases/08-gbp-optimization/08-03-SUMMARY.md
@src/services/whatsapp/client.ts
@src/services/whatsapp/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create alert detector service</name>
  <files>src/services/optimization/alert-detector.ts</files>
  <action>
Create `src/services/optimization/alert-detector.ts`:

```typescript
import { db } from '../../db';
import { metricSnapshots, tenantBaselines, tenants } from '../../db/schema';
import { eq, desc, and } from 'drizzle-orm';
import { sendTextMessage } from '../whatsapp/client';
import { whatsappConnections } from '../../db/schema';

/**
 * Alert thresholds per CONTEXT.md:
 * - Dynamic baseline from business history
 * - Alert on "significant drop" (we define as 30%+ below baseline)
 */
const ALERT_THRESHOLD_PERCENT = 30; // Alert if 30% below baseline

export interface AlertResult {
  tenantId: string;
  alertSent: boolean;
  reason?: string;
}

/**
 * Check if tenant's current metrics warrant an alert.
 * Only alerts on review rate drops (GBPO-04).
 */
export async function checkForAlerts(tenantId: string): Promise<AlertResult> {
  // Get baseline
  const [baseline] = await db
    .select()
    .from(tenantBaselines)
    .where(eq(tenantBaselines.tenantId, tenantId))
    .limit(1);

  if (!baseline || baseline.samplesCount < 4) {
    // Not enough data for baseline comparison
    return { tenantId, alertSent: false, reason: 'insufficient_baseline' };
  }

  // Get most recent snapshot
  const [currentSnapshot] = await db
    .select()
    .from(metricSnapshots)
    .where(and(
      eq(metricSnapshots.tenantId, tenantId),
      eq(metricSnapshots.period, 'week')
    ))
    .orderBy(desc(metricSnapshots.snapshotDate))
    .limit(1);

  if (!currentSnapshot) {
    return { tenantId, alertSent: false, reason: 'no_snapshot' };
  }

  // Check review rate drop
  const baselineReviewRate = Number(baseline.baselineReviewRate) || 0;
  const currentReviewRate = currentSnapshot.reviewCount || 0;

  if (baselineReviewRate === 0) {
    return { tenantId, alertSent: false, reason: 'zero_baseline' };
  }

  const dropPercent = ((baselineReviewRate - currentReviewRate) / baselineReviewRate) * 100;

  if (dropPercent < ALERT_THRESHOLD_PERCENT) {
    // No significant drop
    return { tenantId, alertSent: false, reason: 'within_threshold' };
  }

  // Significant drop detected - send alert
  const sent = await sendReviewRateAlert(tenantId, currentReviewRate, baselineReviewRate, dropPercent);

  return {
    tenantId,
    alertSent: sent,
    reason: sent ? 'alert_sent' : 'send_failed',
  };
}

/**
 * Send WhatsApp alert about review rate drop.
 * Per CONTEXT.md: Actionable content with suggestions.
 */
export async function sendReviewRateAlert(
  tenantId: string,
  currentRate: number,
  baselineRate: number,
  dropPercent: number
): Promise<boolean> {
  try {
    // Get tenant info
    const [tenant] = await db
      .select()
      .from(tenants)
      .where(eq(tenants.id, tenantId))
      .limit(1);

    if (!tenant?.ownerPhone) {
      console.log(`[alert-detector] No owner phone for tenant ${tenantId}`);
      return false;
    }

    // Get WhatsApp connection
    const [waConnection] = await db
      .select()
      .from(whatsappConnections)
      .where(and(
        eq(whatsappConnections.tenantId, tenantId),
        eq(whatsappConnections.status, 'active')
      ))
      .limit(1);

    if (!waConnection) {
      console.log(`[alert-detector] No active WhatsApp connection for tenant ${tenantId}`);
      return false;
    }

    // Compose Hebrew message with actionable suggestions
    const message = composeAlertMessage(
      tenant.businessName,
      currentRate,
      baselineRate,
      dropPercent
    );

    await sendTextMessage(
      tenantId,
      waConnection.phoneNumberId,
      tenant.ownerPhone,
      message
    );

    console.log(`[alert-detector] Alert sent to tenant ${tenantId}: ${dropPercent.toFixed(0)}% drop`);
    return true;
  } catch (error: any) {
    console.error(`[alert-detector] Failed to send alert for tenant ${tenantId}:`, error.message);
    return false;
  }
}

/**
 * Compose alert message in Hebrew with actionable suggestions.
 */
function composeAlertMessage(
  businessName: string,
  currentRate: number,
  baselineRate: number,
  dropPercent: number
): string {
  // Per CONTEXT.md: Actionable content with suggestions
  return `×©×œ×•×,

×©××ª×™ ×œ×‘ ×©×§×¦×‘ ×”×‘×™×§×•×¨×•×ª ×©×œ ${businessName} ×™×¨×“ ×”×©×‘×•×¢.

ğŸ“Š *×¡×™×›×•×:*
â€¢ ×‘×™×§×•×¨×•×ª ×”×©×‘×•×¢: ${currentRate}
â€¢ ×”×××•×¦×¢ ×©×œ×š: ${baselineRate.toFixed(1)} ×œ×©×‘×•×¢
â€¢ ×™×¨×™×“×”: ${dropPercent.toFixed(0)}%

ğŸ’¡ *××” ××¤×©×¨ ×œ×¢×©×•×ª:*
â€¢ ×œ×©×œ×•×— ×™×•×ª×¨ ×‘×§×©×•×ª ×œ×‘×™×§×•×¨×ª ×œ×œ×§×•×—×•×ª ××¨×•×¦×™×
â€¢ ×œ×‘×“×•×§ ×©×”×•×•××˜×¡××¤ ×¤×¢×™×œ ×•×©×”×•×“×¢×•×ª ×™×•×¦××•×ª
â€¢ ×œ×”×’×“×™×œ ××ª ×›××•×ª ×”×¢×¡×§××•×ª ×©× ×¡×’×¨×•×ª

×× ×™ ×××©×™×š ×œ×¢×§×•×‘ ×•×œ×¢×“×›×Ÿ ××•×ª×š.

Findo ğŸ¤–`;
}

/**
 * Check alerts for all active tenants.
 * Called from metrics collection worker after weekly collection.
 */
export async function checkAlertsForAllTenants(): Promise<{
  checked: number;
  alertsSent: number;
}> {
  // Get all active tenants with baselines
  const tenantsWithBaselines = await db
    .select({ tenantId: tenantBaselines.tenantId })
    .from(tenantBaselines)
    .innerJoin(tenants, eq(tenants.id, tenantBaselines.tenantId))
    .where(eq(tenants.status, 'active'));

  let checked = 0;
  let alertsSent = 0;

  for (const { tenantId } of tenantsWithBaselines) {
    const result = await checkForAlerts(tenantId);
    checked++;
    if (result.alertSent) alertsSent++;

    // 100ms delay between tenants
    await new Promise(r => setTimeout(r, 100));
  }

  return { checked, alertsSent };
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Functions exported: grep for "export async function checkForAlerts"
  </verify>
  <done>
alert-detector.ts exists with checkForAlerts, sendReviewRateAlert, checkAlertsForAllTenants. Uses 30% threshold, sends Hebrew WhatsApp with suggestions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update optimization service index</name>
  <files>src/services/optimization/index.ts</files>
  <action>
Update `src/services/optimization/index.ts` to export alert detector:

```typescript
export * from './metrics-collector';
export * from './alert-detector';
```
  </action>
  <verify>
Export exists: grep for "alert-detector" in index.ts
  </verify>
  <done>
Alert detector exports available from optimization service index.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate alert check into metrics collection worker</name>
  <files>src/queue/workers/metrics-collection.worker.ts</files>
  <action>
Update `src/queue/workers/metrics-collection.worker.ts` to:

1. Import checkAlertsForAllTenants:
```typescript
import { collectMetricsForAllTenants, checkAlertsForAllTenants } from '../../services/optimization';
```

2. Add alert check after collection:
```typescript
export const metricsCollectionWorker = new Worker(
  QUEUE_NAME,
  async (job: Job) => {
    if (job.name !== 'metrics-collection') return;

    console.log('[metrics-collection] Starting weekly metrics collection...');

    const collectionResult = await collectMetricsForAllTenants();

    console.log(`[metrics-collection] Collection complete: ${collectionResult.processed} processed, ${collectionResult.skipped} skipped, ${collectionResult.errors} errors`);

    // Check for alerts after collection
    console.log('[metrics-collection] Checking for alerts...');
    const alertResult = await checkAlertsForAllTenants();
    console.log(`[metrics-collection] Alerts: ${alertResult.checked} checked, ${alertResult.alertsSent} sent`);

    return {
      collection: collectionResult,
      alerts: alertResult,
    };
  },
  // ... rest of worker config
);
```
  </action>
  <verify>
grep for "checkAlertsForAllTenants" in metrics-collection.worker.ts
  </verify>
  <done>
Metrics collection worker runs alert detection after collecting metrics, sends alerts for performance drops.
  </done>
</task>

</tasks>

<verification>
1. Alert service exists: `ls src/services/optimization/alert-detector.ts`
2. Integrated with worker: grep for "checkAlertsForAllTenants" in worker
3. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- Alert triggers when review rate drops 30%+ below baseline
- WhatsApp message sent in Hebrew with suggestions
- Only checks tenants with 4+ weeks of baseline data
- Alert check runs automatically after weekly metrics collection
</success_criteria>

<output>
After completion, create `.planning/phases/08-gbp-optimization/08-05-SUMMARY.md`
</output>
