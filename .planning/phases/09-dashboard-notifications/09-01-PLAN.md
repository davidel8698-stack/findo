---
phase: 09-dashboard-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/notification-preferences.ts
  - src/db/schema/chatbot-config.ts
  - src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Notification preferences table exists with granular settings per notification type"
    - "Chatbot config table exists with JSON structure for questions"
    - "Schema exports are available in index.ts"
  artifacts:
    - path: "src/db/schema/notification-preferences.ts"
      provides: "Notification preferences table"
      contains: "notificationPreferences"
    - path: "src/db/schema/chatbot-config.ts"
      provides: "Chatbot configuration table"
      contains: "chatbotConfig"
  key_links:
    - from: "src/db/schema/index.ts"
      to: "notification-preferences.ts"
      via: "export"
      pattern: "export.*from.*notification-preferences"
---

<objective>
Create database schema for notification preferences and chatbot configuration.

Purpose: Foundation for settings management - notification preferences control which events trigger WhatsApp notifications, chatbot config allows owners to customize lead qualification questions.

Output: Two new schema files with tables and types, exported from schema index.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@src/db/schema/tenants.ts
@src/db/schema/optimization.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification preferences schema</name>
  <files>src/db/schema/notification-preferences.ts</files>
  <action>
Create notification preferences table following existing schema patterns.

Per RESEARCH.md notification preferences schema:
- One row per tenant (unique constraint on tenantId)
- Boolean flags for each notification type with sensible defaults (mostly true)
- Group by category: leads, reviews, content, system

Columns:
- id: uuid primary key
- tenantId: uuid foreign key to tenants with onDelete cascade, unique constraint
- Lead notifications: notifyNewLead (true), notifyLeadQualified (true), notifyLeadUnresponsive (true)
- Review notifications: notifyNewReview (true), notifyNegativeReview (true - always on for approval), notifyReviewPosted (false - less important)
- Content notifications: notifyPhotoRequest (true), notifyPostApproval (true)
- System notifications: notifySystemAlert (true), notifyWeeklyReport (true)
- Timestamps: createdAt, updatedAt with timezone

Export types: NotificationPreferences, NewNotificationPreferences

Follow patterns from optimization.ts (unique tenant constraint, references to tenants).
  </action>
  <verify>Run `bun run typecheck` - no type errors in new file</verify>
  <done>notification-preferences.ts exists with table definition and type exports</done>
</task>

<task type="auto">
  <name>Task 2: Create chatbot config schema</name>
  <files>src/db/schema/chatbot-config.ts</files>
  <action>
Create chatbot configuration table for customizable lead qualification questions.

Per CONTEXT.md: "Full chatbot customization - Default questions work for all businesses, but owner can change everything: add questions, edit texts, reorder"

Columns:
- id: uuid primary key
- tenantId: uuid foreign key to tenants with onDelete cascade, unique constraint
- questions: jsonb column storing array of question objects

Question JSON structure (use $type for type safety):
```typescript
interface ChatbotQuestion {
  id: string;           // Unique question identifier
  text: string;         // Hebrew question text
  expectedType: 'text' | 'phone' | 'choice';  // What kind of answer expected
  order: number;        // Display order
  isRequired: boolean;  // Whether question is required
  isActive: boolean;    // Whether question is shown
}
```

Default questions (stored as JSON default):
1. name: "איך קוראים לך?" (text, required)
2. need: "במה אוכל לעזור לך?" (text, required)
3. preference: "מתי נוח לך שנחזור אליך?" (text, optional)

Add timestamps: createdAt, updatedAt with timezone

Export types: ChatbotConfig, NewChatbotConfig, ChatbotQuestion
  </action>
  <verify>Run `bun run typecheck` - no type errors in new file</verify>
  <done>chatbot-config.ts exists with table definition and type exports</done>
</task>

<task type="auto">
  <name>Task 3: Export new schemas from index</name>
  <files>src/db/schema/index.ts</files>
  <action>
Add exports for new schema files to schema index.

Add two new export lines following existing pattern:
- export * from './notification-preferences';
- export * from './chatbot-config';

Maintain alphabetical ordering if that's the convention, otherwise add at end.
  </action>
  <verify>Run `bun run typecheck` - index.ts compiles without errors</verify>
  <done>Both new schemas are exported from index.ts</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Grep for exports: `grep -r "notificationPreferences\|chatbotConfig" src/db/schema/index.ts`
</verification>

<success_criteria>
- notification-preferences.ts has table with 10+ boolean notification flags
- chatbot-config.ts has table with jsonb questions column
- Both tables have unique tenant constraint
- Both exported from schema/index.ts
- Project typechecks
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-01-SUMMARY.md`
</output>
