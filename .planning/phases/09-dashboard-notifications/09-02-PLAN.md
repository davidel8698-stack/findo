---
phase: 09-dashboard-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/dashboard/stats-aggregator.ts
  - src/services/dashboard/health-checker.ts
  - src/routes/api/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Stats API returns calls, WhatsApp sent, reviews, and rating for selected time period"
    - "Health API returns traffic light status with component breakdown"
    - "Time period toggle supports today, week, and month"
  artifacts:
    - path: "src/services/dashboard/stats-aggregator.ts"
      provides: "Stats aggregation with date range queries"
      exports: ["getStatsForPeriod"]
    - path: "src/services/dashboard/health-checker.ts"
      provides: "Health status calculation"
      exports: ["getHealthStatus"]
    - path: "src/routes/api/dashboard.ts"
      provides: "Dashboard API endpoints"
      exports: ["dashboardApiRoutes"]
  key_links:
    - from: "src/routes/api/dashboard.ts"
      to: "src/services/dashboard/stats-aggregator.ts"
      via: "import and call"
      pattern: "getStatsForPeriod"
    - from: "src/routes/api/dashboard.ts"
      to: "src/services/dashboard/health-checker.ts"
      via: "import and call"
      pattern: "getHealthStatus"
---

<objective>
Create dashboard stats and health status API services and endpoints.

Purpose: Backend foundation for main dashboard - provides the data for stats cards and health indicator. Per CONTEXT.md: "Health status on top - Quick glance tells if everything is OK" and "Switchable time periods - Today / This Week / This Month".

Output: Stats aggregator service, health checker service, and dashboard API routes.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@src/db/schema/leads.ts
@src/db/schema/whatsapp.ts
@src/db/schema/reviews.ts
@src/db/schema/google.ts
@src/services/activity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats aggregator service</name>
  <files>src/services/dashboard/stats-aggregator.ts</files>
  <action>
Create stats aggregation service for dashboard stats cards.

Per DASH-01: "Main screen shows daily stats (calls received, unanswered, WhatsApp sent, new reviews, current rating)"
Per CONTEXT.md: "Switchable time periods - Tabs or dropdown: Today / This Week / This Month"

Implementation:
1. Define TimePeriod type: 'today' | 'week' | 'month'
2. Create getDateRange(period: TimePeriod, timezone: string) helper
   - Use Asia/Jerusalem default (from tenant.timezone)
   - 'today': midnight to now
   - 'week': Sunday midnight to now (Israeli week starts Sunday)
   - 'month': 1st of month midnight to now

3. Create getStatsForPeriod(tenantId: string, period: TimePeriod):
   - Use Promise.all for parallel queries (per RESEARCH.md pattern)
   - Count missed calls in period (from missedCalls table)
   - Count WhatsApp messages sent in period (from whatsappMessages, direction=outbound)
   - Count new reviews in period (from processedReviews, detectedAt)
   - Get current average rating (from most recent metricSnapshot or calculate from reviews)
   - Count qualified leads in period (from leads, qualifiedAt)

Return interface:
```typescript
interface DashboardStats {
  period: TimePeriod;
  missedCalls: number;
  whatsappSent: number;
  newReviews: number;
  currentRating: number | null;
  qualifiedLeads: number;
}
```

Use Drizzle ORM patterns from existing services (eq, and, gte, lte, count).
Get tenant timezone from db for accurate date ranges.
  </action>
  <verify>Run `bun run typecheck` - no errors in new file</verify>
  <done>stats-aggregator.ts exports getStatsForPeriod and returns DashboardStats</done>
</task>

<task type="auto">
  <name>Task 2: Create health checker service</name>
  <files>src/services/dashboard/health-checker.ts</files>
  <action>
Create health status service for dashboard health indicator.

Per CONTEXT.md: "Combined status display - Traffic light (green/yellow/red) PLUS component breakdown (WhatsApp checkmark, Google checkmark, Reviews warning)"

Implementation:
1. Define health status types:
```typescript
type ComponentStatus = 'ok' | 'warning' | 'error';
type OverallStatus = 'green' | 'yellow' | 'red';

interface HealthComponent {
  status: ComponentStatus;
  message?: string;
}

interface HealthStatus {
  overall: OverallStatus;
  components: {
    whatsapp: HealthComponent;
    google: HealthComponent;
    reviews: HealthComponent;
  };
}
```

2. Create getHealthStatus(tenantId: string):

WhatsApp health:
- Query whatsappConnections for tenant
- 'ok' if status = 'active'
- 'warning' if status = 'pending'
- 'error' if status = 'invalid' or 'disconnected' or no connection

Google health:
- Query googleConnections for tenant
- 'ok' if status = 'active'
- 'warning' if status = 'pending'
- 'error' if status = 'invalid' or 'disconnected' or no connection

Reviews health:
- Check for pending_approval reviews older than 24h (needs attention)
- 'warning' if any pending_approval reviews > 24h old
- 'ok' otherwise

Overall health:
- 'red' if any component is 'error'
- 'yellow' if any component is 'warning'
- 'green' if all components are 'ok'

Add descriptive Hebrew messages for each state:
- WhatsApp ok: "מחובר ופעיל"
- WhatsApp error: "נדרש חיבור מחדש"
- Google ok: "מחובר ופעיל"
- Reviews warning: "יש ביקורות שממתינות לאישור"
  </action>
  <verify>Run `bun run typecheck` - no errors in new file</verify>
  <done>health-checker.ts exports getHealthStatus and returns HealthStatus with components</done>
</task>

<task type="auto">
  <name>Task 3: Create dashboard API routes</name>
  <files>src/routes/api/dashboard.ts</files>
  <action>
Create dashboard API endpoints for stats and health.

Endpoints:
1. GET /api/dashboard/stats
   - Query params: period (today|week|month), default 'today'
   - Returns: { stats: DashboardStats }
   - Requires tenant context

2. GET /api/dashboard/health
   - No params
   - Returns: { health: HealthStatus }
   - Requires tenant context

Implementation:
- Create new Hono router: dashboardApiRoutes
- Import tenantContext middleware
- Apply tenantContext to both routes
- Call service functions with tenant.tenantId
- Return JSON responses

Error handling:
- Return 401 if no tenant context
- Return 400 if invalid period value
- Return 500 with error message on service failure

Follow patterns from src/routes/metrics.ts and src/routes/activity.ts.
  </action>
  <verify>Run `bun run typecheck` - routes compile without errors</verify>
  <done>dashboard.ts exports dashboardApiRoutes with /stats and /health endpoints</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Verify services directory created: `ls src/services/dashboard/`
3. Verify exports: `grep -r "getStatsForPeriod\|getHealthStatus\|dashboardApiRoutes" src/`
</verification>

<success_criteria>
- Stats aggregator returns counts for all required metrics
- Health checker returns traffic light with 3 components
- API endpoints accept tenant context and return JSON
- All time periods (today/week/month) work correctly
- Project typechecks
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-02-SUMMARY.md`
</output>
