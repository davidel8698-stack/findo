---
phase: 09-dashboard-notifications
plan: 03
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - src/views/dashboard/main.ts
  - src/views/dashboard/health-status.ts
  - src/views/dashboard/stats-cards.ts
  - src/views/index.ts
  - src/routes/pages.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard page shows health status traffic light at top"
    - "Dashboard page shows stats cards with switchable time periods"
    - "Dashboard is accessible at /dashboard route"
    - "UI is Hebrew RTL with proper layout"
  artifacts:
    - path: "src/views/dashboard/main.ts"
      provides: "Main dashboard page composition"
      exports: ["renderMainDashboard"]
    - path: "src/views/dashboard/health-status.ts"
      provides: "Health status component"
      exports: ["renderHealthStatus"]
    - path: "src/views/dashboard/stats-cards.ts"
      provides: "Stats cards component"
      exports: ["renderStatsCards"]
  key_links:
    - from: "src/views/dashboard/main.ts"
      to: "/api/dashboard/stats"
      via: "fetch in script"
      pattern: "fetch.*api/dashboard/stats"
    - from: "src/views/dashboard/main.ts"
      to: "/api/dashboard/health"
      via: "fetch in script"
      pattern: "fetch.*api/dashboard/health"
    - from: "src/routes/pages.ts"
      to: "src/views/dashboard/main.ts"
      via: "import and render"
      pattern: "renderMainDashboard"
    - from: "src/index.ts"
      to: "src/routes/api/dashboard.ts"
      via: "import and route mount"
      pattern: "dashboardApiRoutes"
---

<objective>
Create the main dashboard view with health status and stats cards.

Purpose: The confidence window for business owners - per CONTEXT.md "Quick glance tells if everything is OK". Shows health status at top, stats below with time period toggle.

Output: Dashboard views and route at /dashboard.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@src/views/metrics-dashboard.ts
@src/routes/pages.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health status component</name>
  <files>src/views/dashboard/health-status.ts</files>
  <action>
Create health status component following existing view patterns.

Per CONTEXT.md: "Traffic light (green/yellow/red) PLUS component breakdown (WhatsApp checkmark, Google checkmark, Reviews warning)"
Per RESEARCH.md: renderHealthStatus example pattern

Component renders:
1. Large traffic light circle (green/yellow/red background)
2. Status text in Hebrew:
   - green: "הכל תקין"
   - yellow: "יש להתייחס"
   - red: "נדרשת פעולה"
3. Component breakdown row with icons:
   - WhatsApp with checkmark/warning/X
   - Google with checkmark/warning/X
   - Reviews with checkmark/warning/X
4. Each component shows its message on hover or below

CSS classes from Tailwind:
- bg-green-500, bg-yellow-500, bg-red-500 for traffic light
- text-green-600, text-yellow-600, text-red-600 for component status
- Icons: checkmark (&#10003;), warning (&#9888;), X (&#10007;)

Export function:
```typescript
export function renderHealthStatus(health: HealthStatus): string
```

Follow HTML patterns from metrics-dashboard.ts (bg-white rounded-xl p-6 shadow-sm).
Hebrew RTL layout is automatic from parent html[dir=rtl].
  </action>
  <verify>Run `bun run typecheck` - component compiles</verify>
  <done>health-status.ts renders traffic light and component breakdown</done>
</task>

<task type="auto">
  <name>Task 2: Create stats cards component</name>
  <files>src/views/dashboard/stats-cards.ts</files>
  <action>
Create stats cards component for dashboard metrics.

Per DASH-01: "Main screen shows daily stats (calls received, unanswered, WhatsApp sent, new reviews, current rating)"
Per CONTEXT.md: "Switchable time periods - Tabs or dropdown: Today / This Week / This Month"

Component renders:
1. Period toggle buttons (היום / השבוע / החודש) at top
2. Grid of metric cards (similar to metrics-dashboard.ts pattern):
   - שיחות שלא נענו: {missedCalls}
   - הודעות WhatsApp: {whatsappSent}
   - ביקורות חדשות: {newReviews}
   - דירוג נוכחי: {currentRating} (show stars if available)
   - לידים מאושרים: {qualifiedLeads}

Card styling per metrics-dashboard.ts:
- metric-card class with hover effect
- Big number (text-3xl font-bold)
- Label above (text-gray-500 text-sm)
- Grid: 3 columns on md, 1 on mobile

Period buttons:
- Active: bg-blue-600 text-white
- Inactive: bg-gray-200 text-gray-700
- onclick calls JavaScript to reload stats

Export function:
```typescript
export function renderStatsCards(): string
```

Note: Actual data loaded via JavaScript fetch, component renders structure only.
  </action>
  <verify>Run `bun run typecheck` - component compiles</verify>
  <done>stats-cards.ts renders period toggle and metric card grid</done>
</task>

<task type="auto">
  <name>Task 3: Create main dashboard, register page route, and mount API routes</name>
  <files>src/views/dashboard/main.ts, src/views/index.ts, src/routes/pages.ts, src/index.ts</files>
  <action>
Create main dashboard page composing health and stats, register page route, and mount dashboard API.

main.ts:
1. Compose full HTML page with:
   - DOCTYPE, html lang="he" dir="rtl"
   - Head with title "Findo - לוח בקרה", Tailwind CDN
   - Body with container layout
   - Header: "לוח הבקרה" title
   - Health status section (placeholder, filled by JS)
   - Stats cards section (placeholder, filled by JS)
   - Loading state initially

2. JavaScript section:
   - Fetch /api/dashboard/health on load
   - Fetch /api/dashboard/stats?period=today on load
   - Update DOM with response data
   - Period toggle changes period param and refetches stats
   - Format numbers with he-IL locale

3. Export:
```typescript
export function renderMainDashboard(tenantId: string): string
```

index.ts (views):
- Add export: export { renderMainDashboard } from './dashboard/main';
- Also export components if needed: renderHealthStatus, renderStatsCards

pages.ts:
1. Import renderMainDashboard from views
2. Add page route:
```typescript
pagesRoutes.get('/dashboard', tenantContext, async (c) => {
  const tenant = c.get('tenant');
  if (!tenant?.tenantId) {
    return c.text('Tenant context required', 401);
  }
  return c.html(renderMainDashboard(tenant.tenantId));
});
```

src/index.ts (main app - API route mounting):
1. Import dashboardApiRoutes from './routes/api/dashboard'
2. Mount on the api router (which already has tenantContext middleware):
```typescript
// In the api routes section (around line 62-70)
import { dashboardApiRoutes } from './routes/api/dashboard';
// ...
api.route('/dashboard', dashboardApiRoutes);
```
This makes /api/dashboard/stats and /api/dashboard/health accessible.

NOTE: The API routes are mounted in src/index.ts (not pages.ts) because:
- pages.ts is for HTML page routes
- src/index.ts mounts all API routes under /api with tenantContext middleware
- This follows the existing pattern (activity, whatsapp, google routes)
  </action>
  <verify>Run `bun run typecheck` - all files compile. Start server and visit /dashboard?tenantId=xxx</verify>
  <done>Dashboard accessible at /dashboard with health and stats display, API routes mounted at /api/dashboard/*</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Manual test: Start server, visit /dashboard with X-Tenant-ID header
3. Verify API calls in browser network tab: /api/dashboard/health, /api/dashboard/stats
4. Verify API routes are mounted: `curl -H "X-Tenant-ID: test" localhost:3000/api/dashboard/health` returns JSON
</verification>

<success_criteria>
- Dashboard shows health traffic light at top
- Dashboard shows stats cards below health
- Period toggle switches between today/week/month
- Hebrew RTL layout correct
- Responsive grid on mobile
- Loading state shows while fetching
- API routes /api/dashboard/stats and /api/dashboard/health respond correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-03-SUMMARY.md`
</output>
