---
phase: 09-dashboard-notifications
plan: 04
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - src/services/dashboard/activity-grouper.ts
  - src/views/dashboard/activity-feed.ts
  - src/routes/api/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Activity feed groups related events by sourceId into journeys"
    - "Feed shows summary by default with expand for details"
    - "Type filters available: Reviews / Leads / Content / All"
    - "Feed updates in real-time via SSE"
  artifacts:
    - path: "src/services/dashboard/activity-grouper.ts"
      provides: "Activity event grouping logic"
      exports: ["groupActivityEvents", "ActivityGroup"]
    - path: "src/views/dashboard/activity-feed.ts"
      provides: "Activity feed component with grouping"
      exports: ["renderActivityFeed"]
  key_links:
    - from: "src/routes/api/dashboard.ts"
      to: "src/services/dashboard/activity-grouper.ts"
      via: "import and call"
      pattern: "groupActivityEvents"
    - from: "src/views/dashboard/activity-feed.ts"
      to: "/api/activity/stream"
      via: "EventSource connection"
      pattern: "EventSource.*api/activity/stream"
---

<objective>
Create activity feed with smart grouping and real-time updates.

Purpose: Per CONTEXT.md activity feed design: "Summary only by default", "Type filters available", "Smart grouping - Group related events", "Quick actions inline". Shows timeline of all Findo activity.

Output: Activity grouper service, activity feed view component, and API integration.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@src/services/activity.ts
@src/routes/activity.ts
@src/db/schema/activity-events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity grouper service</name>
  <files>src/services/dashboard/activity-grouper.ts</files>
  <action>
Create activity grouping service for smart event grouping.

Per CONTEXT.md: "Smart grouping - Group related events (e.g., 'Lead journey: call -> message -> qualified')"
Per RESEARCH.md ActivityGroup interface pattern

Implementation:
1. Define types:
```typescript
interface ActivityGroup {
  type: 'journey' | 'single';
  journeyType?: 'lead' | 'review' | 'content';
  sourceId: string;
  events: ActivityEvent[];
  summary: string;       // Hebrew summary
  expandedByDefault: boolean;
  latestAt: Date;        // For sorting groups
}
```

2. Create groupActivityEvents(events: ActivityEvent[]): ActivityGroup[]
   - Group events by sourceId (from activity_events.source_id)
   - Events with same sourceId become a journey group
   - Events without sourceId or unique sourceId become single items

3. Journey type detection:
   - If eventType starts with 'lead.' -> journeyType = 'lead'
   - If eventType starts with 'review.' -> journeyType = 'review'
   - If eventType starts with 'content.' or 'photo.' or 'post.' -> journeyType = 'content'

4. Generate Hebrew summary:
   - Lead journey: "ליד: {customerName} - {latestStatus}"
     e.g., "ליד: יוסי - הוסמך" or "ליד: 054... - ממתין"
   - Review journey: "ביקורת: {starRating} כוכבים מ{reviewerName}"
   - Content journey: "תוכן: {description}"
   - Single: Use event.title directly

5. Sort groups by latestAt DESC (newest first)

6. Export filter helper:
```typescript
function filterByType(groups: ActivityGroup[], filter: 'all' | 'leads' | 'reviews' | 'content'): ActivityGroup[]
```
  </action>
  <verify>Run `bun run typecheck` - service compiles</verify>
  <done>activity-grouper.ts exports groupActivityEvents and ActivityGroup type</done>
</task>

<task type="auto">
  <name>Task 2: Create activity feed component</name>
  <files>src/views/dashboard/activity-feed.ts</files>
  <action>
Create activity feed component with grouping and real-time updates.

Per CONTEXT.md: "Summary only by default - Click to expand for details", "Chronological newest first", "Type filters available - Tabs: Reviews / Leads / Content / All", "Quick actions inline"

Component structure:
1. Filter tabs at top:
   - הכל (all) | לידים (leads) | ביקורות (reviews) | תוכן (content)
   - Active tab: bg-blue-600 text-white, others: bg-gray-200

2. Activity list container:
   - Each group rendered as collapsible card
   - Summary line visible by default
   - Click to expand shows all events in group
   - Journey groups show step indicators (timeline dots)

3. Single activity item:
   - Title (from event.title)
   - Timestamp (relative: "לפני 5 דקות", "אתמול")
   - Quick action button if applicable

4. Journey group item:
   - Summary header
   - Expand/collapse toggle (▼/▲)
   - When expanded: timeline of events with timestamps

5. Quick actions (inline buttons):
   - Review pending_approval: "אשר" / "ערוך" buttons
   - Lead qualified: "צור קשר" button
   - Keep action handlers minimal - just call existing APIs

6. Real-time updates section (JavaScript):
   - Connect to existing /api/activity/stream SSE
   - On new event: prepend to feed, re-group if same sourceId
   - Keep max 100 items in DOM (per RESEARCH.md pitfall)

7. Pagination:
   - "טען עוד" button at bottom
   - Fetches next page from /api/activity?offset=X

Export:
```typescript
export function renderActivityFeed(tenantId: string): string
```

Follow styling from metrics-dashboard.ts cards.
  </action>
  <verify>Run `bun run typecheck` - component compiles</verify>
  <done>activity-feed.ts renders grouped activities with filters and real-time updates</done>
</task>

<task type="auto">
  <name>Task 3: Add activity feed API endpoint and integrate</name>
  <files>src/routes/api/dashboard.ts, src/views/dashboard/main.ts</files>
  <action>
Add grouped activity API endpoint and integrate feed into dashboard.

API endpoint in dashboard.ts:
1. GET /api/dashboard/activity
   - Query params:
     - limit (default 50)
     - offset (default 0)
     - filter (all|leads|reviews|content)
   - Calls activityService.getFeed(tenantId, { limit, offset })
   - Groups results with groupActivityEvents
   - Applies filter with filterByType
   - Returns: { groups: ActivityGroup[], hasMore: boolean }

Dashboard integration in main.ts:
1. Add activity feed section below stats cards
2. Import and use renderActivityFeed component
3. Fetch /api/dashboard/activity on load
4. Setup EventSource for /api/activity/stream
5. Handle filter tab clicks with refetch
6. Handle "load more" with offset increment

Layout update:
- Two-column layout on desktop: stats on left, activity on right
- Single column on mobile: stats above activity
- Use Tailwind grid: `grid grid-cols-1 lg:grid-cols-3 gap-6`
- Stats spans 1 col, activity spans 2 cols
  </action>
  <verify>Run `bun run typecheck` - all changes compile. Test activity feed in browser.</verify>
  <done>Activity feed shows grouped events with filters and real-time updates on dashboard</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Manual test: Create test activity events, verify grouping works
3. Test SSE: Open dashboard, create new event, verify it appears without refresh
4. Test filters: Click each tab, verify correct filtering
</verification>

<success_criteria>
- Events with same sourceId are grouped
- Groups show summary by default, expand to show details
- Filter tabs work correctly
- SSE updates appear in real-time
- Load more pagination works
- Quick action buttons present on applicable items
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-04-SUMMARY.md`
</output>
