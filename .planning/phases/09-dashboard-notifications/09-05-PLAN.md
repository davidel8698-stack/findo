---
phase: 09-dashboard-notifications
plan: 05
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - src/services/dashboard/trends-aggregator.ts
  - src/views/dashboard/reports.ts
  - src/routes/api/dashboard.ts
  - src/routes/pages.ts
autonomous: true

must_haves:
  truths:
    - "Reports page shows weekly/monthly performance trends with graphs"
    - "Chart.js renders line charts for reviews, leads, and WhatsApp metrics"
    - "Reports accessible at /dashboard/reports route"
  artifacts:
    - path: "src/services/dashboard/trends-aggregator.ts"
      provides: "Trends data aggregation from metricSnapshots"
      exports: ["getTrendsData"]
    - path: "src/views/dashboard/reports.ts"
      provides: "Reports page with Chart.js graphs"
      exports: ["renderReportsPage"]
  key_links:
    - from: "src/views/dashboard/reports.ts"
      to: "https://cdn.jsdelivr.net/npm/chart.js"
      via: "script tag CDN"
      pattern: "cdn.jsdelivr.net/npm/chart.js"
    - from: "src/routes/api/dashboard.ts"
      to: "src/services/dashboard/trends-aggregator.ts"
      via: "import and call"
      pattern: "getTrendsData"
---

<objective>
Create reports page with weekly/monthly performance graphs using Chart.js.

Purpose: Per DASH-06: "View weekly/monthly reports and performance trends with clear graphs". Owners can see how Findo is performing over time.

Output: Trends aggregator service, reports view with Chart.js, and route at /dashboard/reports.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@src/db/schema/optimization.ts
@src/views/metrics-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trends aggregator service</name>
  <files>src/services/dashboard/trends-aggregator.ts</files>
  <action>
Create trends data aggregation service for reports graphs.

Per RESEARCH.md: "Last 8 weeks for weekly, last 6 months for monthly"

Implementation:
1. Define types:
```typescript
interface TrendsData {
  labels: string[];           // Date labels for x-axis
  reviews: number[];          // Review counts
  leads: number[];            // Qualified lead counts
  whatsappSent: number[];     // WhatsApp message counts
  rating: (number | null)[];  // Average ratings (null if no data)
}

type TrendsPeriod = 'weekly' | 'monthly';
```

2. Create getTrendsData(tenantId: string, period: TrendsPeriod): Promise<TrendsData>

For weekly (last 8 weeks):
- Query metricSnapshots for tenant where period='week'
- Order by snapshotDate DESC, limit 8
- Extract: reviewCount, averageRating, reviewRequestsSent
- For leads: COUNT from leads table grouped by week (qualifiedAt)
- For whatsappSent: COUNT from whatsappMessages grouped by week (createdAt)

For monthly (last 6 months):
- Query metricSnapshots where period='month'
- Order by snapshotDate DESC, limit 6
- Similar data extraction

Labels format:
- Weekly: "שבוע 1/12" (week of month/day)
- Monthly: "ינואר", "פברואר" (Hebrew month names)

Hebrew month names array:
['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר']

Return data in chronological order (oldest first) for proper chart display.
  </action>
  <verify>Run `bun run typecheck` - service compiles</verify>
  <done>trends-aggregator.ts exports getTrendsData returning TrendsData</done>
</task>

<task type="auto">
  <name>Task 2: Create reports page with Chart.js</name>
  <files>src/views/dashboard/reports.ts</files>
  <action>
Create reports page with Chart.js line charts.

Per RESEARCH.md Chart.js pattern and CONTEXT.md RTL requirements.

Page structure:
1. HTML page with Chart.js CDN:
   `<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>`

2. Period toggle (שבועי / חודשי) at top

3. Two chart sections:
   a. "ביקורות ולידים" (Reviews and Leads):
      - Line chart with two datasets
      - Reviews: blue line (#3b82f6)
      - Leads: green line (#10b981)

   b. "הודעות ודירוג" (Messages and Rating):
      - Line chart with two datasets
      - WhatsApp sent: purple line (#8b5cf6)
      - Rating: yellow line (#f59e0b), secondary y-axis (0-5)

4. Chart.js configuration per RESEARCH.md:
```javascript
options: {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      position: 'bottom',
      rtl: true,
      textDirection: 'rtl',
    }
  },
  scales: {
    y: { beginAtZero: true }
  }
}
```

5. JavaScript to load data:
   - Fetch /api/dashboard/trends?period=weekly on load
   - Create Chart instances with data
   - Period toggle reloads with different period param

6. Empty state if no data: "אין עדיין נתונים. הנתונים יתחילו להיאסף בשבוע הבא."

Export:
```typescript
export function renderReportsPage(tenantId: string): string
```

Styling: Cards with rounded corners, shadow, matching metrics-dashboard.ts patterns.
  </action>
  <verify>Run `bun run typecheck` - component compiles</verify>
  <done>reports.ts renders page with Chart.js line charts</done>
</task>

<task type="auto">
  <name>Task 3: Add trends API endpoint and reports route</name>
  <files>src/routes/api/dashboard.ts, src/routes/pages.ts, src/views/index.ts</files>
  <action>
Add trends API endpoint and reports page route.

API endpoint in dashboard.ts:
1. GET /api/dashboard/trends
   - Query params: period (weekly|monthly), default 'weekly'
   - Calls getTrendsData(tenantId, period)
   - Returns: TrendsData JSON

Route in pages.ts:
1. Import renderReportsPage from views
2. Add route:
```typescript
pagesRoutes.get('/dashboard/reports', tenantContext, async (c) => {
  const tenant = c.get('tenant');
  if (!tenant?.tenantId) {
    return c.text('Tenant context required', 401);
  }
  return c.html(renderReportsPage(tenant.tenantId));
});
```

Export in views/index.ts:
- Add: export { renderReportsPage } from './dashboard/reports';

Navigation update in main.ts:
- Add link to reports: "דוחות מפורטים" at bottom of dashboard
- Style as subtle link: text-blue-600 hover:underline
  </action>
  <verify>Run `bun run typecheck` - all changes compile. Visit /dashboard/reports in browser.</verify>
  <done>Reports page accessible at /dashboard/reports with trend charts</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Manual test: Visit /dashboard/reports with test tenant
3. Verify charts render with Chart.js
4. Test period toggle: weekly vs monthly data
5. Verify Hebrew RTL layout and legend positioning
</verification>

<success_criteria>
- Reports page shows line charts for trends
- Weekly shows last 8 weeks of data
- Monthly shows last 6 months of data
- Period toggle works
- Charts have Hebrew labels and RTL legend
- Empty state shows when no data
- Link from main dashboard works
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-05-SUMMARY.md`
</output>
