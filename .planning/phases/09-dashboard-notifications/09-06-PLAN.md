---
phase: 09-dashboard-notifications
plan: 06
type: execute
wave: 3
depends_on: ["09-01", "09-03"]
files_modified:
  - src/services/dashboard/settings-service.ts
  - src/views/settings/timing-settings.ts
  - src/views/settings/notification-prefs.ts
  - src/views/settings/chatbot-config.ts
  - src/routes/api/settings.ts
  - src/routes/pages.ts
autonomous: true

must_haves:
  truths:
    - "Settings page allows adjusting timing settings (lead delay, review request, reminders)"
    - "Settings page allows toggling notification preferences per event type"
    - "Settings page allows full chatbot question customization"
    - "Settings accessible at /dashboard/settings route"
  artifacts:
    - path: "src/services/dashboard/settings-service.ts"
      provides: "Settings CRUD operations"
      exports: ["getSettings", "updateTimingSettings", "updateNotificationPrefs", "updateChatbotConfig"]
    - path: "src/views/settings/timing-settings.ts"
      provides: "Timing settings component"
      exports: ["renderTimingSettings"]
    - path: "src/views/settings/notification-prefs.ts"
      provides: "Notification preferences component"
      exports: ["renderNotificationPrefs"]
    - path: "src/views/settings/chatbot-config.ts"
      provides: "Chatbot configuration component"
      exports: ["renderChatbotConfig"]
  key_links:
    - from: "src/routes/api/settings.ts"
      to: "src/services/dashboard/settings-service.ts"
      via: "import and call"
      pattern: "updateTimingSettings|updateNotificationPrefs"
---

<objective>
Create settings pages for timing, notifications, and chatbot customization.

Purpose: Per DASH-07 and DASH-08 - owners can customize wait times, notification preferences, and chatbot questions. Per CONTEXT.md: "Findo defaults are optimized, but owner can access settings to change individual timings".

Output: Settings service, three settings views, API endpoints, and route at /dashboard/settings.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@.planning/phases/09-dashboard-notifications/09-01-SUMMARY.md
@src/db/schema/optimization.ts
@src/db/schema/notification-preferences.ts
@src/db/schema/chatbot-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings service</name>
  <files>src/services/dashboard/settings-service.ts</files>
  <action>
Create settings service for CRUD operations on all settings tables.

Implementation:
1. getSettings(tenantId: string): Fetch all settings for tenant
   - Query optimizationConfig for timing settings
   - Query notificationPreferences for notification flags
   - Query chatbotConfig for questions
   - Return combined object, creating defaults if not exist

2. updateTimingSettings(tenantId: string, settings):
   - Upsert optimizationConfig
   - Fields: reviewRequestDelayHours, reviewReminderDelayDays
   - Validate ranges (delay: 12-72 hours, reminder: 1-7 days)
   - Update updatedAt timestamp

3. updateNotificationPrefs(tenantId: string, prefs):
   - Upsert notificationPreferences
   - Accept partial update (only provided fields)
   - Validate all fields are boolean
   - Update updatedAt timestamp

4. updateChatbotConfig(tenantId: string, questions: ChatbotQuestion[]):
   - Upsert chatbotConfig
   - Validate question structure (id, text, expectedType, order)
   - Ensure at least one required question exists
   - Update updatedAt timestamp

5. Default values on first access:
   - Timing: 24h delay, 3 day reminder (from optimization.ts defaults)
   - Notifications: all true except notifyReviewPosted (false)
   - Chatbot: 3 default questions (name, need, preference)

Use Drizzle upsert pattern: onConflictDoUpdate with tenantId constraint.
  </action>
  <verify>Run `bun run typecheck` - service compiles</verify>
  <done>settings-service.ts exports getSettings and update functions</done>
</task>

<task type="auto">
  <name>Task 2: Create settings view components</name>
  <files>src/views/settings/timing-settings.ts, src/views/settings/notification-prefs.ts, src/views/settings/chatbot-config.ts</files>
  <action>
Create three settings view components.

timing-settings.ts:
Per CONTEXT.md: "Timing settings adjustable - Findo defaults are optimized, but owner can access settings to change individual timings"

Form fields:
- Review request delay (select: 12/24/48/72 hours) - "שעות המתנה לפני בקשת ביקורת"
- Review reminder delay (select: 1/2/3/5/7 days) - "ימים לתזכורת ביקורת"
- Note: "ברירות המחדל של Findo מותאמות לרוב העסקים"

notification-prefs.ts:
Per CONTEXT.md: "Granular notification preferences - Choose exactly which events trigger WhatsApp notifications"

Toggle groups:
1. לידים (Leads):
   - ליד חדש (notifyNewLead)
   - ליד הוסמך (notifyLeadQualified)
   - ליד לא הגיב (notifyLeadUnresponsive)

2. ביקורות (Reviews):
   - ביקורת חדשה (notifyNewReview)
   - ביקורת שלילית (notifyNegativeReview) - disabled, always on
   - ביקורת פורסמה (notifyReviewPosted)

3. תוכן (Content):
   - בקשת תמונות (notifyPhotoRequest)
   - אישור פוסט (notifyPostApproval)

4. מערכת (System):
   - התראות מערכת (notifySystemAlert)
   - דוח שבועי (notifyWeeklyReport)

Each toggle: switch input with label, grouped in cards.

chatbot-config.ts:
Per CONTEXT.md: "Full chatbot customization - owner can change everything: add questions, edit texts, reorder"

Features:
- List of questions with drag handle for reorder
- Each question editable: text input, type dropdown (text/phone/choice)
- Required toggle per question
- Active toggle per question
- Add question button
- Delete question button (trash icon)
- Preview section showing how questions will appear

All components export render function returning HTML string.
Styling consistent with dashboard: cards, Tailwind, Hebrew RTL.
  </action>
  <verify>Run `bun run typecheck` - all components compile</verify>
  <done>Three settings components render forms with proper controls</done>
</task>

<task type="auto">
  <name>Task 3: Create settings API and page route</name>
  <files>src/routes/api/settings.ts, src/routes/pages.ts, src/views/settings/main.ts, src/views/index.ts</files>
  <action>
Create settings API endpoints, main settings page, and route.

settings.ts API routes:
1. GET /api/settings - Get all settings
2. PUT /api/settings/timing - Update timing settings
3. PUT /api/settings/notifications - Update notification prefs
4. PUT /api/settings/chatbot - Update chatbot config

All endpoints require tenant context, return JSON.
Validate request bodies, return 400 on invalid input.

main.ts settings page:
1. Tab navigation: תזמון | התראות | צ'אטבוט (timing|notifications|chatbot)
2. Content area shows active tab component
3. JavaScript:
   - Fetch GET /api/settings on load
   - Populate forms with current values
   - On form change: PUT to relevant endpoint
   - Show save confirmation toast
   - Handle errors with Hebrew message

4. Save button per section: "שמור שינויים"
5. Reset to defaults button: "אפס לברירת מחדל"

pages.ts route:
```typescript
pagesRoutes.get('/dashboard/settings', tenantContext, async (c) => {
  const tenant = c.get('tenant');
  if (!tenant?.tenantId) {
    return c.text('Tenant context required', 401);
  }
  return c.html(renderSettingsPage(tenant.tenantId));
});

// Mount settings API
pagesRoutes.route('/api/settings', settingsRoutes);
```

views/index.ts:
- Export renderSettingsPage

Navigation in main dashboard:
- Add "הגדרות" link to dashboard header/footer
  </action>
  <verify>Run `bun run typecheck` - all changes compile. Test settings page in browser.</verify>
  <done>Settings page accessible at /dashboard/settings with all three tabs working</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Manual test: Visit /dashboard/settings
3. Test timing settings save and load
4. Test notification toggles save and persist
5. Test chatbot question add/edit/delete/reorder
6. Verify settings persist across page refresh
</verification>

<success_criteria>
- Timing settings adjustable with sensible ranges
- Notification preferences toggleable per type
- Chatbot questions fully customizable
- Settings persist to database
- Forms pre-populate with current values
- Save confirmation shown
- Link from main dashboard works
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-06-SUMMARY.md`
</output>
