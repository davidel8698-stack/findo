---
phase: 09-dashboard-notifications
plan: 07
type: execute
wave: 4
depends_on: ["09-03", "09-04"]
files_modified:
  - src/views/dashboard/review-approval.ts
  - src/views/dashboard/photo-upload.ts
  - src/views/dashboard/post-content.ts
  - src/routes/api/dashboard.ts
  - src/views/dashboard/main.ts
autonomous: true

must_haves:
  truths:
    - "Owner can approve/edit negative review responses from dashboard"
    - "Owner can upload photos when system requests from dashboard"
    - "Owner can enter promotional content from dashboard"
    - "Dashboard actions mirror WhatsApp capabilities"
  artifacts:
    - path: "src/views/dashboard/review-approval.ts"
      provides: "Review approval modal/form"
      exports: ["renderReviewApproval"]
    - path: "src/views/dashboard/photo-upload.ts"
      provides: "Photo upload interface"
      exports: ["renderPhotoUpload"]
    - path: "src/views/dashboard/post-content.ts"
      provides: "Post content form"
      exports: ["renderPostContent"]
  key_links:
    - from: "src/routes/api/dashboard.ts"
      to: "src/services/review/reply-poster.ts"
      via: "import and call"
      pattern: "postReviewReply"
    - from: "src/routes/api/dashboard.ts"
      to: "src/services/media/gbp-upload.ts"
      via: "import and call"
      pattern: "uploadToGBP"
---

<objective>
Create dashboard action interfaces for review approval, photo upload, and post content.

Purpose: Per CONTEXT.md: "Dashboard mirrors all WhatsApp capabilities". DASH-03, DASH-04, DASH-05 require owners to be able to perform these actions from dashboard as alternative to WhatsApp.

Output: Three action components, API endpoints for each action, integration into dashboard.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-RESEARCH.md
@.planning/phases/05-review-management/05-05-SUMMARY.md
@.planning/phases/07-gbp-content/07-03-SUMMARY.md
@.planning/phases/07-gbp-content/07-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review approval component and API</name>
  <files>src/views/dashboard/review-approval.ts, src/routes/api/dashboard.ts</files>
  <action>
Create review approval interface matching WhatsApp flow.

Per DASH-03: "Approve/edit negative review responses before posting"

review-approval.ts component:
1. Modal/card showing:
   - Review details (reviewer name, star rating, comment)
   - Draft reply text (editable textarea)
   - "אשר ופרסם" (approve) button
   - "שמור טיוטה" (save draft) button
   - "בטל" (cancel) button

2. Display pending reviews list:
   - Filter processedReviews where status='pending_approval'
   - Each shows: reviewer, rating, time waiting
   - Click to expand and see draft reply

API endpoints in dashboard.ts:
1. GET /api/dashboard/pending-reviews
   - Returns list of pending_approval reviews for tenant
   - Include: reviewId, reviewerName, starRating, comment, draftReply, approvalSentAt

2. POST /api/dashboard/review/:reviewId/approve
   - Body: { customReply?: string } - optional edited text
   - If customReply: use it, set status='edited'
   - If no customReply: use draftReply, set status='approved'
   - Call existing postReviewReply from review/reply-poster.ts
   - Return success/error

Integration:
- Import postReviewReply from existing service
- Follow same logic as owner-response-handler.ts (Phase 5)

Export:
```typescript
export function renderReviewApproval(): string
```
  </action>
  <verify>Run `bun run typecheck` - component and API compile</verify>
  <done>Review approval component and /approve endpoint work</done>
</task>

<task type="auto">
  <name>Task 2: Create photo upload component and API</name>
  <files>src/views/dashboard/photo-upload.ts, src/routes/api/dashboard.ts</files>
  <action>
Create photo upload interface as alternative to WhatsApp.

Per DASH-04: "Upload photos when system requests"

photo-upload.ts component:
1. Show current photo request status:
   - If pending: "Findo מבקש תמונות מהשבוע"
   - If none: "אין בקשות פתוחות"

2. Upload area:
   - Drag & drop zone
   - "בחר קבצים" button
   - Accept: image/jpeg, image/png
   - Max size: 10MB
   - Preview thumbnails before upload

3. Upload progress indicator
4. Success/error messages

API endpoints in dashboard.ts:
1. GET /api/dashboard/photo-request
   - Check for pending photo_requests for tenant
   - Return: { hasPending: boolean, requestId?: string, requestedAt?: Date }

2. POST /api/dashboard/photo/upload
   - Content-Type: multipart/form-data
   - Accept image file
   - Validate image (size, type, not blurry per existing logic)
   - Upload to R2 (existing uploadToR2 service)
   - Upload to GBP (existing uploadToGBP service)
   - Update photo_requests status to 'uploaded'
   - Return success with image URL

Integration:
- Import validateImage from media/image-validator.ts
- Import uploadToR2 from media/r2-upload.ts
- Import uploadToGBP from media/gbp-upload.ts
- Follow same flow as photo-handler.ts (Phase 7)

Export:
```typescript
export function renderPhotoUpload(): string
```
  </action>
  <verify>Run `bun run typecheck` - component and API compile</verify>
  <done>Photo upload component and /upload endpoint work</done>
</task>

<task type="auto">
  <name>Task 3: Create post content form and integrate actions</name>
  <files>src/views/dashboard/post-content.ts, src/routes/api/dashboard.ts, src/views/dashboard/main.ts</files>
  <action>
Create post content form and integrate all actions into dashboard.

Per DASH-05: "Enter promotional content for monthly posts"

post-content.ts component:
1. Show current post request status:
   - If pending approval: Show draft post with approve/edit options
   - If awaiting content: Form to enter promotional content
   - If none pending: "הפוסט הבא יתוזמן ל-{date}"

2. Content form:
   - Textarea for promotional content (Hebrew, 1500 char limit)
   - Character counter
   - "צור פוסט" button (generates AI post from content)
   - Preview of generated post

3. Approval section (if draft exists):
   - Show draft post text
   - "אשר ופרסם" button
   - "ערוך" button (enables editing)

API endpoints in dashboard.ts:
1. GET /api/dashboard/post-request
   - Check for pending monthly_posts for tenant
   - Return: { hasPending: boolean, post?: { content, isSafe, createdAt } }

2. POST /api/dashboard/post/generate
   - Body: { content: string } - owner's promotional content
   - Call existing AI post generator
   - Create monthly_posts record with status 'pending_approval'
   - Return generated post

3. POST /api/dashboard/post/:postId/approve
   - Body: { customContent?: string }
   - Publish to GBP
   - Update post status
   - Return success

Integration into main.ts:
1. Add "פעולות" section below activity feed
2. Show cards for:
   - Pending reviews count with "לביקורות" link
   - Photo request status with "העלה תמונה" link
   - Post status with "תוכן חודשי" link
3. Each links to modal or expands inline

JavaScript for modals:
- Fetch action data on click
- Show relevant component in modal overlay
- Handle form submissions with fetch POST
- Close modal and refresh on success

Export:
```typescript
export function renderPostContent(): string
```
  </action>
  <verify>Run `bun run typecheck` - all changes compile. Test each action flow.</verify>
  <done>All three action components work and are accessible from dashboard</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Manual test: Create pending review, approve from dashboard
3. Manual test: Upload photo from dashboard
4. Manual test: Enter post content from dashboard
5. Verify actions update database and call existing services
</verification>

<success_criteria>
- Review approval from dashboard posts to Google
- Photo upload from dashboard uploads to GBP
- Post content from dashboard generates and publishes
- All flows use existing services (no duplicate logic)
- Actions section visible on main dashboard
- Modal/inline interactions work smoothly
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-07-SUMMARY.md`
</output>
