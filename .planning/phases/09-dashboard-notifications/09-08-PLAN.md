---
phase: 09-dashboard-notifications
plan: 08
type: execute
wave: 4
depends_on: ["09-06"]
files_modified:
  - src/services/notification-gate.ts
  - src/queue/workers/lead-notify.worker.ts
  - src/queue/workers/review-notify.worker.ts
  - src/queue/workers/photo-request.worker.ts
  - src/queue/workers/post-approval.worker.ts
autonomous: true

must_haves:
  truths:
    - "Notification workers check preferences before sending WhatsApp"
    - "Owner can control which events trigger notifications"
    - "Preferences are respected across all notification types"
  artifacts:
    - path: "src/services/notification-gate.ts"
      provides: "Notification preference checking"
      exports: ["shouldNotify", "NotificationType"]
    - path: "src/queue/workers/lead-notify.worker.ts"
      provides: "Lead notification with preference check"
      contains: "shouldNotify"
  key_links:
    - from: "src/queue/workers/lead-notify.worker.ts"
      to: "src/services/notification-gate.ts"
      via: "import and call"
      pattern: "shouldNotify"
    - from: "src/queue/workers/review-notify.worker.ts"
      to: "src/services/notification-gate.ts"
      via: "import and call"
      pattern: "shouldNotify"
---

<objective>
Integrate notification preferences into all notification workers.

Purpose: Per NOTF-01: "Most interactions via WhatsApp to business owner" but with granular control. Per CONTEXT.md: "Granular notification preferences - Choose exactly which events trigger WhatsApp notifications". This plan wires up the notification preferences schema to actual notification delivery.

Output: Notification gate service, updated workers that check preferences before sending.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-dashboard-notifications/09-CONTEXT.md
@.planning/phases/09-dashboard-notifications/09-01-SUMMARY.md
@.planning/phases/09-dashboard-notifications/09-06-SUMMARY.md
@src/db/schema/notification-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification gate service</name>
  <files>src/services/notification-gate.ts</files>
  <action>
Create notification gate service that checks preferences before notifications.

Implementation:
1. Define notification types enum:
```typescript
enum NotificationType {
  NEW_LEAD = 'newLead',
  LEAD_QUALIFIED = 'leadQualified',
  LEAD_UNRESPONSIVE = 'leadUnresponsive',
  NEW_REVIEW = 'newReview',
  NEGATIVE_REVIEW = 'negativeReview',
  REVIEW_POSTED = 'reviewPosted',
  PHOTO_REQUEST = 'photoRequest',
  POST_APPROVAL = 'postApproval',
  SYSTEM_ALERT = 'systemAlert',
  WEEKLY_REPORT = 'weeklyReport',
}
```

2. Create shouldNotify(tenantId: string, type: NotificationType): Promise<boolean>
   - Query notificationPreferences for tenant
   - If no record exists, create with defaults (most notifications ON)
   - Map NotificationType to preference column:
     - NEW_LEAD -> notifyNewLead
     - LEAD_QUALIFIED -> notifyLeadQualified
     - etc.
   - Return boolean value

3. Special case: NEGATIVE_REVIEW always returns true
   (Per CONTEXT.md: owner must approve negative review responses)

4. Cache preferences briefly (1 minute) to avoid repeated DB queries:
```typescript
const prefsCache = new Map<string, { prefs: NotificationPreferences, expiresAt: number }>();
```

5. Export helper to get all preferences for tenant:
```typescript
async function getNotificationPreferences(tenantId: string): Promise<NotificationPreferences>
```

Log when notification blocked: `[notification-gate] Blocked ${type} for tenant ${tenantId} (preference disabled)`
  </action>
  <verify>Run `bun run typecheck` - service compiles</verify>
  <done>notification-gate.ts exports shouldNotify and NotificationType</done>
</task>

<task type="auto">
  <name>Task 2: Update lead and review notification workers</name>
  <files>src/queue/workers/lead-notify.worker.ts, src/queue/workers/review-notify.worker.ts</files>
  <action>
Add preference checks to lead and review notification workers.

lead-notify.worker.ts updates:
1. Import shouldNotify and NotificationType from notification-gate
2. At start of notification job, check preferences:
```typescript
// Determine notification type based on lead status
let notificationType: NotificationType;
if (job.name === 'lead-new') {
  notificationType = NotificationType.NEW_LEAD;
} else if (job.name === 'lead-qualified') {
  notificationType = NotificationType.LEAD_QUALIFIED;
} else if (job.name === 'lead-unresponsive') {
  notificationType = NotificationType.LEAD_UNRESPONSIVE;
}

const shouldSend = await shouldNotify(tenantId, notificationType);
if (!shouldSend) {
  console.log(`[lead-notify] Skipping notification (preference disabled)`);
  return; // Exit early, don't send WhatsApp
}
```
3. Continue with existing WhatsApp send logic if shouldNotify returns true

review-notify.worker.ts updates:
1. Import shouldNotify and NotificationType
2. Check preferences before owner notification:
```typescript
const notificationType = review.isPositive
  ? NotificationType.NEW_REVIEW
  : NotificationType.NEGATIVE_REVIEW;  // This will always pass

const shouldSend = await shouldNotify(tenantId, notificationType);
if (!shouldSend) {
  console.log(`[review-notify] Skipping notification (preference disabled)`);
  return;
}
```
3. For REVIEW_POSTED (after reply posts), also check:
```typescript
const shouldNotifyPosted = await shouldNotify(tenantId, NotificationType.REVIEW_POSTED);
if (shouldNotifyPosted) {
  // Send "reply posted" confirmation
}
```

Keep existing functionality intact - just add early return if preference disabled.
  </action>
  <verify>Run `bun run typecheck` - workers compile</verify>
  <done>Lead and review workers check preferences before sending</done>
</task>

<task type="auto">
  <name>Task 3: Update content and system notification workers</name>
  <files>src/queue/workers/photo-request.worker.ts, src/queue/workers/post-approval.worker.ts, src/queue/workers/auto-tuning.worker.ts</files>
  <action>
Add preference checks to content and system notification workers.

photo-request.worker.ts updates:
1. Import shouldNotify, NotificationType
2. Before sending photo request WhatsApp:
```typescript
const shouldSend = await shouldNotify(tenantId, NotificationType.PHOTO_REQUEST);
if (!shouldSend) {
  console.log(`[photo-request] Skipping notification (preference disabled)`);
  // Still create photo_request record, just don't send WhatsApp
  // Owner can see request in dashboard
  return;
}
```

post-approval.worker.ts updates:
1. Import shouldNotify, NotificationType
2. Before sending post approval request:
```typescript
const shouldSend = await shouldNotify(tenantId, NotificationType.POST_APPROVAL);
if (!shouldSend) {
  console.log(`[post-approval] Skipping notification (preference disabled)`);
  // Post will auto-publish after timeout if isSafe
  return;
}
```

auto-tuning.worker.ts updates (weekly summary):
1. Import shouldNotify, NotificationType
2. Before sending weekly summary:
```typescript
const shouldSend = await shouldNotify(tenantId, NotificationType.WEEKLY_REPORT);
if (!shouldSend) {
  console.log(`[auto-tuning] Skipping weekly summary (preference disabled)`);
  return;
}
```

Alert notifications (system alerts):
- Find where alert notifications are sent (likely alert-detection or metrics workers)
- Add check for NotificationType.SYSTEM_ALERT
- System alerts should default to ON but be disableable

Pattern: Early return if preference disabled, keeping rest of worker logic unchanged.
  </action>
  <verify>Run `bun run typecheck` - all workers compile</verify>
  <done>All notification workers respect preferences</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `bun run typecheck` - Full project compiles
2. Unit test: Create tenant with notifyNewLead=false, verify no WhatsApp sent
3. Test: Toggle preference in settings, verify next notification respects it
4. Verify NEGATIVE_REVIEW notifications always send regardless of preference
</verification>

<success_criteria>
- NotificationType enum covers all notification types
- shouldNotify correctly queries preferences
- All notification workers import and use shouldNotify
- Disabled preferences result in skipped notifications
- Negative review always notifies (safety requirement)
- Workers log when notifications are skipped
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboard-notifications/09-08-SUMMARY.md`
</output>
