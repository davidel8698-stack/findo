---
phase: 10-setup-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/billing.ts
  - src/db/schema/index.ts
  - drizzle/0011_billing_setup.sql
autonomous: true

must_haves:
  truths:
    - "Billing tables exist in database (subscriptions, payments, setup_progress)"
    - "Schema supports PayPlus token storage for recurring billing"
    - "Setup progress tracks wizard state across sessions"
  artifacts:
    - path: "src/db/schema/billing.ts"
      provides: "Billing schema (subscriptions, payments, setup_progress tables)"
      exports: ["subscriptions", "payments", "setupProgress", "subscriptionStatusEnum"]
    - path: "drizzle/0011_billing_setup.sql"
      provides: "Migration for billing tables"
      contains: "CREATE TABLE"
  key_links:
    - from: "src/db/schema/billing.ts"
      to: "src/db/schema/tenants.ts"
      via: "foreign key reference"
      pattern: "references.*tenants"
    - from: "src/db/schema/index.ts"
      to: "src/db/schema/billing.ts"
      via: "re-export"
      pattern: "export.*from.*billing"
---

<objective>
Create database schema for billing and setup wizard progress tracking.

Purpose: Foundation for payment processing and multi-step wizard state management. Without these tables, the setup wizard cannot persist progress and billing cannot track subscriptions.

Output: billing.ts schema with subscriptions, payments, and setupProgress tables, plus Drizzle migration.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-setup-billing/10-RESEARCH.md

# Existing schema patterns
@src/db/schema/tenants.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing schema</name>
  <files>src/db/schema/billing.ts</files>
  <action>
Create billing.ts with three tables following existing schema patterns:

1. **subscriptionStatusEnum** - pgEnum with values:
   - 'trial' (14-day trial)
   - 'pending_payment' (setup fee not paid)
   - 'active' (paying customer)
   - 'past_due' (payment failed, grace period)
   - 'cancelled' (subscription ended)

2. **subscriptions** table:
   - id: uuid primaryKey defaultRandom
   - tenantId: uuid notNull references tenants.id (onDelete cascade) unique
   - payplusCustomerId: varchar(100) nullable (PayPlus customer reference)
   - payplusTokenId: varchar(100) nullable (for recurring charges)
   - status: subscriptionStatusEnum default 'trial' notNull
   - setupFeePaid: boolean default false notNull
   - monthlyAmountAgorot: integer default 35000 notNull (350 NIS = 35000 agorot)
   - setupFeeAgorot: integer default 350000 notNull (3500 NIS)
   - trialEndsAt: timestamp with timezone nullable
   - currentPeriodStart: timestamp with timezone nullable
   - currentPeriodEnd: timestamp with timezone nullable
   - nextBillingDate: timestamp with timezone nullable
   - createdAt, updatedAt: standard timestamps

3. **payments** table:
   - id: uuid primaryKey defaultRandom
   - tenantId: uuid notNull references tenants.id (onDelete cascade)
   - subscriptionId: uuid nullable references subscriptions.id
   - payplusTransactionId: varchar(100) nullable
   - amountAgorot: integer notNull
   - currency: varchar(3) default 'ILS' notNull
   - type: varchar(20) notNull ('setup_fee', 'subscription', 'manual')
   - status: varchar(20) notNull ('pending', 'completed', 'failed', 'refunded')
   - cardLast4: varchar(4) nullable
   - cardBrand: varchar(20) nullable ('visa', 'mastercard', 'isracard')
   - failureReason: varchar(500) nullable
   - retryCount: integer default 0
   - createdAt, paidAt: timestamps

4. **setupProgress** table:
   - id: uuid primaryKey defaultRandom
   - tenantId: uuid notNull references tenants.id (onDelete cascade) unique
   - currentStep: integer default 1 notNull (1-5)
   - stepData: jsonb nullable (partial form data per step)
   - completedAt: timestamp with timezone nullable
   - createdAt, updatedAt: standard timestamps

Export types: Subscription, NewSubscription, Payment, NewPayment, SetupProgress, NewSetupProgress

Follow existing patterns from tenants.ts - use drizzle-orm/pg-core imports without .js extension.
  </action>
  <verify>npx tsc --noEmit src/db/schema/billing.ts</verify>
  <done>billing.ts compiles without errors, exports all tables and types</done>
</task>

<task type="auto">
  <name>Task 2: Update schema index and generate migration</name>
  <files>src/db/schema/index.ts, drizzle/0011_billing_setup.sql</files>
  <action>
1. Update src/db/schema/index.ts to export billing schema:
   - Add: export * from './billing';

2. Generate Drizzle migration:
   - Run: npx drizzle-kit generate
   - This creates the SQL migration file
   - Verify migration file exists in drizzle/ directory

3. Apply migration to database:
   - Run: npx drizzle-kit push
   - Verify tables exist in database

Note: Migration filename may vary (0011_*.sql or similar). The important thing is the migration is generated and applied.
  </action>
  <verify>
Run: npx drizzle-kit push --verbose
Check output shows billing tables created/updated without errors.
Query database: SELECT table_name FROM information_schema.tables WHERE table_name IN ('subscriptions', 'payments', 'setup_progress');
  </verify>
  <done>Schema index exports billing, migration applied, three new tables exist in database</done>
</task>

</tasks>

<verification>
- [ ] billing.ts exists with subscriptions, payments, setupProgress tables
- [ ] All tables reference tenants.id with proper foreign keys
- [ ] subscriptionStatusEnum has 5 status values
- [ ] setupProgress has stepData jsonb for wizard state
- [ ] Schema index exports billing module
- [ ] Database migration applied successfully
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. `npx tsc --noEmit` passes for billing schema
2. Database contains subscriptions, payments, setup_progress tables
3. Foreign key constraints exist to tenants table
4. Schema can be imported: `import { subscriptions, payments, setupProgress } from './db/schema'`
</success_criteria>

<output>
After completion, create `.planning/phases/10-setup-billing/10-01-SUMMARY.md`
</output>
