---
phase: 10-setup-billing
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/routes/setup/index.ts
  - src/views/setup/step-1-business.ts
  - src/views/setup/step-2-whatsapp.ts
  - src/views/setup/step-3-google.ts
  - src/views/setup/layout.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /setup and see step 1 form"
    - "Business info form collects name, type, owner name, address, hours"
    - "Form submission saves progress and advances to step 2"
    - "WhatsApp step shows Connect button (reuses existing Embedded Signup)"
    - "Google step shows Connect button (reuses existing OAuth)"
    - "Steps 1-3 render with Hebrew RTL layout"
  artifacts:
    - path: "src/routes/setup/index.ts"
      provides: "Setup wizard routing (GET/POST for steps 1-3)"
      exports: ["setupRoutes"]
    - path: "src/views/setup/step-1-business.ts"
      provides: "Business info form (Hebrew)"
      exports: ["renderStep1Business"]
    - path: "src/views/setup/step-2-whatsapp.ts"
      provides: "WhatsApp connection step"
      exports: ["renderStep2WhatsApp"]
    - path: "src/views/setup/step-3-google.ts"
      provides: "Google connection step"
      exports: ["renderStep3Google"]
  key_links:
    - from: "src/routes/setup/index.ts"
      to: "src/db/schema/billing.ts"
      via: "setupProgress table queries"
      pattern: "setupProgress"
    - from: "src/views/setup/step-2-whatsapp.ts"
      to: "src/views/whatsapp-connect.ts"
      via: "reuses Embedded Signup JS"
      pattern: "launchWhatsAppSignup"
---

<objective>
Create setup wizard routes and views for steps 1-3 (business info, WhatsApp, Google).

Purpose: First half of the 2-minute setup wizard. User enters minimal business info, then connects WhatsApp and Google in one click each. Progress saved server-side for durability.

Output: Setup routes handling GET/POST for steps 1-3, Hebrew RTL views for each step.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-setup-billing/10-RESEARCH.md

# Existing patterns
@src/routes/pages.ts
@src/views/whatsapp-connect.ts
@src/views/google-connect.ts
@src/db/schema/billing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup wizard layout and step 1</name>
  <files>src/views/setup/layout.ts, src/views/setup/step-1-business.ts</files>
  <action>
1. Create src/views/setup/layout.ts - shared wizard layout:
   - HTML boilerplate with Hebrew RTL (lang="he" dir="rtl")
   - Tailwind CSS via CDN
   - Progress indicator showing steps 1-5 with current step highlighted
   - Responsive container (max-w-lg, centered, p-6)
   - Export: renderSetupLayout(step: number, content: string, title: string)

2. Create src/views/setup/step-1-business.ts:
   - Form collecting:
     * businessName (required, min 2 chars)
     * businessType (dropdown: plumber, electrician, garage, general contractor, other)
     * ownerName (required, min 2 chars)
     * ownerEmail (required, valid email format)
     * ownerPhone (optional but recommended, Israeli format 05X)
     * address (textarea, optional)
     * businessHours (7 day checkboxes with open/close time selects)
   - Hebrew labels and placeholders
   - Validation messages in Hebrew
   - Submit button: "המשך" (Continue)
   - Form action: POST /setup/step/1
   - Export: renderStep1Business(prefill?: Partial<Step1Data>)

Business hours UI:
- Checkbox per day (Sunday first - Israeli week)
- Time select dropdowns (7:00-22:00 in 30-min increments)
- "Copy to all" button for convenience
- Hebrew day names: ראשון, שני, שלישי, רביעי, חמישי, שישי, שבת
  </action>
  <verify>npx tsc --noEmit src/views/setup/layout.ts src/views/setup/step-1-business.ts</verify>
  <done>Layout renders progress indicator, step 1 form has all fields with Hebrew labels</done>
</task>

<task type="auto">
  <name>Task 2: Create steps 2-3 views (WhatsApp & Google)</name>
  <files>src/views/setup/step-2-whatsapp.ts, src/views/setup/step-3-google.ts</files>
  <action>
1. Create src/views/setup/step-2-whatsapp.ts:
   - Uses layout wrapper with step=2
   - Headline: "חיבור WhatsApp"
   - Subtext: "חברו את מספר WhatsApp העסקי שלכם בלחיצה אחת"
   - Large "Connect WhatsApp" button (Hebrew: "חבר WhatsApp")
   - Include Meta Embedded Signup SDK script (same as whatsapp-connect.ts)
   - Include launchWhatsAppSignup JS function
   - On success callback: redirect to /setup/step/2/callback?code=...
   - Skip option: "אין לי WhatsApp עסקי - אדלג" -> advances to step 3
   - Status indicator showing connected/not connected
   - Export: renderStep2WhatsApp(tenantId: string, appId: string, configId: string, connected: boolean)

2. Create src/views/setup/step-3-google.ts:
   - Uses layout wrapper with step=3
   - Headline: "חיבור Google Business Profile"
   - Subtext: "חברו את פרופיל העסק ב-Google בלחיצה אחת"
   - Large "Connect Google" button (Hebrew: "חבר Google")
   - Button triggers: fetch('/api/google/auth-url').then(redirect)
   - On success: /setup/step/3/callback handles OAuth return
   - Skip option: "אין לי פרופיל עסקי - אדלג" -> advances to step 4
   - Status indicator showing connected/not connected
   - Export: renderStep3Google(tenantId: string, connected: boolean)

Both views should:
- Show checkmark icon if already connected
- Disable button if already connected with "מחובר!" text
- Include "חזרה" (Back) link to previous step
  </action>
  <verify>npx tsc --noEmit src/views/setup/step-2-whatsapp.ts src/views/setup/step-3-google.ts</verify>
  <done>Step 2 embeds WhatsApp Signup SDK, Step 3 has Google OAuth trigger, both have skip options</done>
</task>

<task type="auto">
  <name>Task 3: Create setup routes for steps 1-3</name>
  <files>src/routes/setup/index.ts</files>
  <action>
Create src/routes/setup/index.ts with Hono router:

1. **GET /setup** - Redirect to current step based on progress:
   - Query setupProgress for tenantId
   - If no progress, create with step=1
   - Redirect to /setup/step/{currentStep}

2. **GET /setup/step/:step** - Render step view:
   - Validate step is 1-5
   - Load setupProgress and prefill data
   - For step 1: render step-1-business with prefill
   - For step 2: check whatsappConnections, render with status
   - For step 3: check googleConnections, render with status
   - (Steps 4-5 handled in next plan)

3. **POST /setup/step/1** - Save business info:
   - Parse form data with zod validation (step1Schema from RESEARCH.md)
   - Upsert tenant record with business info
   - Update setupProgress: currentStep=2, stepData includes step1
   - Redirect to /setup/step/2

4. **GET /setup/step/2/callback** - WhatsApp callback:
   - Handle Embedded Signup success (code param)
   - Import and call the existing whatsappCallbackHandler from routes/whatsapp/callback.ts
   - Do NOT duplicate token exchange logic - call the existing handler directly:
     ```typescript
     import { handleWhatsAppCallback } from '../whatsapp/callback';
     // In route handler:
     const result = await handleWhatsAppCallback(c.req.query('code'), tenantId);
     ```
   - After successful callback: Update setupProgress: currentStep=3
   - Redirect to /setup/step/3
   - If callback fails: render step 2 with error message

5. **POST /setup/step/2/skip** - Skip WhatsApp:
   - Update setupProgress: currentStep=3
   - Redirect to /setup/step/3

6. **GET /setup/step/3/callback** - Google callback:
   - Modify the Google OAuth initiation to include state parameter with setup context:
     ```typescript
     // When triggering OAuth from step 3, add state:
     const state = JSON.stringify({ tenantId, returnTo: '/setup/step/3/callback' });
     const authUrl = await getGoogleAuthUrl(state);
     ```
   - This route receives OAuth callback with code and state params
   - Import and call existing Google OAuth handler:
     ```typescript
     import { handleGoogleCallback } from '../api/google/oauth';
     const result = await handleGoogleCallback(c.req.query('code'), tenantId);
     ```
   - After successful callback: Update setupProgress: currentStep=4
   - Redirect to /setup/step/4
   - If callback fails: render step 3 with error message

   NOTE: The existing Google OAuth flow (routes/api/google.ts) must be modified to:
   - Accept state parameter in OAuth URL generation
   - Parse state in callback to get returnTo URL
   - Redirect to returnTo URL instead of hardcoded /connect/google

7. **POST /setup/step/3/skip** - Skip Google:
   - Update setupProgress: currentStep=4
   - Redirect to /setup/step/4

Middleware:
- For now, accept tenantId via query param or create new tenant in step 1
- In step 1, either use existing tenantId or create new tenant from form data

Use existing patterns from routes/pages.ts for tenant context handling.
  </action>
  <verify>
npx tsc --noEmit src/routes/setup/index.ts
Start dev server and test: curl http://localhost:3000/setup?tenantId=test-uuid
  </verify>
  <done>Setup routes handle GET/POST for steps 1-3, saves progress to database, redirects correctly</done>
</task>

</tasks>

<verification>
- [ ] GET /setup redirects to current step
- [ ] Step 1 form renders with all business fields in Hebrew
- [ ] Step 1 POST validates and saves to tenant + setupProgress
- [ ] Step 2 renders WhatsApp Embedded Signup button
- [ ] Step 2 skip advances to step 3
- [ ] Step 3 renders Google OAuth button
- [ ] Step 3 skip advances to step 4
- [ ] Progress indicator shows correct step highlighted
- [ ] All views are Hebrew RTL
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. User can complete steps 1-3 of setup wizard
2. Business info saved to tenants table
3. Progress persists in setupProgress table (resume works)
4. WhatsApp/Google connection steps work or can be skipped
5. All text in Hebrew with RTL layout
</success_criteria>

<output>
After completion, create `.planning/phases/10-setup-billing/10-02-SUMMARY.md`
</output>
