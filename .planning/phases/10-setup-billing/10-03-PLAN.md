---
phase: 10-setup-billing
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/views/setup/step-4-telephony.ts
  - src/views/setup/step-5-billing.ts
  - src/views/setup/complete.ts
  - src/routes/setup/index.ts
autonomous: true

must_haves:
  truths:
    - "User can select telephony option (new/transfer/current)"
    - "User sees billing step with setup fee and monthly subscription info"
    - "After completing step 5, user sees success page"
    - "Success page shows 'Findo is now working in the background'"
    - "Telephony options have clear time expectations"
  artifacts:
    - path: "src/views/setup/step-4-telephony.ts"
      provides: "Telephony selection UI with 3 options"
      exports: ["renderStep4Telephony"]
    - path: "src/views/setup/step-5-billing.ts"
      provides: "Billing info and payment button"
      exports: ["renderStep5Billing"]
    - path: "src/views/setup/complete.ts"
      provides: "Setup complete success page"
      exports: ["renderSetupComplete"]
  key_links:
    - from: "src/routes/setup/index.ts"
      to: "src/views/setup/step-4-telephony.ts"
      via: "route handler renders view"
      pattern: "renderStep4Telephony"
    - from: "src/views/setup/complete.ts"
      to: "/dashboard"
      via: "redirect link"
      pattern: "href.*dashboard"
---

<objective>
Create setup wizard steps 4-5 (telephony, billing) and success page.

Purpose: Complete the 2-minute setup wizard. User selects phone option, sees billing info, then sees confirmation that Findo is working. This fulfills SETUP-04, SETUP-05 requirements.

Output: Steps 4-5 views, success page, extended routes for final wizard steps.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועلם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-setup-billing/10-RESEARCH.md

# Existing patterns
@src/views/setup/layout.ts
@src/routes/setup/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step 4 telephony view</name>
  <files>src/views/setup/step-4-telephony.ts</files>
  <action>
Create src/views/setup/step-4-telephony.ts with three-option selection:

1. **Option: New Number** (value="new")
   - Icon: phone emoji or SVG
   - Title: "מספר חדש מ-Voicenter"
   - Subtitle: "מספר ישראלי חדש - מופעל מיד"
   - Time expectation: "פעיל תוך דקות"

2. **Option: Transfer Existing** (value="transfer")
   - Icon: arrows/transfer emoji or SVG
   - Title: "העברת מספר קיים"
   - Subtitle: "נעביר את המספר הנוכחי שלכם"
   - Time expectation: "3-5 ימי עבודה"
   - Shows conditional input for existing number when selected

3. **Option: Use Current Mobile** (value="current")
   - Icon: mobile emoji or SVG
   - Title: "שימוש בנייד הנוכחי"
   - Subtitle: "נגדיר העברת שיחות מהנייד שלכם"
   - Time expectation: "פעיל תוך דקות"
   - Shows conditional input for mobile number when selected

UI requirements:
- Radio button group with card-style selection (peer-checked pattern from RESEARCH.md)
- Conditional phone input appears when transfer/current selected
- Phone input with Israeli format hint (05X-XXXXXXX)
- Validation: if not "new", phone number required
- Submit button: "המשך לתשלום"
- Back link to step 3
- Form action: POST /setup/step/4

Export: renderStep4Telephony(selected?: 'new' | 'transfer' | 'current', existingNumber?: string)
  </action>
  <verify>npx tsc --noEmit src/views/setup/step-4-telephony.ts</verify>
  <done>Three telephony options render with clear time expectations, conditional phone input works</done>
</task>

<task type="auto">
  <name>Task 2: Create step 5 billing view and complete page</name>
  <files>src/views/setup/step-5-billing.ts, src/views/setup/complete.ts</files>
  <action>
1. Create src/views/setup/step-5-billing.ts:
   - Headline: "תשלום והפעלה"
   - Summary box showing:
     * Setup fee: 3,500 NIS (one-time)
     * Monthly: 350 NIS/month
     * Total first payment: 3,850 NIS
   - Payment button: "לתשלום מאובטח" (opens PayPlus hosted page)
   - Button triggers: POST /setup/step/5/pay -> redirects to PayPlus
   - Security badges (PCI DSS, SSL lock icon)
   - Hebrew disclaimer: "התשלום מאובטח בסטנדרט PCI DSS"
   - Back link to step 4
   - Trial option (if applicable): "התחל תקופת ניסיון" - starts 14-day trial

   Export: renderStep5Billing(tenantId: string, setupFee: number, monthlyFee: number)

2. Create src/views/setup/complete.ts (from RESEARCH.md pattern):
   - Success animation (green checkmark in circle)
   - Headline: "מעולה! Findo עובד עבורכם"
   - Subtext: "מעכשיו Findo פועל ברקע 24/7. אין צורך לעשות שום דבר - פשוט תמשיכו לעבוד."
   - "What's happening now" box listing:
     * Missed calls -> WhatsApp to caller
     * New reviews -> Auto-reply on Google
     * Review requests -> Sent after service
   - CTA button: "לצפייה בלוח הבקרה" -> /dashboard
   - Footer text: "תקבלו עדכונים ב-WhatsApp כשיהיו דברים שצריכים את תשומת לבכם"

   Export: renderSetupComplete(tenantId: string, businessName?: string)
  </action>
  <verify>npx tsc --noEmit src/views/setup/step-5-billing.ts src/views/setup/complete.ts</verify>
  <done>Step 5 shows pricing and payment button, complete page shows success with dashboard link</done>
</task>

<task type="auto">
  <name>Task 3: Add routes for steps 4-5</name>
  <files>src/routes/setup/index.ts</files>
  <action>
Extend src/routes/setup/index.ts with step 4-5 handlers:

1. **GET /setup/step/4** - Render telephony step:
   - Load setupProgress for prefill
   - Render renderStep4Telephony with any saved selection

2. **POST /setup/step/4** - Save telephony choice:
   - Parse form: telephonyOption (enum), existingNumber (optional)
   - Validate: if option is transfer/current, existingNumber required
   - Save to setupProgress.stepData.telephony
   - Update currentStep=5
   - Redirect to /setup/step/5

3. **GET /setup/step/5** - Render billing step:
   - Load tenant and subscription (or create subscription record)
   - Render renderStep5Billing with fees

4. **POST /setup/step/5/pay** - Initiate payment:
   - Create payment record with status='pending'
   - Generate PayPlus payment page URL (placeholder for now - full impl in plan 04)
   - Redirect to PayPlus hosted page
   - For now: redirect to /setup/complete (payment integration in next plan)

5. **POST /setup/step/5/trial** - Start trial:
   - Set subscription status='trial', trialEndsAt=now+14 days
   - Mark setupProgress.completedAt
   - Redirect to /setup/complete

6. **GET /setup/complete** - Render success page:
   - Load tenant for business name
   - Render renderSetupComplete

Add validation schemas:
```typescript
const step4Schema = z.object({
  telephonyOption: z.enum(['new', 'transfer', 'current']),
  existingNumber: z.string().optional(),
}).refine(
  (data) => data.telephonyOption === 'new' || (data.existingNumber && data.existingNumber.length >= 9),
  { message: 'יש להזין מספר טלפון', path: ['existingNumber'] }
);
```
  </action>
  <verify>
npx tsc --noEmit src/routes/setup/index.ts
Test: curl -X POST http://localhost:3000/setup/step/4 -d "telephonyOption=new"
  </verify>
  <done>Steps 4-5 routes save progress, step 5 can start trial, complete page renders</done>
</task>

</tasks>

<verification>
- [ ] Step 4 shows three telephony options with time expectations
- [ ] Conditional phone input appears for transfer/current options
- [ ] Step 4 POST validates and saves choice
- [ ] Step 5 shows pricing (3,500 + 350)
- [ ] Step 5 has payment and trial buttons
- [ ] Trial starts with 14-day period
- [ ] Complete page shows "Findo is working" message
- [ ] Dashboard link works from complete page
- [ ] All Hebrew RTL layout correct
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. User can select telephony option with clear time expectations
2. User sees accurate billing summary (3,500 NIS setup + 350 NIS/month)
3. Trial option available (14-day trial)
4. Complete page confirms Findo is active
5. Full wizard flow works end-to-end (steps 1-5 + complete)
</success_criteria>

<output>
After completion, create `.planning/phases/10-setup-billing/10-03-SUMMARY.md`
</output>
