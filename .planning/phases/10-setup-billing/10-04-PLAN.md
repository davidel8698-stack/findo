---
phase: 10-setup-billing
plan: 04
type: execute
wave: 3
depends_on: ["10-01", "10-03"]
files_modified:
  - src/services/billing/payplus.ts
  - src/routes/billing/index.ts
  - src/routes/billing/webhook.ts
autonomous: false
user_setup:
  - service: payplus
    why: "Israeli payment processing"
    env_vars:
      - name: PAYPLUS_API_KEY
        source: "PayPlus Dashboard -> Settings -> API Keys"
      - name: PAYPLUS_SECRET_KEY
        source: "PayPlus Dashboard -> Settings -> API Keys"
      - name: PAYPLUS_TERMINAL_UID
        source: "PayPlus Dashboard -> Terminals"
    dashboard_config:
      - task: "Create webhook endpoint"
        location: "PayPlus Dashboard -> Settings -> Webhooks -> Add https://yourdomain.com/billing/webhook"
      - task: "Enable token billing"
        location: "PayPlus Dashboard -> Terminal Settings -> Enable recurring payments"

must_haves:
  truths:
    - "PayPlus API client can create hosted payment pages"
    - "Payment webhook receives and processes PayPlus callbacks"
    - "Successful payment creates token for recurring billing"
    - "Subscription status updates based on payment result"
    - "Setup fee and monthly subscription can be charged"
  artifacts:
    - path: "src/services/billing/payplus.ts"
      provides: "PayPlus API client (payment pages, token billing)"
      exports: ["createPaymentPage", "chargeWithToken", "PayPlusConfig"]
    - path: "src/routes/billing/index.ts"
      provides: "Billing routes (payment initiation)"
      exports: ["billingRoutes"]
    - path: "src/routes/billing/webhook.ts"
      provides: "PayPlus webhook handler"
      exports: ["billingWebhookRoutes"]
  key_links:
    - from: "src/services/billing/payplus.ts"
      to: "PayPlus API"
      via: "REST API calls"
      pattern: "fetch.*payplus.*api"
    - from: "src/routes/billing/webhook.ts"
      to: "src/db/schema/billing.ts"
      via: "payment status update"
      pattern: "payments.*update"
---

<objective>
Implement PayPlus payment integration for setup fee and recurring subscriptions.

Purpose: Israeli businesses need to pay 3,500 NIS setup + 350 NIS/month. PayPlus handles card processing with PCI compliance. This fulfills BILL-01, BILL-02, BILL-03.

Output: PayPlus API client, billing routes for payment flow, webhook handler for payment confirmations.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-setup-billing/10-RESEARCH.md

# Dependencies
@src/db/schema/billing.ts
@src/routes/setup/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PayPlus API client</name>
  <files>src/services/billing/payplus.ts</files>
  <action>
Create src/services/billing/payplus.ts with PayPlus REST API integration:

1. **Configuration:**
```typescript
interface PayPlusConfig {
  apiKey: string;       // PAYPLUS_API_KEY
  secretKey: string;    // PAYPLUS_SECRET_KEY
  terminalUid: string;  // PAYPLUS_TERMINAL_UID
  sandbox: boolean;     // Use sandbox URL for testing
}

const config: PayPlusConfig = {
  apiKey: process.env.PAYPLUS_API_KEY || '',
  secretKey: process.env.PAYPLUS_SECRET_KEY || '',
  terminalUid: process.env.PAYPLUS_TERMINAL_UID || '',
  sandbox: process.env.NODE_ENV !== 'production',
};

const BASE_URL = config.sandbox
  ? 'https://restapidev.payplus.co.il/api/v1.0'
  : 'https://restapi.payplus.co.il/api/v1.0';
```

2. **createPaymentPage** - Generate hosted payment URL:
   - Endpoint: POST /PaymentPages/generateLink
   - Parameters:
     * tenantId (customer reference)
     * amount (in agorot)
     * currency: 'ILS'
     * description
     * successUrl, failureUrl, callbackUrl (webhook)
     * chargeMethod: 3 for token creation, 5 for token + charge
   - Returns: { paymentPageUrl, transactionUid }

3. **chargeWithToken** - Recurring charge:
   - Endpoint: POST /Transactions/ChargeByToken
   - Parameters:
     * tokenUid (from initial payment)
     * amount (in agorot)
     * currency: 'ILS'
   - Returns: { success, transactionUid, approvalNumber }

4. **getAuthHeaders** - PayPlus auth format:
```typescript
function getAuthHeaders() {
  return {
    'Authorization': JSON.stringify({
      api_key: config.apiKey,
      secret_key: config.secretKey,
    }),
    'Content-Type': 'application/json',
  };
}
```

5. **verifyWebhookSignature** - Validate webhook authenticity:
   - PayPlus sends signature in header
   - Verify using HMAC-SHA256 with secret key
   - Return boolean

Export: createPaymentPage, chargeWithToken, verifyWebhookSignature, PayPlusConfig
  </action>
  <verify>npx tsc --noEmit src/services/billing/payplus.ts</verify>
  <done>PayPlus client can create payment pages and charge tokens, auth headers formatted correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create billing routes</name>
  <files>src/routes/billing/index.ts</files>
  <action>
Create src/routes/billing/index.ts with payment initiation routes:

1. **POST /billing/initiate-payment** - Start setup fee payment:
   - Get tenantId from request (query param or session)
   - Calculate amount: setupFee (350000 agorot) + firstMonth (35000 agorot) = 385000 agorot
   - Create payment record: status='pending', type='setup_fee', amount=385000
   - Call createPaymentPage with:
     * chargeMethod: 5 (token + charge)
     * successUrl: /billing/success
     * failureUrl: /billing/failure
     * callbackUrl: /billing/webhook
   - Return redirect to PayPlus hosted page

2. **GET /billing/success** - Payment success handler:
   - PayPlus redirects here after successful payment
   - Show success message (Hebrew)
   - Link to complete setup: /setup/complete
   - Note: Actual payment confirmation comes via webhook

3. **GET /billing/failure** - Payment failure handler:
   - PayPlus redirects here on failure
   - Show error message (Hebrew): "התשלום נכשל. אנא נסו שנית או פנו לתמיכה."
   - Retry button -> /setup/step/5
   - Contact support link

4. **POST /billing/charge-monthly** - Charge recurring (for subscription worker):
   - Get tenantId and tokenId from subscriptions table
   - Call chargeWithToken with monthly amount (35000 agorot)
   - Create payment record
   - Return success/failure status

Routes should use Hono router pattern from existing routes.
  </action>
  <verify>npx tsc --noEmit src/routes/billing/index.ts</verify>
  <done>Billing routes initiate payment, handle success/failure redirects, support monthly charging</done>
</task>

<task type="auto">
  <name>Task 3: Create PayPlus webhook handler</name>
  <files>src/routes/billing/webhook.ts</files>
  <action>
Create src/routes/billing/webhook.ts for PayPlus IPN (Instant Payment Notification):

1. **POST /billing/webhook** - PayPlus callback:
   - Verify webhook signature (verifyWebhookSignature)
   - If invalid signature, return 401 and log warning
   - Parse payload: transaction_uid, status, token_uid, amount, etc.
   - Find payment by payplusTransactionId
   - Update payment status:
     * status='000' (approved) -> status='completed', paidAt=now
     * status != '000' -> status='failed', failureReason from response
   - If approved and token_uid present:
     * Update subscription: payplusTokenId=token_uid, status='active', setupFeePaid=true
     * Set currentPeriodStart=now, currentPeriodEnd=now+1month, nextBillingDate=now+1month
   - Mark setupProgress.completedAt if this was setup payment
   - Return 200 OK (always, to acknowledge receipt)

**Error Handling Strategy:**
   - If signature verification fails: return 401, log warning, do NOT update database
   - If payment lookup fails (not found): return 200, log warning (prevents retries for orphan webhooks)
   - If database update fails: return 500 to trigger PayPlus retry
     * PayPlus will retry failed webhooks up to 5 times with exponential backoff
     * This ensures eventual consistency - better to retry than lose payment confirmation
   - Wrap all database operations in try/catch:
     ```typescript
     try {
       await db.update(payments).set({ status: 'completed', paidAt: new Date() }).where(...);
       await db.update(subscriptions).set({ ... }).where(...);
       return c.text('OK', 200);
     } catch (error) {
       console.error('Webhook DB error:', error);
       return c.text('DB error', 500); // Trigger PayPlus retry
     }
     ```
   - Log all webhook attempts with correlation ID (transaction_uid) for debugging

2. **Idempotency:**
   - Check if payment already processed (status='completed')
   - If already processed, return 200 without re-processing

3. **Logging:**
   - Log all webhook calls with transaction_uid
   - Log signature verification result
   - Log payment status updates

PayPlus webhook payload structure (from docs):
```typescript
interface PayPlusWebhook {
  transaction_uid: string;
  status_code: string;       // '000' = approved
  token_uid?: string;        // Present if token created
  approval_num?: string;
  amount: number;
  currency_code: string;
  customer?: { customer_uid: string };
  more_info?: string;
}
```
  </action>
  <verify>npx tsc --noEmit src/routes/billing/webhook.ts</verify>
  <done>Webhook validates signatures, updates payment/subscription status, handles idempotency</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PayPlus payment integration (API client, routes, webhook)</what-built>
  <how-to-verify>
1. Start dev server
2. Navigate to /setup and complete steps 1-4
3. On step 5, click "Pay" button
4. Verify redirect to PayPlus sandbox payment page
5. Complete test payment (use PayPlus sandbox test card)
6. Verify redirect back to success page
7. Check database: subscription has tokenId, status='active'
8. Check payments table: payment has status='completed'

Note: Requires PAYPLUS_* environment variables configured.
If env vars not set, payment initiation will show error.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] PayPlus client creates hosted payment pages
- [ ] Auth headers use correct JSON format
- [ ] Payment initiation creates pending payment record
- [ ] Success/failure redirects work
- [ ] Webhook validates signatures
- [ ] Webhook updates payment status correctly
- [ ] Token saved to subscription on success
- [ ] Subscription status changes to 'active' on payment
- [ ] Monthly charge function works with saved token
- [ ] Idempotency prevents duplicate processing
</verification>

<success_criteria>
1. User can pay setup fee (3,500 NIS) + first month (350 NIS) via PayPlus
2. Payment token saved for recurring billing
3. Subscription status updated to 'active' after payment
4. Webhook securely processes PayPlus callbacks
5. Failed payments show user-friendly Hebrew error
</success_criteria>

<output>
After completion, create `.planning/phases/10-setup-billing/10-04-SUMMARY.md`
</output>
