---
phase: 10-setup-billing
plan: 05
type: execute
wave: 3
depends_on: ["10-01"]
files_modified:
  - src/services/progressive-profile/questions.ts
  - src/services/progressive-profile/service.ts
  - src/queue/workers/progressive-profile.worker.ts
  - src/queue/jobs/progressive-profile.job.ts
autonomous: true

must_haves:
  truths:
    - "Progressive profiling questions defined for weeks 1-4"
    - "Weekly job sends one profiling question via WhatsApp"
    - "System tracks answered questions to avoid repeats"
    - "After 2 ignored questions, system stops asking"
    - "Owner responses are processed and stored"
  artifacts:
    - path: "src/services/progressive-profile/questions.ts"
      provides: "Question definitions for weeks 1-4"
      exports: ["PROGRESSIVE_QUESTIONS", "getQuestionForWeek"]
    - path: "src/services/progressive-profile/service.ts"
      provides: "Profile service (check answered, store answers)"
      exports: ["hasAnswered", "storeAnswer", "getNextQuestion"]
    - path: "src/queue/workers/progressive-profile.worker.ts"
      provides: "Worker that sends profiling questions"
      exports: ["progressiveProfileWorker"]
  key_links:
    - from: "src/queue/workers/progressive-profile.worker.ts"
      to: "src/services/whatsapp/client.ts"
      via: "sends WhatsApp message"
      pattern: "sendWhatsAppMessage"
    - from: "src/services/progressive-profile/service.ts"
      to: "src/db/schema/tenants.ts"
      via: "stores answers in tenant record"
      pattern: "tenants.*update"
---

<objective>
Implement progressive profiling via WhatsApp to collect additional business details post-setup.

Purpose: Keep initial setup minimal (2 minutes) while gradually collecting richer business data. Questions sent weekly via WhatsApp, max 4 questions total. Fulfills SETUP-06.

Output: Question definitions, profiling service, weekly worker that sends questions.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-setup-billing/10-RESEARCH.md

# Existing patterns
@src/queue/workers/review-request.worker.ts
@src/services/whatsapp/client.ts
@src/db/schema/tenants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profiling questions and service</name>
  <files>src/services/progressive-profile/questions.ts, src/services/progressive-profile/service.ts</files>
  <action>
1. Create src/services/progressive-profile/questions.ts:

```typescript
export interface ProgressiveQuestion {
  week: number;           // 1-4
  question: string;       // Hebrew question text
  field: string;          // Where to store answer (e.g., 'services', 'uniqueValue')
  type: 'text' | 'quick_reply';
  options?: string[];     // For quick_reply type
}

export const PROGRESSIVE_QUESTIONS: ProgressiveQuestion[] = [
  {
    week: 1,
    question: 'מה השירותים העיקריים שאתם מציעים? (לדוגמה: תיקוני צנרת, התקנת דוד שמש...)',
    field: 'services',
    type: 'text',
  },
  {
    week: 2,
    question: 'מה מייחד את העסק שלכם מהמתחרים?',
    field: 'uniqueValue',
    type: 'text',
  },
  {
    week: 3,
    question: 'יש לכם חניה ללקוחות? נגישות לנכים?',
    field: 'amenities',
    type: 'quick_reply',
    options: ['יש חניה', 'יש נגישות', 'שניהם', 'אף אחד'],
  },
  {
    week: 4,
    question: 'האם יש ימים או שעות שבהם העסק סגור באופן קבוע? (חגים, ימי שישי...)',
    field: 'specialClosures',
    type: 'text',
  },
];

export function getQuestionForWeek(week: number): ProgressiveQuestion | undefined {
  return PROGRESSIVE_QUESTIONS.find(q => q.week === week);
}
```

2. Create src/services/progressive-profile/service.ts:

- **getWeeksSinceSetup(tenantId)** - Calculate weeks since tenant setup completed
- **hasAnswered(tenantId, field)** - Check if specific field has been answered
- **getIgnoreCount(tenantId)** - Count consecutive ignored questions
- **incrementIgnoreCount(tenantId)** - Track ignored question
- **resetIgnoreCount(tenantId)** - Reset on answer received
- **storeAnswer(tenantId, field, value)** - Save answer to tenant profile
- **getNextQuestion(tenantId)** - Get next unanswered question for current week

Store profile answers in tenants table using new JSONB column 'profileData' or extend existing fields.

For tracking ignores: use new field profilingIgnoreCount in tenants or setupProgress.stepData.

Export all functions.
  </action>
  <verify>npx tsc --noEmit src/services/progressive-profile/questions.ts src/services/progressive-profile/service.ts</verify>
  <done>Questions defined for 4 weeks, service tracks answered/ignored state</done>
</task>

<task type="auto">
  <name>Task 2: Create profiling worker and job scheduler</name>
  <files>src/queue/workers/progressive-profile.worker.ts, src/queue/jobs/progressive-profile.job.ts</files>
  <action>
1. Create src/queue/jobs/progressive-profile.job.ts:

```typescript
import { scheduledQueue } from '../queues';

export const PROGRESSIVE_PROFILE_JOB = 'progressive-profile-check';

// Schedule weekly check on Monday at 10:00 AM Israel time
export async function scheduleProgressiveProfilingJob() {
  await scheduledQueue.add(
    PROGRESSIVE_PROFILE_JOB,
    {},
    {
      repeat: {
        pattern: '0 10 * * 1', // Monday 10:00 AM
        tz: 'Asia/Jerusalem',
      },
    }
  );
}
```

2. Create src/queue/workers/progressive-profile.worker.ts:

- Process PROGRESSIVE_PROFILE_JOB:
  1. Get all tenants with status='active' and setupProgress.completedAt exists
  2. For each tenant:
     a. Check getIgnoreCount - if >= 2, skip (stop asking)
     b. Calculate weeksSinceSetup
     c. Get question for this week (if any)
     d. Check if already answered for this field
     e. If not answered, send WhatsApp message with question
  3. Include 100ms delay between tenants (rate limiting)

- Worker registration:
```typescript
export const progressiveProfileWorker = new Worker(
  'scheduled',
  async (job) => {
    if (job.name !== PROGRESSIVE_PROFILE_JOB) return;
    // ... processing logic
  },
  { connection: redis, concurrency: 1 }
);
```

WhatsApp message format:
- Text message (not template): question text directly
- For quick_reply: use interactive message with buttons

Handle responses in message handler:
- Add pattern matching in src/queue/workers/whatsapp-message.worker.ts
- Check if message is a profile question response (within 24h of asking)
- Call storeAnswer and resetIgnoreCount on response
- Send confirmation: "תודה! השמרנו את המידע."
  </action>
  <verify>npx tsc --noEmit src/queue/workers/progressive-profile.worker.ts src/queue/jobs/progressive-profile.job.ts</verify>
  <done>Worker sends weekly questions, respects ignore limit, handles responses</done>
</task>

<task type="auto">
  <name>Task 3: Integrate response handling in message worker</name>
  <files>src/queue/workers/whatsapp-message.worker.ts</files>
  <action>
Update src/queue/workers/whatsapp-message.worker.ts to handle profile question responses:

1. Add import for progressive profile service
2. Add check in message processing flow (after lead handling, before review handling):

```typescript
// Check for progressive profile response
const profileQuestion = await getPendingProfileQuestion(tenantId);
if (profileQuestion && !leadResponse && !reviewResponse) {
  // This message might be a profile answer
  const messageText = message.text?.body;
  if (messageText) {
    await storeAnswer(tenantId, profileQuestion.field, messageText);
    await resetIgnoreCount(tenantId);

    // Send confirmation
    await sendWhatsAppMessage(tenantId, {
      to: message.from,
      type: 'text',
      text: { body: 'תודה! השמרנו את המידע.' }
    });

    return; // Don't process further
  }
}
```

3. Track pending questions:
- When sending profile question, store in Redis with TTL 7 days: `profile:pending:{tenantId}`
- Value: question field name
- Delete on answer received

4. Handle quick_reply button responses:
- Check message.interactive.button_reply.id
- Parse response based on button ID
  </action>
  <verify>npx tsc --noEmit src/queue/workers/whatsapp-message.worker.ts</verify>
  <done>Profile responses detected, stored, confirmed; pending questions tracked in Redis</done>
</task>

</tasks>

<verification>
- [ ] 4 progressive questions defined with Hebrew text
- [ ] Service calculates weeks since setup correctly
- [ ] hasAnswered checks tenant profile fields
- [ ] Ignore count tracking works (stops after 2)
- [ ] Weekly job runs Monday 10:00 AM Israel time
- [ ] Worker sends questions to active tenants only
- [ ] 100ms delay between tenants (rate limiting)
- [ ] Profile responses stored in tenant record
- [ ] Confirmation message sent after answer stored
- [ ] Quick reply buttons work for question 3
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. Active tenant receives first profile question ~1 week after setup
2. Questions sent once per week (max 4 total)
3. System stops asking after 2 consecutive ignored questions
4. Owner responses stored in tenant profile
5. Questions in Hebrew, appropriate for Israeli SMBs
</success_criteria>

<output>
After completion, create `.planning/phases/10-setup-billing/10-05-SUMMARY.md`
</output>
