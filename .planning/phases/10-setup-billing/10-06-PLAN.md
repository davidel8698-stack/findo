---
phase: 10-setup-billing
plan: 06
type: execute
wave: 4
depends_on: ["10-02", "10-03", "10-04", "10-05"]
files_modified:
  - src/routes/pages.ts
  - src/index.ts
  - src/views/setup/index.ts
autonomous: false

must_haves:
  truths:
    - "Setup wizard accessible at /setup"
    - "Billing routes accessible at /billing/*"
    - "Progressive profile worker registered and running"
    - "All Phase 10 routes wired to main app"
    - "User can complete full setup flow end-to-end"
  artifacts:
    - path: "src/routes/pages.ts"
      provides: "Mounts setup and billing routes"
      contains: "setupRoutes"
    - path: "src/index.ts"
      provides: "Registers progressive profile worker"
      contains: "progressiveProfileWorker"
    - path: "src/views/setup/index.ts"
      provides: "Re-exports all setup views"
      exports: ["renderStep1Business", "renderStep2WhatsApp", "renderStep3Google", "renderStep4Telephony", "renderStep5Billing", "renderSetupComplete"]
  key_links:
    - from: "src/routes/pages.ts"
      to: "src/routes/setup/index.ts"
      via: "route mounting"
      pattern: "route.*setup"
    - from: "src/index.ts"
      to: "src/queue/workers/progressive-profile.worker.ts"
      via: "worker import"
      pattern: "progressiveProfileWorker"
---

<objective>
Wire all Phase 10 components into the main application.

Purpose: Connect setup wizard, billing, and progressive profiling to make the full setup flow accessible and operational. This is the final integration step.

Output: Updated pages.ts with routes, index.ts with workers, views index with exports.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Files to integrate
@src/routes/pages.ts
@src/index.ts
@src/routes/setup/index.ts
@src/routes/billing/index.ts
@src/queue/workers/progressive-profile.worker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup views index and update pages routes</name>
  <files>src/views/setup/index.ts, src/routes/pages.ts</files>
  <action>
1. Create src/views/setup/index.ts - Re-export all setup views:

```typescript
// Setup wizard view exports
export { renderSetupLayout } from './layout';
export { renderStep1Business } from './step-1-business';
export { renderStep2WhatsApp } from './step-2-whatsapp';
export { renderStep3Google } from './step-3-google';
export { renderStep4Telephony } from './step-4-telephony';
export { renderStep5Billing } from './step-5-billing';
export { renderSetupComplete } from './complete';
```

2. Update src/routes/pages.ts:

Add imports:
```typescript
import { setupRoutes } from './setup/index';
import { billingRoutes } from './billing/index';
```

Mount routes (after existing routes):
```typescript
// Setup wizard routes
pagesRoutes.route('/setup', setupRoutes);

// Billing routes
pagesRoutes.route('/billing', billingRoutes);
```

Add setup landing redirect for convenience:
```typescript
// Setup landing - redirect to wizard start
pagesRoutes.get('/start', (c) => c.redirect('/setup'));
```
  </action>
  <verify>npx tsc --noEmit src/views/setup/index.ts src/routes/pages.ts</verify>
  <done>Views index exports all setup views, pages.ts mounts setup and billing routes</done>
</task>

<task type="auto">
  <name>Task 2: Register progressive profile worker</name>
  <files>src/index.ts</files>
  <action>
Update src/index.ts to register the progressive profile worker:

1. Add import:
```typescript
import { progressiveProfileWorker } from './queue/workers/progressive-profile.worker';
import { scheduleProgressiveProfilingJob } from './queue/jobs/progressive-profile.job';
```

2. Add to worker registration section (near other workers):
```typescript
// Progressive profiling worker (SETUP-06)
const progressiveProfileWorkerInstance = progressiveProfileWorker;
```

3. Add job scheduling in startup (after other job schedules):
```typescript
// Schedule progressive profiling job
await scheduleProgressiveProfilingJob();
console.log('[startup] Progressive profiling job scheduled');
```

4. Add to graceful shutdown (if applicable):
```typescript
// In shutdown handler
await progressiveProfileWorkerInstance.close();
```

Follow existing worker registration patterns from Phase 11 (metricsCollectionWorker, autoTuningWorker).
  </action>
  <verify>npx tsc --noEmit src/index.ts</verify>
  <done>Progressive profile worker registered, job scheduled, included in graceful shutdown</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 10: Setup & Billing integration</what-built>
  <how-to-verify>
**Full End-to-End Test:**

1. Start dev server: `npm run dev`

2. Navigate to http://localhost:3000/setup

3. **Step 1 - Business Info:**
   - Fill in business name, type, owner name, email
   - Add address and business hours (optional)
   - Click "Continue" - should save and advance

4. **Step 2 - WhatsApp:**
   - Click "Connect WhatsApp" (or skip)
   - Verify Embedded Signup popup (if env vars configured)
   - Or click "Skip" to continue

5. **Step 3 - Google:**
   - Click "Connect Google" (or skip)
   - Verify OAuth redirect (if env vars configured)
   - Or click "Skip" to continue

6. **Step 4 - Telephony:**
   - Select one of three options
   - If transfer/current, enter phone number
   - Click "Continue"

7. **Step 5 - Billing:**
   - See pricing summary (3,500 + 350)
   - Click "Start Trial" (for testing without payment)
   - Or click "Pay" (requires PayPlus env vars)

8. **Complete:**
   - See success page "Findo is working"
   - Click to go to dashboard

**Database Verification:**
- Check tenants table: business info saved
- Check setup_progress: steps tracked
- Check subscriptions: trial or active status

**Worker Verification:**
- Check logs: progressive profiling job scheduled
- Check BullMQ: job exists with correct cron pattern

Report any issues with specific step numbers.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues (e.g., "Step 3 Google button does nothing")</resume-signal>
</task>

</tasks>

<verification>
- [ ] /setup redirects to /setup/step/1
- [ ] All 5 steps render correctly with Hebrew RTL
- [ ] Step navigation works (next/back)
- [ ] Progress saved across page refreshes
- [ ] Skip options work for WhatsApp/Google
- [ ] Trial starts successfully
- [ ] Payment flow initiates (with env vars)
- [ ] Complete page shows success message
- [ ] Dashboard link works
- [ ] Progressive profile worker registered
- [ ] Weekly profiling job scheduled
- [ ] No TypeScript errors
</verification>

<success_criteria>
1. New user can complete setup in under 2 minutes
2. Business info saved correctly
3. WhatsApp/Google can connect or skip
4. Telephony option selected
5. Trial or payment completed
6. "Findo is working" confirmation shown
7. Progressive profiling scheduled for future
</success_criteria>

<output>
After completion, create `.planning/phases/10-setup-billing/10-06-SUMMARY.md`
</output>
