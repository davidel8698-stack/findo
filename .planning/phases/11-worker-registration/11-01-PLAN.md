---
phase: 11-worker-registration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/index.ts]
autonomous: true

must_haves:
  truths:
    - "Review poll worker runs hourly and detects new reviews"
    - "Review reminder worker sends 48h reminders and auto-posts"
    - "Invoice poll worker detects Greeninvoice and iCount invoices hourly"
    - "Review request worker sends WhatsApp review requests"
    - "Metrics collection worker aggregates GBP metrics weekly"
    - "Auto-tuning worker optimizes review timing weekly"
  artifacts:
    - path: "src/index.ts"
      provides: "Worker registration and lifecycle management"
      contains: "startReviewPollWorker"
  key_links:
    - from: "src/index.ts"
      to: "src/queue/workers/review-poll.worker.ts"
      via: "import and start call"
      pattern: "startReviewPollWorker\\(\\)"
    - from: "src/index.ts"
      to: "src/queue/workers/metrics-collection.worker.ts"
      via: "import (auto-starts)"
      pattern: "metricsCollectionWorker"
---

<objective>
Register 6 missing workers in src/index.ts to make Phases 5, 6, and 8 operational.

Purpose: Gap closure from v1-MILESTONE-AUDIT.md - all worker code exists but workers are never started
Output: All 19 workers registered and running (currently 13/19)
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worker imports</name>
  <files>src/index.ts</files>
  <action>
Add 6 import statements after the existing worker imports (after line 28, before initializeScheduler import):

```typescript
import { startReviewPollWorker } from './queue/workers/review-poll.worker';
import { startReviewReminderWorker } from './queue/workers/review-reminder.worker';
import { startInvoicePollWorker } from './queue/workers/invoice-poll.worker';
import { startReviewRequestWorker } from './queue/workers/review-request.worker';
import { metricsCollectionWorker } from './queue/workers/metrics-collection.worker';
import { autoTuningWorker } from './queue/workers/auto-tuning.worker';
```

Note: metricsCollectionWorker and autoTuningWorker use const export pattern (instantiated at import time).
The other 4 use start function pattern (lazy-started).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>All 6 imports present in src/index.ts with no type errors</done>
</task>

<task type="auto">
  <name>Task 2: Add worker tracking variables and start calls</name>
  <files>src/index.ts</files>
  <action>
1. Add 4 worker tracking variables after postApprovalWorker (line 114):

```typescript
let reviewPollWorker: ReturnType<typeof startReviewPollWorker> | null = null;
let reviewReminderWorker: ReturnType<typeof startReviewReminderWorker> | null = null;
let invoicePollWorker: ReturnType<typeof startInvoicePollWorker> | null = null;
let reviewRequestWorker: ReturnType<typeof startReviewRequestWorker> | null = null;
// metricsCollectionWorker and autoTuningWorker start at import time (not lazy-started)
```

2. Add worker start calls in start() function after postApprovalWorker = startPostApprovalWorker() (around line 206):

```typescript
reviewPollWorker = startReviewPollWorker();
reviewReminderWorker = startReviewReminderWorker();
invoicePollWorker = startInvoicePollWorker();
reviewRequestWorker = startReviewRequestWorker();
// metricsCollectionWorker and autoTuningWorker already started at import time
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>4 new workers started in start() function, 2 auto-started at import time</done>
</task>

<task type="auto">
  <name>Task 3: Add shutdown handlers</name>
  <files>src/index.ts</files>
  <action>
Add shutdown handlers in the shutdown() function after postApprovalWorker cleanup (after line 170):

```typescript
if (reviewPollWorker) {
  await reviewPollWorker.close();
  console.log('[server] Review poll worker stopped');
}
if (reviewReminderWorker) {
  await reviewReminderWorker.close();
  console.log('[server] Review reminder worker stopped');
}
if (invoicePollWorker) {
  await invoicePollWorker.close();
  console.log('[server] Invoice poll worker stopped');
}
if (reviewRequestWorker) {
  await reviewRequestWorker.close();
  console.log('[server] Review request worker stopped');
}
await metricsCollectionWorker.close();
console.log('[server] Metrics collection worker stopped');
await autoTuningWorker.close();
console.log('[server] Auto-tuning worker stopped');
```

Place these BEFORE holidayCheckWorker cleanup (keeping logical order: Phase 5 workers, Phase 6 workers, Phase 7 workers, Phase 8 workers).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>All 6 workers have graceful shutdown handlers</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Server starts: `npm run dev` - should see workers starting in console
3. Count total workers: grep for "Worker" in startup output should show 19 workers
4. Verify imports: `grep -c "import.*worker" src/index.ts` should return at least 18 (some workers have multiple imports)
</verification>

<success_criteria>
- All 6 missing worker imports added
- 4 worker tracking variables added
- 4 worker start calls in start() function
- 6 worker shutdown handlers in shutdown() function
- TypeScript compiles without errors
- Server starts and all workers initialize
- Milestone audit gaps closed: 19/19 workers registered
</success_criteria>

<output>
After completion, create `.planning/phases/11-worker-registration/11-01-SUMMARY.md`
</output>
