---
phase: 17-conversion-flow
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - website/app/actions.ts
  - website/components/sections/conversion/LeadCaptureForm.tsx
  - website/components/sections/conversion/FormSuccess.tsx
  - website/components/sections/conversion/PhoneInput.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter name and phone in a 2-field form"
    - "Phone auto-formats as user types (05X-XXX-XXXX)"
    - "Checkmark appears when phone is valid"
    - "Form shows loading state during submission"
    - "Validation errors are warm and helpful"
    - "Success state shows confetti and celebration message"
  artifacts:
    - path: "website/app/actions.ts"
      provides: "Server Action for lead submission"
      exports: ["submitLead"]
    - path: "website/components/sections/conversion/LeadCaptureForm.tsx"
      provides: "2-field lead capture form"
      exports: ["LeadCaptureForm"]
    - path: "website/components/sections/conversion/FormSuccess.tsx"
      provides: "Celebration state with confetti"
      exports: ["FormSuccess"]
    - path: "website/components/sections/conversion/PhoneInput.tsx"
      provides: "Auto-formatting phone input"
      exports: ["PhoneInput"]
  key_links:
    - from: "LeadCaptureForm.tsx"
      to: "app/actions.ts"
      via: "useActionState hook"
      pattern: "useActionState.*submitLead"
    - from: "PhoneInput.tsx"
      to: "lib/validation.ts"
      via: "import"
      pattern: "formatIsraeliPhone|isValidIsraeliPhone"
    - from: "FormSuccess.tsx"
      to: "canvas-confetti"
      via: "import"
      pattern: "import confetti"
---

<objective>
Build the core lead capture form with phone auto-formatting, server action submission, and celebration success state.

Purpose: Create the conversion flow components that transform visitors into leads with minimal friction and delightful feedback.
Output: LeadCaptureForm, PhoneInput, FormSuccess components and submitLead server action.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\דודאלמועלם\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-conversion-flow/17-CONTEXT.md
@.planning/phases/17-conversion-flow/17-RESEARCH.md
@.planning/phases/17-conversion-flow/17-01-SUMMARY.md
@website/lib/validation.ts
@website/components/ui/input.tsx
@website/components/ui/button.tsx
@website/components/molecules/FormField.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action for lead submission</name>
  <files>website/app/actions.ts</files>
  <action>
Create `website/app/actions.ts` with "use server" directive:

1. Define `FormState` interface:
   ```typescript
   interface FormState {
     success: boolean;
     error: string | null;
   }
   ```

2. Export `submitLead` async function:
   - Signature: `(prevState: FormState, formData: FormData) => Promise<FormState>`
   - Extract `name` and `phone` from formData
   - Validate name: minimum 2 characters, return Hebrew error if invalid ("נא להזין שם")
   - Validate phone: use isValidIsraeliPhone from lib/validation.ts, return Hebrew error if invalid ("נא להזין מספר טלפון ישראלי תקין")
   - On success: POST to `process.env.LEAD_WEBHOOK_URL` if defined, otherwise just log
   - Return `{ success: true, error: null }` on success
   - Catch errors and return `{ success: false, error: "משהו השתבש, נסה שוב" }`

Note: The webhook URL is optional - form should work without it for development. Just console.log the lead data if no webhook.
  </action>
  <verify>
File exists with "use server" directive at top.
submitLead is exported.
TypeScript compiles: `cd website && npx tsc --noEmit`
  </verify>
  <done>
Server action validates name and phone, returns FormState with Hebrew error messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PhoneInput component with auto-formatting</name>
  <files>website/components/sections/conversion/PhoneInput.tsx</files>
  <action>
Create directory `website/components/sections/conversion/` if needed.

Create `PhoneInput.tsx` as a client component ("use client"):

1. Props interface:
   ```typescript
   interface PhoneInputProps {
     name: string;
     disabled?: boolean;
     error?: string;
   }
   ```

2. Use useState for `value` (formatted string) and derive `isValid` from isValidIsraeliPhone.

3. On change:
   - Call formatIsraeliPhone on the raw input
   - Update value state
   - Derive validity from formatted value

4. Render:
   - Use existing `Input` component from @/components/ui/input
   - Set `type="tel"` for mobile keyboard
   - Set `dir="ltr"` to prevent RTL number reversal (CRITICAL per RESEARCH.md)
   - Set `placeholder="050-123-4567"`
   - Show green checkmark (Check icon from lucide-react) when valid, positioned absolute at `end-3`
   - Use `text-start` class for alignment

5. If error prop provided, show error message in red below input.

Import Check icon from lucide-react. Use cn() for conditional classes.
  </action>
  <verify>
Component renders without errors.
Typing "0501234567" shows "050-123-4567" with green checkmark.
Partial input like "050123" shows "050-123" without checkmark.
dir="ltr" is present on the input element.
  </verify>
  <done>
PhoneInput auto-formats Israeli numbers and shows validity indicator.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create LeadCaptureForm and FormSuccess components</name>
  <files>
website/components/sections/conversion/LeadCaptureForm.tsx
website/components/sections/conversion/FormSuccess.tsx
  </files>
  <action>
**LeadCaptureForm.tsx** ("use client"):

1. Props: `{ onSuccess: () => void; className?: string }`

2. Use React 19's `useActionState` hook:
   ```typescript
   const [state, formAction, isPending] = useActionState(submitLead, { success: false, error: null });
   ```

3. Use useEffect to call onSuccess when state.success becomes true.

4. Render a form with `action={formAction}`:
   - Name field: Use `Input` component with name="name", required, disabled={isPending}, placeholder="השם שלך"
   - Phone field: Use `PhoneInput` component with name="phone", disabled={isPending}
   - Submit button: Use `Button` with loading={isPending}, full width, text "התחל עכשיו" (or "שולח..." when loading via button's loading state)
   - Show state.error if present (warm message style, not harsh red)
   - Below button: "תוך 2 דקות תהיה מחובר" text (ACTION-03 requirement)

5. Style: Stack fields vertically, gap-4, max-w-sm for contained width.

**FormSuccess.tsx** ("use client"):

1. Props: `{ className?: string; redirectUrl?: string }`

2. Use useEffect on mount to:
   - Fire confetti burst with canvas-confetti:
     ```typescript
     confetti({
       particleCount: 100,
       spread: 70,
       origin: { y: 0.6 },
       colors: ['#f97316', '#22c55e', '#3b82f6'],
       disableForReducedMotion: true,
     });
     ```
   - Set timeout for redirect after 3 seconds (if redirectUrl provided)

3. Render:
   - Green CheckCircle icon (lucide-react), large (h-16 w-16)
   - Headline: "!הצטרפת בהצלחה"
   - Subtext: "מוכן ליותר לקוחות ופחות עבודה"
   - Animate in with Motion (scale + opacity) - use m.div with initial/animate

Import confetti from 'canvas-confetti', CheckCircle from 'lucide-react', m from 'motion/react'.
  </action>
  <verify>
Both components render without errors.
LeadCaptureForm shows loading state when submitting.
FormSuccess triggers confetti on mount (test by temporarily rendering it).
`cd website && npx tsc --noEmit` passes.
  </verify>
  <done>
LeadCaptureForm handles submission with useActionState.
FormSuccess shows celebration with confetti and redirect.
Both use Hebrew copy per requirements.
  </done>
</task>

</tasks>

<verification>
1. `website/app/actions.ts` exists with submitLead server action
2. `website/components/sections/conversion/` contains PhoneInput, LeadCaptureForm, FormSuccess
3. `npx tsc --noEmit` passes
4. PhoneInput formats as user types
5. LeadCaptureForm uses useActionState correctly
6. FormSuccess imports and calls canvas-confetti
</verification>

<success_criteria>
- Server action validates name (2+ chars) and phone (Israeli format)
- PhoneInput auto-formats with checkmark on valid
- LeadCaptureForm shows loading state during submission
- FormSuccess fires confetti with disableForReducedMotion
- All Hebrew copy matches CONTEXT.md decisions
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-conversion-flow/17-02-SUMMARY.md`
</output>
