---
phase: 19-performance-seo-certification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - website/package.json
  - website/next.config.ts
  - website/app/providers.tsx
  - website/lib/posthog/client.ts
  - website/lib/posthog/events.ts
  - website/components/PostHogPageview.tsx
autonomous: true
user_setup:
  - service: posthog
    why: "Analytics, session replay, A/B testing"
    env_vars:
      - name: NEXT_PUBLIC_POSTHOG_KEY
        source: "PostHog Dashboard -> Project Settings -> Project API Key"
    dashboard_config:
      - task: "Create project for Findo website"
        location: "PostHog Dashboard -> New Project"

must_haves:
  truths:
    - "PostHog captures page views on navigation"
    - "PostHog captures custom events (CTA clicks, form submissions)"
    - "Session replay records user sessions"
    - "Analytics work despite ad blockers (reverse proxy)"
  artifacts:
    - path: "website/lib/posthog/client.ts"
      provides: "PostHog client initialization"
      contains: "posthog.init"
    - path: "website/lib/posthog/events.ts"
      provides: "Typed event tracking functions"
      exports: ["trackCtaClick", "trackFormSubmit", "trackDemoView"]
    - path: "website/components/PostHogPageview.tsx"
      provides: "Automatic pageview tracking"
      contains: "usePathname"
    - path: "website/next.config.ts"
      provides: "Reverse proxy rewrite rules"
      contains: "/ingest/:path*"
  key_links:
    - from: "website/app/providers.tsx"
      to: "lib/posthog/client.ts"
      via: "PHProvider import"
      pattern: "PHProvider"
    - from: "website/app/layout.tsx"
      to: "website/components/PostHogPageview.tsx"
      via: "Suspense boundary"
      pattern: "PostHogPageview"
---

<objective>
Set up PostHog analytics with reverse proxy to avoid ad blockers, automatic pageview tracking, and typed event capture for conversion funnel analysis.

Purpose: Enable full behavioral analytics (ANALYTICS-01 through 06) including session replay, funnel tracking, and A/B testing infrastructure.
Output: PostHog provider, pageview tracker, event utilities, and reverse proxy configuration.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-performance-seo-certification/19-RESEARCH.md
@website/app/providers.tsx
@website/app/layout.tsx
@website/next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PostHog packages and configure reverse proxy</name>
  <files>
    website/package.json
    website/next.config.ts
  </files>
  <action>
1. Install PostHog packages:
   ```bash
   cd website && npm install posthog-js posthog-node
   ```

2. Update next.config.ts with reverse proxy rewrite rules:
   ```typescript
   import type { NextConfig } from "next";

   const nextConfig: NextConfig = {
     async rewrites() {
       return [
         {
           source: '/ingest/static/:path*',
           destination: 'https://us-assets.i.posthog.com/static/:path*',
         },
         {
           source: '/ingest/:path*',
           destination: 'https://us.i.posthog.com/:path*',
         },
       ];
     },
     // Skip PostHog requests from middleware
     skipTrailingSlashRedirect: true,
   };

   export default nextConfig;
   ```

The reverse proxy is CRITICAL - it routes PostHog requests through the site domain, preventing ad blockers from blocking 30-40% of sessions.
  </action>
  <verify>
    - `npm ls posthog-js` shows package installed
    - next.config.ts contains rewrites() function with /ingest paths
  </verify>
  <done>PostHog packages installed and reverse proxy configured in next.config.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create PostHog client and provider</name>
  <files>
    website/lib/posthog/client.ts
    website/lib/posthog/events.ts
    website/components/PostHogPageview.tsx
  </files>
  <action>
1. Create lib/posthog/client.ts - PostHog initialization:
   ```typescript
   // PostHog client configuration for Findo website
   // Uses reverse proxy (/ingest) to avoid ad blocker interference

   import posthog from 'posthog-js';

   export function initPostHog() {
     if (typeof window !== 'undefined' && !posthog.__loaded) {
       posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
         api_host: '/ingest',
         ui_host: 'https://us.posthog.com',
         capture_pageview: false, // Manual capture for App Router
         capture_pageleave: true,
         persistence: 'localStorage+cookie',
         // Session replay settings
         disable_session_recording: false,
         session_recording: {
           maskAllInputs: false,
           maskInputOptions: {
             password: true,
           },
         },
         // Feature flags for A/B testing
         bootstrap: {
           featureFlags: {},
         },
       });
     }
     return posthog;
   }
   ```

2. Create lib/posthog/events.ts - Typed event tracking:
   ```typescript
   // Typed event tracking for Findo conversion funnel
   // Event names follow PostHog conventions (snake_case)

   import posthog from 'posthog-js';

   // Funnel step definitions
   export const FUNNEL_STEPS = {
     PAGE_VIEW: '$pageview',
     CTA_CLICK: 'cta_clicked',
     FORM_START: 'form_started',
     FORM_SUBMIT: 'form_submitted',
     DEMO_VIEW: 'demo_viewed',
     DEMO_COMPLETE: 'demo_completed',
   } as const;

   // CTA locations for attribution
   type CtaLocation = 'hero' | 'sticky_bar' | 'after_proof' | 'after_pricing' | 'after_faq' | 'section';

   // Track CTA button clicks
   export function trackCtaClick(location: CtaLocation, buttonText: string) {
     posthog.capture(FUNNEL_STEPS.CTA_CLICK, {
       button_location: location,
       button_text: buttonText,
       $set: { showed_interest: true },
     });
   }

   // Track form interactions
   export function trackFormStart(formType: 'lead_capture' | 'contact', source: string) {
     posthog.capture(FUNNEL_STEPS.FORM_START, {
       form_type: formType,
       source,
     });
   }

   // Track form submissions
   export function trackFormSubmit(formType: 'lead_capture' | 'contact', source: string, success: boolean) {
     posthog.capture(FUNNEL_STEPS.FORM_SUBMIT, {
       form_type: formType,
       source,
       success,
       $set: success ? { converted: true } : {},
     });
   }

   // Track demo views
   export function trackDemoView(demoType: 'video' | 'interactive' | 'lottie') {
     posthog.capture(FUNNEL_STEPS.DEMO_VIEW, {
       demo_type: demoType,
     });
   }

   // Track demo completion
   export function trackDemoComplete(demoType: 'video' | 'interactive' | 'lottie', watchTimeSeconds?: number) {
     posthog.capture(FUNNEL_STEPS.DEMO_COMPLETE, {
       demo_type: demoType,
       watch_time_seconds: watchTimeSeconds,
     });
   }

   // Track section visibility for scroll depth
   export function trackSectionView(sectionName: string) {
     posthog.capture('section_viewed', {
       section_name: sectionName,
     });
   }
   ```

3. Create components/PostHogPageview.tsx - Automatic pageview tracking:
   ```typescript
   'use client';

   import { usePathname, useSearchParams } from 'next/navigation';
   import { useEffect } from 'react';
   import posthog from 'posthog-js';

   /**
    * Track pageviews on route changes in App Router
    * Must be wrapped in Suspense because useSearchParams suspends
    */
   export function PostHogPageview() {
     const pathname = usePathname();
     const searchParams = useSearchParams();

     useEffect(() => {
       if (pathname && posthog) {
         let url = window.origin + pathname;
         if (searchParams.toString()) {
           url = url + '?' + searchParams.toString();
         }
         posthog.capture('$pageview', { $current_url: url });
       }
     }, [pathname, searchParams]);

     return null;
   }
   ```
  </action>
  <verify>
    - lib/posthog/client.ts exists with initPostHog function
    - lib/posthog/events.ts exports all tracking functions
    - components/PostHogPageview.tsx uses usePathname and useSearchParams
  </verify>
  <done>PostHog client, typed events, and pageview tracker created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate PostHog provider and pageview tracker</name>
  <files>
    website/app/providers.tsx
    website/app/layout.tsx
  </files>
  <action>
1. Update app/providers.tsx to include PHProvider:
   ```typescript
   "use client";

   import { DirectionProvider } from "@radix-ui/react-direction";
   import { ThemeProvider } from "@/providers/ThemeProvider";
   import { MotionProvider } from "@/providers/MotionProvider";
   import { SmoothScroll } from "@/components/SmoothScroll";
   import { PostHogProvider } from 'posthog-js/react';
   import { useEffect } from 'react';
   import { initPostHog } from '@/lib/posthog/client';

   export function Providers({ children }: { children: React.ReactNode }) {
     // Initialize PostHog on mount
     useEffect(() => {
       initPostHog();
     }, []);

     // Provider nesting order (CRITICAL for RTL and theming):
     // 1. DirectionProvider - RTL context for Radix components (MUST be outermost)
     // 2. ThemeProvider - Dark/light mode theming with next-themes
     // 3. PostHogProvider - Analytics context
     // 4. MotionProvider - LazyMotion for tree-shaking
     // 5. SmoothScroll - Lenis smooth scroll with GSAP sync (innermost)
     return (
       <DirectionProvider dir="rtl">
         <ThemeProvider>
           <PostHogProvider client={typeof window !== 'undefined' ? (await import('posthog-js')).default : null}>
             <MotionProvider>
               <SmoothScroll>
                 {children}
               </SmoothScroll>
             </MotionProvider>
           </PostHogProvider>
         </ThemeProvider>
       </DirectionProvider>
     );
   }
   ```

   IMPORTANT: The PostHogProvider needs the client to be initialized first. Use a simpler pattern:
   ```typescript
   "use client";

   import { DirectionProvider } from "@radix-ui/react-direction";
   import { ThemeProvider } from "@/providers/ThemeProvider";
   import { MotionProvider } from "@/providers/MotionProvider";
   import { SmoothScroll } from "@/components/SmoothScroll";
   import posthog from 'posthog-js';
   import { PostHogProvider } from 'posthog-js/react';
   import { useEffect, useState } from 'react';

   export function Providers({ children }: { children: React.ReactNode }) {
     const [posthogClient, setPosthogClient] = useState<typeof posthog | null>(null);

     useEffect(() => {
       // Initialize PostHog only on client
       if (typeof window !== 'undefined' && process.env.NEXT_PUBLIC_POSTHOG_KEY) {
         posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY, {
           api_host: '/ingest',
           ui_host: 'https://us.posthog.com',
           capture_pageview: false,
           capture_pageleave: true,
           persistence: 'localStorage+cookie',
         });
         setPosthogClient(posthog);
       }
     }, []);

     // Provider nesting order (CRITICAL for RTL and theming):
     // 1. DirectionProvider - RTL context for Radix components (MUST be outermost)
     // 2. ThemeProvider - Dark/light mode theming with next-themes
     // 3. PostHogProvider - Analytics context (conditional on client init)
     // 4. MotionProvider - LazyMotion for tree-shaking
     // 5. SmoothScroll - Lenis smooth scroll with GSAP sync (innermost)

     const content = (
       <MotionProvider>
         <SmoothScroll>
           {children}
         </SmoothScroll>
       </MotionProvider>
     );

     return (
       <DirectionProvider dir="rtl">
         <ThemeProvider>
           {posthogClient ? (
             <PostHogProvider client={posthogClient}>
               {content}
             </PostHogProvider>
           ) : (
             content
           )}
         </ThemeProvider>
       </DirectionProvider>
     );
   }
   ```

2. Update app/layout.tsx to include PostHogPageview with Suspense:
   ```typescript
   import type { Metadata, Viewport } from "next";
   import { Heebo } from "next/font/google";
   import { Suspense } from "react";
   import { Providers } from "./providers";
   import { PostHogPageview } from "@/components/PostHogPageview";
   import "./globals.css";

   // ... keep existing heebo config, viewport, metadata ...

   export default function RootLayout({
     children,
   }: Readonly<{
     children: React.ReactNode;
   }>) {
     return (
       <html lang="he" dir="rtl" className={heebo.variable} suppressHydrationWarning>
         <body className={`${heebo.className} antialiased`}>
           <Providers>
             <Suspense fallback={null}>
               <PostHogPageview />
             </Suspense>
             {children}
           </Providers>
         </body>
       </html>
     );
   }
   ```

   The Suspense wrapper is REQUIRED because useSearchParams in PostHogPageview suspends during SSR.
  </action>
  <verify>
    - `npm run build` completes without errors
    - providers.tsx includes PostHogProvider
    - layout.tsx includes PostHogPageview wrapped in Suspense
  </verify>
  <done>PostHog provider and pageview tracker integrated into app</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. PostHog initialized: Dev tools Network tab shows requests to /ingest path
3. Pageviews captured: PostHog dashboard shows page_view events (requires env var)
4. Reverse proxy works: Requests go to findo.co.il/ingest, not posthog.com
</verification>

<success_criteria>
- posthog-js and posthog-node packages installed
- Reverse proxy configured in next.config.ts
- PostHog provider wraps app in providers.tsx
- Pageview tracking active via PostHogPageview component
- Event tracking utilities exported from lib/posthog/events.ts
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-seo-certification/19-01-SUMMARY.md`
</output>
