---
phase: 24-micro-interactions
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - website/components/sections/conversion/LeadCaptureForm.tsx
  - website/components/sections/conversion/PhoneInput.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Input error prop shows destructive border and glow on validation error"
    - "Form fields shake when validation fails on submit"
    - "Error shake animation is gentle (1-2 cycles) not jarring"
    - "Error state clears when user starts typing or focuses field"
  artifacts:
    - path: "website/components/sections/conversion/LeadCaptureForm.tsx"
      provides: "Error state integration with Input and useShake"
      contains: "useShake"
    - path: "website/components/sections/conversion/PhoneInput.tsx"
      provides: "PhoneInput with onFocus callback for error clearing"
      contains: "onFocus"
  key_links:
    - from: "website/components/sections/conversion/LeadCaptureForm.tsx"
      to: "website/lib/hooks/useShake.ts"
      via: "import useShake"
      pattern: "import.*useShake.*from"
    - from: "website/components/sections/conversion/LeadCaptureForm.tsx"
      to: "website/components/ui/input.tsx"
      via: "error prop"
      pattern: "error=\\{.*\\}"
    - from: "website/components/sections/conversion/LeadCaptureForm.tsx"
      to: "website/components/sections/conversion/PhoneInput.tsx"
      via: "onFocus prop"
      pattern: "onFocus=\\{.*\\}"
---

<objective>
Wire form error states with Input error prop and useShake hook.

Purpose: Phase 24 built error handling components but never integrated them. This plan wires error states to show destructive styling + shake animation on validation failure.

Output: LeadCaptureForm shows error shake and red glow when submission fails.
</objective>

<execution_context>
@C:\Users\דודאלמועלם\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\דודאלמועלם\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-micro-interactions/24-VERIFICATION.md
@.planning/phases/24-micro-interactions/24-02-SUMMARY.md
@website/components/ui/input.tsx
@website/lib/hooks/useShake.ts
@website/components/sections/conversion/LeadCaptureForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onFocus prop to PhoneInput component</name>
  <files>website/components/sections/conversion/PhoneInput.tsx</files>
  <action>
    PhoneInput has internal onChange handler (lines 33-37) that manages its own state.
    To enable error clearing, we need to expose an onFocus callback.

    1. Add onFocus to interface (line 12-16):
       ```tsx
       interface PhoneInputProps {
         name: string;
         disabled?: boolean;
         error?: string;
         onFocus?: () => void;  // ADD THIS
       }
       ```

    2. Destructure onFocus in component (line 27):
       ```tsx
       export function PhoneInput({ name, disabled, error, onFocus }: PhoneInputProps) {
       ```

    3. Pass onFocus to inner Input (around line 41-53):
       ```tsx
       <Input
         type="tel"
         name={name}
         value={value}
         onChange={handleChange}
         onFocus={onFocus}  // ADD THIS
         disabled={disabled}
         dir="ltr"
         ...
       />
       ```

    This allows LeadCaptureForm to clear error state when user focuses the phone field.
  </action>
  <verify>
    - `grep "onFocus" website/components/sections/conversion/PhoneInput.tsx` shows prop and usage
    - `npx tsc --noEmit` passes
  </verify>
  <done>PhoneInput exposes onFocus callback for parent to clear errors</done>
</task>

<task type="auto">
  <name>Task 2: Wire useShake hook and error state to LeadCaptureForm</name>
  <files>website/components/sections/conversion/LeadCaptureForm.tsx</files>
  <action>
    Integrate error state handling into LeadCaptureForm:

    1. Import useShake hook:
       ```tsx
       import { useShake } from "@/lib/hooks/useShake";
       ```

    2. Create refs for both inputs using useShake:
       ```tsx
       const { ref: nameRef, triggerShake: shakeName, clearError: clearNameError } = useShake<HTMLInputElement>();
       const { ref: phoneRef, triggerShake: shakePhone, clearError: clearPhoneError } = useShake<HTMLDivElement>();
       ```
       Note: phoneRef is HTMLDivElement because we wrap PhoneInput in a div.

    3. Add error state tracking:
       ```tsx
       const [fieldErrors, setFieldErrors] = useState<{ name?: boolean; phone?: boolean }>({});
       ```

    4. Add useEffect to handle errors and trigger shakes:
       ```tsx
       useEffect(() => {
         if (state.error) {
           // Server returned error - shake both fields with gentle animation
           setFieldErrors({ name: true, phone: true });
           shakeName("gentle");
           shakePhone("gentle");
         }
       }, [state.error, shakeName, shakePhone]);
       ```

    5. Wire error prop and onChange to Input (name field, around line 65-73):
       ```tsx
       <Input
         ref={nameRef}
         name="name"
         error={fieldErrors.name}
         onChange={() => {
           setFieldErrors(prev => ({ ...prev, name: false }));
           clearNameError();
         }}
         // ...rest of existing props
       />
       ```

    6. Wire PhoneInput with div wrapper for shake + onFocus for error clearing (line 77):
       ```tsx
       <div ref={phoneRef}>
         <PhoneInput
           name="phone"
           disabled={isPending}
           error={fieldErrors.phone ? " " : undefined}
           onFocus={() => {
             setFieldErrors(prev => ({ ...prev, phone: false }));
             clearPhoneError();
           }}
         />
       </div>
       ```

       The onFocus callback clears the error when user focuses the phone field.
       PhoneInput now exposes onFocus (from Task 1) which passes it to inner Input.

    Note: Use "gentle" severity (pulse animation) per CONTEXT.md for form validation errors.
  </action>
  <verify>
    - `grep "useShake" website/components/sections/conversion/LeadCaptureForm.tsx` shows import and usage
    - `grep "error=" website/components/sections/conversion/LeadCaptureForm.tsx` shows error prop usage
    - `grep "onFocus" website/components/sections/conversion/LeadCaptureForm.tsx` shows onFocus on PhoneInput
    - `npx tsc --noEmit` passes
    - Dev server: Submit form with invalid data shows:
      - Red border on inputs (destructive styling)
      - Gentle pulse/shake animation
      - Error clears when user focuses OR types in field
  </verify>
  <done>LeadCaptureForm shows error shake and destructive styling, error clears on user interaction</done>
</task>

</tasks>

<verification>
1. **TypeScript**: `npx tsc --noEmit` passes
2. **Visual testing** (dev server):
   - Submit form with empty fields
   - Observe: red borders, shake animation, error message
   - Focus or type in name field -> name error clears
   - Focus or type in phone field -> phone error clears (onFocus callback works)
3. **Animation timing**: shake feels "gentle" not jarring (1-2 pulse cycles)
4. **Accessibility**: inputs have aria-invalid="true" when error
</verification>

<success_criteria>
- PhoneInput exposes onFocus prop (new in Task 1)
- useShake hook imported and wired to form inputs
- Input error prop passed based on validation state
- PhoneInput error prop passed (with boolean-to-string conversion)
- PhoneInput onFocus clears phone error state (fixes div wrapper issue)
- Gentle shake animation triggers on form error
- Error state clears when user focuses OR types in field
</success_criteria>

<output>
After completion, create `.planning/phases/24-micro-interactions/24-05-SUMMARY.md`
</output>
